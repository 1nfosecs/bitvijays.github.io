

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-92365403-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <title>Configuring and Securing Series : Windows Environment &#8212; tech.bitvijays.com</title>
    <link rel="stylesheet" href="_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/bizstyle.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="index.html">tech.bitvijays.com</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Configuring and Securing Series : Windows Environment</a><ul>
<li><a class="reference internal" href="#creating-a-domain-controller">Creating a Domain Controller</a><ul>
<li><a class="reference internal" href="#renaming-the-computer">Renaming the Computer</a></li>
<li><a class="reference internal" href="#setting-up-the-static-ip">Setting up the Static IP</a><ul>
<li><a class="reference internal" href="#figure-out-the-network-adapters">Figure out the network adapters</a></li>
<li><a class="reference internal" href="#setting-the-ip-address">Setting the IP Address</a></li>
<li><a class="reference internal" href="#updating-the-dns-server">Updating the DNS Server</a></li>
</ul>
</li>
<li><a class="reference internal" href="#installing-the-domain-services">Installing the Domain Services</a><ul>
<li><a class="reference internal" href="#install-ad-domain-services">Install AD-Domain-Services</a></li>
<li><a class="reference internal" href="#install-adds-forest">Install ADDS-Forest</a></li>
<li><a class="reference internal" href="#validate-the-domain-controller">Validate the Domain Controller</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#user-creation">User Creation</a><ul>
<li><a class="reference internal" href="#new-aduser">New-ADUser</a><ul>
<li><a class="reference internal" href="#new-aduser-with-password">New-ADUser with Password</a></li>
<li><a class="reference internal" href="#random-password-creation">Random Password Creation</a></li>
<li><a class="reference internal" href="#new-aduser-creation-with-csv">New-ADUser creation with CSV</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#adding-computer-to-domain">Adding Computer to Domain</a><ul>
<li><a class="reference internal" href="#ad-computer">AD-Computer</a></li>
<li><a class="reference internal" href="#add-a-local-computer-to-the-domain">Add a local computer to the domain</a></li>
<li><a class="reference internal" href="#add-a-remote-computer-to-the-domain">Add a remote computer to the domain</a></li>
</ul>
</li>
<li><a class="reference internal" href="#moving-computer-to-ous">Moving Computer to OUs</a><ul>
<li><a class="reference internal" href="#creating-a-new-ou">Creating a New OU</a></li>
<li><a class="reference internal" href="#figuring-out-different-os-in-domain">Figuring out different OS in Domain</a></li>
<li><a class="reference internal" href="#moving-adcomputer-object-to-a-specific-ou">Moving ADComputer Object to a specific OU</a></li>
</ul>
</li>
<li><a class="reference internal" href="#windows-security-hardening">Windows Security Hardening</a><ul>
<li><a class="reference internal" href="#security-compliance-manager">Security Compliance Manager</a></li>
<li><a class="reference internal" href="#extra-hardening">Extra Hardening</a><ul>
<li><a class="reference internal" href="#custom-settings">Custom Settings</a></li>
<li><a class="reference internal" href="#disable-net-session-enumeration-netcease">Disable Net Session Enumeration ( NetCease )</a></li>
<li><a class="reference internal" href="#local-administrator-password-solution-laps">Local Administrator Password Solution LAPS</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/LFL-CFG-SEC-Windows.rst.txt"
           rel="nofollow">Show Source</a></li>
    <li><a href="https://github.com/bitvijays/bitvijays.github.io-sphinx/blob/master/docs/LFL-CFG-SEC-Windows.rst"
           rel="nofollow">Show on GitHub</a></li>
    <li><a href="https://github.com/bitvijays/bitvijays.github.io-sphinx/edit/master/docs/LFL-CFG-SEC-Windows.rst"
           rel="nofollow">Edit on GitHub</a></li>
  </ul>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="configuring-and-securing-series-windows-environment">
<h1>Configuring and Securing Series : Windows Environment<a class="headerlink" href="#configuring-and-securing-series-windows-environment" title="Permalink to this headline">¶</a></h1>
<p>Welcome to the Configuring and Securing Series - Windows environment. Here we would cover how to configure Windows Domain Controller, add users , how to secure a windows environment etc. We would try to cover most of the stuff using powershell and commandline.</p>
<div class="section" id="creating-a-domain-controller">
<h2>Creating a Domain Controller<a class="headerlink" href="#creating-a-domain-controller" title="Permalink to this headline">¶</a></h2>
<p>Chad Cox and Harry Eagles has already provided steps <a class="reference external" href="https://blogs.technet.microsoft.com/chadcox/2016/10/25/chads-quick-notes-installing-a-domain-controller-with-server-2016-core/">Chad’s Quick Notes – Installing a Domain Controller with Server 2016 Core</a> and <a class="reference external" href="https://blogs.technet.microsoft.com/uktechnet/2016/06/08/setting-up-active-directory-via-powershell/">Setting up Active Directory via PowerShell</a></p>
<div class="section" id="renaming-the-computer">
<h3>Renaming the Computer<a class="headerlink" href="#renaming-the-computer" title="Permalink to this headline">¶</a></h3>
<p>Probably, we want to rename the existing computername to something more sensible or as per the naming convention</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>hostname
WIN-N2P19KAHMFG

Rename-Computer -NewName MUMDC01
^ This would rename the computer from WIN-N2P19KAHMFG to MUMDC01
</pre></div>
</div>
</div>
<div class="section" id="setting-up-the-static-ip">
<h3>Setting up the Static IP<a class="headerlink" href="#setting-up-the-static-ip" title="Permalink to this headline">¶</a></h3>
<div class="section" id="figure-out-the-network-adapters">
<h4>Figure out the network adapters<a class="headerlink" href="#figure-out-the-network-adapters" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>PS C:\Windows\system32&gt; Get-NetAdapter

Name                      InterfaceDescription                    ifIndex Status       MacAddress             LinkSpeed
----                      --------------------                    ------- ------       ----------             ---------
VBoxHost                  Intel(R) PRO/1000 MT Desktop Adapter #2      13 Up           08-00-27-F3-8B-23         1 Gbps
Ethernet                  Intel(R) PRO/1000 MT Desktop Adapter         12 Up           08-00-27-7C-9A-4E         1 Gbps
</pre></div>
</div>
</div>
<div class="section" id="setting-the-ip-address">
<h4>Setting the IP Address<a class="headerlink" href="#setting-the-ip-address" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>$ipaddress = &quot;192.168.56.4&quot;   # Your DC IP Address according to your IP Address range
New-NetIPAddress -InterfaceAlias Ethernet -IPAddress $ipaddress -AddressFamily IPv4 -PrefixLength 24

IPAddress         : 192.168.56.4
InterfaceIndex    : 12
InterfaceAlias    : Ethernet
AddressFamily     : IPv4
Type              : Unicast
PrefixLength      : 24
PrefixOrigin      : Manual
SuffixOrigin      : Manual
AddressState      : Tentative
ValidLifetime     : Infinite ([TimeSpan]::MaxValue)
PreferredLifetime : Infinite ([TimeSpan]::MaxValue)
SkipAsSource      : False
PolicyStore       : ActiveStore

IPAddress         : 192.168.56.4
InterfaceIndex    : 12
InterfaceAlias    : Ethernet
AddressFamily     : IPv4
Type              : Unicast
PrefixLength      : 24
PrefixOrigin      : Manual
SuffixOrigin      : Manual
AddressState      : Invalid
ValidLifetime     : Infinite ([TimeSpan]::MaxValue)
PreferredLifetime : Infinite ([TimeSpan]::MaxValue)
SkipAsSource      : False
PolicyStore       : PersistentStore
</pre></div>
</div>
</div>
<div class="section" id="updating-the-dns-server">
<h4>Updating the DNS Server<a class="headerlink" href="#updating-the-dns-server" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>$dnsaddress = &quot;127.0.0.1&quot;
Set-DnsClientServerAddress -InterfaceAlias VBoxHost -ServerAddresses $dnsaddress -Validate
</pre></div>
</div>
</div>
</div>
<div class="section" id="installing-the-domain-services">
<h3>Installing the Domain Services<a class="headerlink" href="#installing-the-domain-services" title="Permalink to this headline">¶</a></h3>
<div class="section" id="install-ad-domain-services">
<h4>Install AD-Domain-Services<a class="headerlink" href="#install-ad-domain-services" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>Install-WindowsFeature AD-Domain-Services -IncludeManagementTools
</pre></div>
</div>
</div>
<div class="section" id="install-adds-forest">
<h4>Install ADDS-Forest<a class="headerlink" href="#install-adds-forest" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>Install-ADDSForest -DomainName bitvijays.local
</pre></div>
</div>
</div>
<div class="section" id="validate-the-domain-controller">
<h4>Validate the Domain Controller<a class="headerlink" href="#validate-the-domain-controller" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>AD/ DNS services are running</li>
</ul>
<blockquote>
<div><div class="highlight-None notranslate"><div class="highlight"><pre><span></span>Get-Service adws, kdc, netlogon, dns

Status   Name               DisplayName
------   ----               -----------
Running  adws               Active Directory Web Services
Running  dns                DNS Server
Running  kdc                Kerberos Key Distribution Center
Running  Netlogon           netlogon
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>SYSVOL and NetLogon shares</li>
</ul>
<blockquote>
<div><div class="highlight-None notranslate"><div class="highlight"><pre><span></span>Get-SmbShare

Name     ScopeName Path                                           Description
----     --------- ----                                           -----------
ADMIN$   *         C:\Windows                                     Remote Admin
C$       *         C:\                                            Default share
IPC$     *                                                        Remote IPC
NETLOGON *         C:\Windows\SYSVOL\sysvol\bitvijays.com\SCRIPTS Logon server share
SYSVOL   *         C:\Windows\SYSVOL\sysvol                       Logon server share
</pre></div>
</div>
</div></blockquote>
</div>
</div>
</div>
<div class="section" id="user-creation">
<h2>User Creation<a class="headerlink" href="#user-creation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="new-aduser">
<h3>New-ADUser<a class="headerlink" href="#new-aduser" title="Permalink to this headline">¶</a></h3>
<p>Detailed information could be found at <a class="reference external" href="https://technet.microsoft.com/en-us/library/ee617253.aspx">Technet New-ADUser</a></p>
<p>New-ADUser creates a new Active Directory user.</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>New-ADUser -Name &quot;John Smith&quot; -SamAccountName john.smith -GivenName John -Surname Smith
</pre></div>
</div>
<p>The above would create a user with the above details. However, the account would disabled as no password is specified.</p>
<div class="section" id="new-aduser-with-password">
<h4>New-ADUser with Password<a class="headerlink" href="#new-aduser-with-password" title="Permalink to this headline">¶</a></h4>
<p>The following example shows one method to set this parameter. This command will prompt you to enter the password.</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>-AccountPassword (Read-Host -AsSecureString &quot;AccountPassword&quot;)
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>New-ADUser -Name &quot;John Smith&quot; -SamAccountName john.smith -GivenName John -Surname Smith -AccountPassword (Read-Host -AsSecureString &quot;AccountPassword&quot;)
</pre></div>
</div>
<p>To enable the account, we do have use the switch -Enabled $true</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>New-ADUser -Name &quot;John Smith&quot; -SamAccountName john.smith -GivenName John -Surname Smith -AccountPassword (Read-Host -AsSecureString &quot;AccountPassword&quot;) -Enabled True
</pre></div>
</div>
</div>
<div class="section" id="random-password-creation">
<h4>Random Password Creation<a class="headerlink" href="#random-password-creation" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Powershell Way: Simon Wahlin has created powershell script <a class="reference external" href="https://gallery.technet.microsoft.com/scriptcenter/Generate-a-random-and-5c879ed5">New-SWRandomPassword.ps1</a> to generate a number of random passwords that will be complex enough for Active Directory. Passwords will contain chars from all strings in InputStrings.</li>
<li>Microsoft Excel Way: To create a password with 9 characters ( some numbers and special characters with 4 digit number ). In the formula tab, write</li>
</ul>
<blockquote>
<div><div class="highlight-None notranslate"><div class="highlight"><pre><span></span>=CHAR(RANDBETWEEN(65,90))&amp;CHAR(RANDBETWEEN(97,122))&amp;CHAR(RANDBETWEEN(97,122))&amp;CHAR(RANDBETWEEN(65,90))&amp;RANDBETWEEN(1000,9999)&amp;CHAR(RANDBETWEEN(42,43))
</pre></div>
</div>
<p>we can repeat this to create more complex password.</p>
</div></blockquote>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">As we are using RANDBETWEEN function in MS Excel, password generated will change almost everytime focus is changed. To resolve this, it is suggested to copy the passwords by Value.</p>
</div>
</div>
<div class="section" id="new-aduser-creation-with-csv">
<h4>New-ADUser creation with CSV<a class="headerlink" href="#new-aduser-creation-with-csv" title="Permalink to this headline">¶</a></h4>
<p>We also can create multiple users at once using CSV option. For example, let’s say CSV is</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>GivenName,Surname,Name,StreetAddress,City,Title,EmailAddress,Username,RPassword,Country,TelephoneNumber,Password
Jane,Green,Jane Green,Libellengasse 60,SASSL,Ms.,Jane.Green@bitvijays.local,Jane.Green,OdlL6837*ai,AT,0650 130 26 58,TyzM9015+dp
John,Hudson,John Hudson,Landstrasse 36,ETZELSDORF,Mr.,John.Hudson@bitvijays.local,John.Hudson,TbfY6122*ei,AT,0664 366 58 55,TtqF5989+wk
</pre></div>
</div>
<p>When we import this CSV using powershell</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>Import-CSV ..\ADUsers.csv

GivenName       : Cory
Surname         : Nava
Name            : Cory Nava
StreetAddress   : Hauptstrasse 65
City            : PRUTZ
Title           : Dr.
EmailAddress    : Cory.Nava@bitvijays.local
Username        : Cory.Nava
RPassword       : DfnV5074+hy
Country         : AT
TelephoneNumber : 0699 989 75 38
Password        : JskE4317*of
</pre></div>
</div>
<p>We can create multiple users by passing these parameter to the New-ADUser function by</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>Import-Csv ..\..\Users\Administrator\Desktop\ADUsers.csv | % { New-ADUser -GivenName  $_.GivenName -Surname $_.Surname -Name $_.Name -SamAccountName $_.Username -Title $_.title -AccountPassword (ConvertTo-SecureString -Force -AsPlainText $_.Password) -Enabled $true }
</pre></div>
</div>
<p>For lab purposes, Carlos Perez has written a blog on <a class="reference external" href="https://www.darkoperator.com/blog/2016/7/30/creating-real-looking-user-accounts-in-ad-lab">Creating Real Looking User Accounts in AD Lab</a></p>
<div class="admonition tip">
<p class="first admonition-title">Tip</p>
<p class="last">While creating user, we can also specify the computers that the user can access by using LogonWorkstations property. To specify more than one computer, create a single comma-separated list. We can identify a computer by using the Security Accounts Manager (SAM) account name (sAMAccountName) or the DNS host name of the computer. The SAM account name is the same as the NetBIOS name of the computer. In my opinion, this could probably help in stoping later movement</p>
</div>
</div>
</div>
</div>
<div class="section" id="adding-computer-to-domain">
<h2>Adding Computer to Domain<a class="headerlink" href="#adding-computer-to-domain" title="Permalink to this headline">¶</a></h2>
<div class="section" id="ad-computer">
<h3>AD-Computer<a class="headerlink" href="#ad-computer" title="Permalink to this headline">¶</a></h3>
<p>Microsoft documentation has provided a good documentation <a class="reference external" href="https://docs.microsoft.com/en-gb/powershell/module/Microsoft.PowerShell.Management/Add-Computer">Add-Computer</a></p>
<p>Add the local computer to a domain or workgroup.</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>Add-Computer
   [-DomainName] &lt;String&gt;                      : Specifies the domain to which the computers are added. This parameter is required when adding the computers to a domain.
   [-WorkgroupName &lt;String&gt;]                   : Specifies the name of a workgroup to which the computers are added. The default value is &quot;WORKGROUP&quot;.
   [-ComputerName &lt;String[]&gt;]                  : Specifies the computers to add to a domain or workgroup. The default is the local computer.
   -Credential &lt;PSCredential&gt;                  : Specifies a user account that has permission to join the computers to a new domain.
   [-LocalCredential &lt;PSCredential&gt;]           : Specifies a user account that has permission to connect to the computers that are specified by the ComputerName parameter. The default is the current user.
   [-NewName &lt;String&gt;]                         : Specifies a new name for the computer in the new domain. This parameter is valid only when one computer is being added or moved.
   -OUPath &lt;String&gt;]                           : Specifies an organizational unit (OU) for the domain account. Enter the full distinguished name of the OU in quotation marks. The default value is the default OU for machine objects in the domain.
   [-Restart]                                  : Indicates that this cmdlet restarts the computers that were added to the domain or workgroup. A restart is often required to make the change effective.
   [-Server &lt;String&gt;]                          : Specifies the name of a domain controller that adds the computer to the domain. Enter the name in DomainName\ComputerName format. By default, no domain controller is specified.
   [-UnjoinDomainCredential &lt;PSCredential&gt;]    : Specifies a user account that has permission to remove the computers from their current domains. The default is the current user.
   [-Unsecure]                                 : Indicates that this cmdlet performs an unsecured join to the specified domain.
   [-WhatIf]
   [&lt;CommonParameters&gt;]
</pre></div>
</div>
</div>
<div class="section" id="add-a-local-computer-to-the-domain">
<h3>Add a local computer to the domain<a class="headerlink" href="#add-a-local-computer-to-the-domain" title="Permalink to this headline">¶</a></h3>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>Add-Computer -Domain &quot;Domain02&quot; -NewName &quot;Server044&quot; -Credential Domain02\Admin01 -Restart
</pre></div>
</div>
</div>
<div class="section" id="add-a-remote-computer-to-the-domain">
<h3>Add a remote computer to the domain<a class="headerlink" href="#add-a-remote-computer-to-the-domain" title="Permalink to this headline">¶</a></h3>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>Add-Computer -ComputerName &quot;Server01&quot; -Domain &quot;Domain02&quot; -LocalCredential User01 -Credential Domain02\Admin01 -Restart
</pre></div>
</div>
<p>For moving a remote computer, probably, WMI or WinRM should be enabled.</p>
<p>By default, any authenticated user can add a computer in a domain. However, probably, this is discouraged and only one user/ group should be allowed to add computer to Domain. More details at <a class="reference external" href="https://blogs.technet.microsoft.com/dubaisec/2016/02/01/who-can-add-workstation-to-the-domain/">Who can add workstation to the domain</a></p>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">Need to figure out a powershell way to delegate the “Add computer to domain” to a specific user/ group.</p>
</div>
</div>
</div>
<div class="section" id="moving-computer-to-ous">
<h2>Moving Computer to OUs<a class="headerlink" href="#moving-computer-to-ous" title="Permalink to this headline">¶</a></h2>
<p>As the security baselines are Operating System specifics, We would probably want to move the computers joined to a specific OU, so that we can apply the security baseline.</p>
<div class="section" id="creating-a-new-ou">
<h3>Creating a New OU<a class="headerlink" href="#creating-a-new-ou" title="Permalink to this headline">¶</a></h3>
<p>Let’s first create few OU ( Organizational Unit ). In the below example we are creating a OU named Security_Baseline which will contain two or more sub-OUs. Let’s say for Windows 7, Windows 10 or Windows Server.</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>New-ADOrganizationalUnit -Name &quot;Security_Baseline&quot; -Description &quot;Security Baseline&quot; -Path &quot;DC=bitvijays,DC=com&quot;
New-ADOrganizationalUnit -Name &quot;Windows7&quot; -Description &quot;Windows 7 Machine Security Baseline&quot; -Path &quot;OU=Security_Baseline,DC=bitvijays,DC=com&quot;
New-ADOrganizationalUnit -Name &quot;Windows10&quot; -Description &quot;Windows 10 Machine Security Baseline&quot; -Path &quot;OU=Security_Baseline,DC=bitvijays,DC=com&quot;
</pre></div>
</div>
<p>Let’s figure out what are the different OUs in our domain</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>PS C:\Windows\system32&gt; Get-ADOrganizationalUnit -Filter * | FT Name, DistinguishedName

Name               DistinguishedName
----               -----------------
Domain Controllers OU=Domain Controllers,DC=bitvijays,DC=com
Workstations       OU=Workstations,DC=bitvijays,DC=com
Security_Baseline  OU=Security_Baseline,DC=bitvijays,DC=com
Windows7           OU=Windows7,OU=Security_Baseline,DC=bitvijays,DC=com
Windows10          OU=Windows10,OU=Security_Baseline,DC=bitvijays,DC=com
</pre></div>
</div>
<p>If we just wanna see Windows7 one, we can do</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>Get-ADOrganizationalUnit -LDAPFilter &quot;(name=Windows7)&quot; | FT Name, DistinguishedName

Name     DistinguishedName
----     -----------------
Windows7 OU=Windows7,OU=Security_Baseline,DC=bitvijays,DC=com
</pre></div>
</div>
</div>
<div class="section" id="figuring-out-different-os-in-domain">
<h3>Figuring out different OS in Domain<a class="headerlink" href="#figuring-out-different-os-in-domain" title="Permalink to this headline">¶</a></h3>
<p>We would require ActiveDirectory Module for this.</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>Import-Module ActiveDirectory
</pre></div>
</div>
<p>Microsoft has provided a technet article on <a class="reference external" href="https://technet.microsoft.com/en-us/itpro/powershell/windows/addsadministration/get-adcomputer">Get-ADComputer</a> The Get-ADComputer cmdlet gets a computer or performs a search to retrieve multiple computers.</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>Get-ADComputer -Filter * -Property *

AccountExpirationDate                :
accountExpires                       : 9223372036854775807
AccountLockoutTime                   :
AccountNotDelegated                  : False
AllowReversiblePasswordEncryption    : False
AuthenticationPolicy                 : {}
AuthenticationPolicySilo             : {}
BadLogonCount                        : 0
badPasswordTime                      : 0
badPwdCount                          : 0
CannotChangePassword                 : False
CanonicalName                        : bitvijays.com/Workstations/IE10WIN72
Certificates                         : {}
CN                                   : IE10WIN72
codePage                             : 0
CompoundIdentitySupported            : {False}
countryCode                          : 0
Created                              : 5/9/2017 4:34:31 AM
createTimeStamp                      : 5/9/2017 4:34:31 AM
Deleted                              :
Description                          :
DisplayName                          : IE10WIN72$
DistinguishedName                    : CN=IE10WIN72,OU=Workstations,DC=bitvijays,DC=com
DNSHostName                          : IE10WIN72.bitvijays.com
DoesNotRequirePreAuth                : False
dSCorePropagationData                : {8/14/2017 8:19:24 AM, 8/14/2017 8:18:23 AM, 8/14/2017 1:13:21 AM, 5/9/2017 1:55:10 PM...}
Enabled                              : True
HomedirRequired                      : False
HomePage                             :
instanceType                         : 4
IPv4Address                          :
IPv6Address                          :
isCriticalSystemObject               : False
isDeleted                            :
KerberosEncryptionType               : {RC4, AES128, AES256}
LastBadPasswordAttempt               :
LastKnownParent                      :
lastLogoff                           : 0
lastLogon                            : 131471983161372555
LastLogonDate                        : 8/8/2017 6:00:28 PM
lastLogonTimestamp                   : 131467140289373056
localPolicyFlags                     : 0
Location                             :
LockedOut                            : False
logonCount                           : 47
ManagedBy                            :
MemberOf                             : {}
MNSLogonAccount                      : False
Modified                             : 8/14/2017 8:19:24 AM
modifyTimeStamp                      : 8/14/2017 8:19:24 AM
mS-DS-CreatorSID                     : S-1-5-21-1727263102-1930659670-937436522-1106
ms-Mcs-AdmPwd                        : %!2]78.j7n+c3E
ms-Mcs-AdmPwdExpirationTime          : 131493063003466404
msDS-SupportedEncryptionTypes        : 28
msDS-User-Account-Control-Computed   : 0
Name                                 : IE10WIN72
nTSecurityDescriptor                 : System.DirectoryServices.ActiveDirectorySecurity
ObjectCategory                       : CN=Computer,CN=Schema,CN=Configuration,DC=bitvijays,DC=com
ObjectClass                          : computer
ObjectGUID                           : 1cc964d9-3164-4780-bc0a-1149049d6df9
ObjectSid                            : S-1-5-21-1727263102-1930659670-937436522-1107
OperatingSystem                      : Windows 7 Enterprise
OperatingSystemHotfix                :
OperatingSystemServicePack           : Service Pack 1
OperatingSystemVersion               : 6.1 (7601)
PasswordExpired                      : False
PasswordLastSet                      : 8/14/2017 2:14:29 AM
PasswordNeverExpires                 : False
PasswordNotRequired                  : False
PrimaryGroup                         : CN=Domain Computers,CN=Users,DC=bitvijays,DC=com
primaryGroupID                       : 515
PrincipalsAllowedToDelegateToAccount : {}
ProtectedFromAccidentalDeletion      : False
pwdLastSet                           : 131471756690576604
SamAccountName                       : IE10WIN72$
sAMAccountType                       : 805306369
sDRightsEffective                    : 15
ServiceAccount                       : {}
servicePrincipalName                 : {TERMSRV/IE10WIN72.bitvijays.com, RestrictedKrbHost/IE10WIN72.bitvijays.com, HOST/IE10WIN72.bitvijays.com, TERMSRV/IE10WIN72...}
ServicePrincipalNames                : {TERMSRV/IE10WIN72.bitvijays.com, RestrictedKrbHost/IE10WIN72.bitvijays.com, HOST/IE10WIN72.bitvijays.com, TERMSRV/IE10WIN72...}
SID                                  : S-1-5-21-1727263102-1930659670-937436522-1107
SIDHistory                           : {}
TrustedForDelegation                 : False
TrustedToAuthForDelegation           : False
UseDESKeyOnly                        : False
userAccountControl                   : 4096
userCertificate                      : {}
UserPrincipalName                    :
uSNChanged                           : 86161
uSNCreated                           : 24601
whenChanged                          : 8/14/2017 8:19:24 AM
whenCreated                          : 5/9/2017 4:34:31 AM
</pre></div>
</div>
<p>Let’s say we just want to see Name and OperatingSystem, we can do</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>Get-ADComputer -Filter * -Property * | Format-Table Name, OperatingSystem, OperatingSystemVersion

Name            OperatingSystem                            OperatingSystemVersion
----            ---------------                            ----------------------
WIN-N2P19KAHMFG Windows Server 2012 R2 Standard Evaluation 6.3 (9600)
IE10WIN72       Windows 7 Enterprise                       6.1 (7601)
</pre></div>
</div>
</div>
<div class="section" id="moving-adcomputer-object-to-a-specific-ou">
<h3>Moving ADComputer Object to a specific OU<a class="headerlink" href="#moving-adcomputer-object-to-a-specific-ou" title="Permalink to this headline">¶</a></h3>
<p>Let’s say we want to move Windows 7 Machines to the a specific OU ( one we created to have Security baseline for Windows7 )</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>Get-ADComputer -Filter {OperatingSystem -Like &quot;Windows 7*&quot;} | Move-ADObject -TargetPath &quot;OU=Windows7,OU=Security_Baseline,DC=bitvijays,DC=com&quot;
</pre></div>
</div>
<p>This has been explained by Scripting Guys at <a class="reference external" href="https://blogs.technet.microsoft.com/heyscriptingguy/2012/03/01/the-easy-way-to-use-powershell-to-move-computer-accounts/">The Easy Way to Use PowerShell to Move Computer Accounts</a></p>
</div>
</div>
<div class="section" id="windows-security-hardening">
<h2>Windows Security Hardening<a class="headerlink" href="#windows-security-hardening" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">I am not an expert in hardening, this is just an experiment to see, what all we can do.</p>
</div>
<p>At this point, probably, we can work on the hardening of our Domain.</p>
<div class="section" id="security-compliance-manager">
<h3>Security Compliance Manager<a class="headerlink" href="#security-compliance-manager" title="Permalink to this headline">¶</a></h3>
<p>At this point, probably we can setup <a class="reference external" href="https://technet.microsoft.com/en-us/solutionaccelerators/cc835245.aspx">Security Compliance Manager (SCM)</a> on the separate machine. Go thru the baseline for different Windows Operating System. SCM 4.0 provides ready-to-deploy policies based on Microsoft Security Guide recommendations and industry best practices, allowing you to easily manage configuration drift, and address compliance requirements for Windows operating systems and Microsoft applications.</p>
<p>However, SCM is now retired and replaced as mentioned at <a class="reference external" href="https://blogs.technet.microsoft.com/secguide/2017/06/15/security-compliance-manager-scm-retired-new-tools-and-procedures/">Security Compliance Manager (SCM) retired; new tools and procedures</a> which is replaced by <a class="reference external" href="https://www.microsoft.com/en-us/download/details.aspx?id=55319">Security Compliance Toolkit</a> which contains Policy Analyzer and LGPO.</p>
<p>However, coming back to SCM and it’s ability to export the GPO. Let’s see how we can import it in the Group Policy Managment Tool ( Preferrbly using Powershell ) We can do it for almost every OS version. In the below example we would do it for Windows 7.</p>
<p>Now, As we had two OU “Windows 7 SB” and “Windows 10 SB”, by using Group Policy Management Tool, create two GPO Win7SB and Win10SB.</p>
<p>We can get current GPO in the domain by using</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>Get-GPO -All | FT DisplayName

DisplayName
-----------
Default Domain Policy
Win7SB
Default Domain Controllers Policy
Win10SB
</pre></div>
</div>
<p>Let’s create a New-GPO and link it to a OU.</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>New-GPO -Name GlobalSB -Comment &quot;GPO for all the OS&quot;


DisplayName      : GlobalSB
DomainName       : bitvijays.com
Owner            : BITVIJAYS\Domain Admins
Id               : 651e0d7b-ad70-4369-b21e-8a9cde424a04
GpoStatus        : AllSettingsEnabled
Description      : GPO for all the OS
CreationTime     : 8/15/2017 12:37:14 AM
ModificationTime : 8/15/2017 12:37:14 AM
UserVersion      : AD Version: 0, SysVol Version: 0
ComputerVersion  : AD Version: 0, SysVol Version: 0
WmiFilter        :
</pre></div>
</div>
<p>Let’s link it to a OU</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>New-GPLink -Guid 651e0d7b-ad70-4369-b21e-8a9cde424a04 -Target &quot;OU=Security_Baseline,DC=bitvijays,DC=com&quot;

GpoId       : 651e0d7b-ad70-4369-b21e-8a9cde424a04
DisplayName : GlobalSB
Enabled     : True
Enforced    : False
Target      : OU=Security_Baseline,DC=bitvijays,DC=com
Order       : 1
</pre></div>
</div>
<p>Let’s import the SecurityBaseline Settings generated by the SCM ( Creation of GPO Export Folder for Security Baseline is out-of-scope for this document )</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>Import-GPO -BackupId aa23f7c2-c57c-4fc0-82f9-7c12c8787d25 -Path &quot;C:\Users\Administrator\Desktop&quot; -TargetGuid 358bb269-024a-408a-b010-0e54062cbd94

 DisplayName      : Win7SB
 DomainName       : bitvijays.com
 Owner            : BITVIJAYS\Domain Admins
 Id               : 358bb269-024a-408a-b010-0e54062cbd94
 GpoStatus        : UserSettingsDisabled
 Description      :
 CreationTime     : 8/14/2017 8:21:07 AM
 ModificationTime : 8/15/2017 12:51:32 AM
 UserVersion      : AD Version: 2, SysVol Version: 2
 ComputerVersion  : AD Version: 2, SysVol Version: 2
 WmiFilter        :


a23f7c2-c57c-4fc0-82f9-7c12c8787d25 - is the Guid for the exported GPO from SCM.
358bb269-024a-408a-b010-0e54062cbd94 - is the Guid for the Win7SB
</pre></div>
</div>
</div>
<div class="section" id="extra-hardening">
<h3>Extra Hardening<a class="headerlink" href="#extra-hardening" title="Permalink to this headline">¶</a></h3>
<p>Sean Metcalf has written a blog on <a class="reference external" href="https://adsecurity.org/?p=3299">Securing Windows Workstations: Developing a Secure Baseline</a></p>
<div class="section" id="custom-settings">
<h4>Custom Settings<a class="headerlink" href="#custom-settings" title="Permalink to this headline">¶</a></h4>
<p>We can create a custome GPO which includes few custom settings for the below:</p>
<ul class="simple">
<li>Force Group Policy to reapply settings during “refresh” : In SCM, there is a option to Create a setting group and a setting. We can create “Configure scripts policy processing”</li>
<li>Disable LLMNR : Link-Local Multicast Name Resolution (LLMNR) resolves single label names (like: COMPUTER1), on the local subnet, when DNS devolution is unable to resolve the name. This is helpful if you are in an Ad-Hoc network scenario, or in a scenario where DNS entries do not include hosts on the local subnet.LLMNR should be disabled if not used since disabling it removes a method Responder uses for passive credential theft.Group Policy:Computer Configuration/Administrative Templates/Network/DNS Client  Set “Turn Off Multicast Name Resolution” to “Enabled”</li>
<li>Disable NBT-NS</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>Download <a class="reference external" href="http://blog.westmonroepartners.com/wp-content/uploads/2017/04/Set-NetBIOS-node-type-KB160177.zip">Set-NetBIOS-node-type-KB160177.zip</a> which is mentioned at <a class="reference external" href="http://blog.westmonroepartners.com/secure-nbt-ns-poisoning-attacks/">Secure Against NetBIOS Name Service (NBT-NS) Poisoning Attacks with Group Policy</a></li>
<li>Import the ADMX Template by referring <a class="reference external" href="https://msdn.microsoft.com/en-us/library/bb530196.aspx">Managing Group Policy ADMX Files Step-by-Step Guide</a></li>
<li>Set the setting to P-Node type</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="disable-net-session-enumeration-netcease">
<h4>Disable Net Session Enumeration ( NetCease )<a class="headerlink" href="#disable-net-session-enumeration-netcease" title="Permalink to this headline">¶</a></h4>
<p>If the domain contains operating system earlier than Windows 10, We should run <a class="reference external" href="https://gallery.technet.microsoft.com/Net-Cease-Blocking-Net-1e8dcb5b">Net Cease - Hardening Net Session Enumeration</a> powershell script.</p>
<p>It changes the registry key</p>
<p>NetSessionEnum method permissions are controlled by a registry key under the following path:</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>HKEY_LOCAL_MACHINE/SYSTEM/CurrentControlSet/Services/LanmanServer/DefaultSecurity/SrvsvcSessionInfo
</pre></div>
</div>
<div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p class="last">Need to figure out, how to run a script on all workstations ?</p>
</div>
<p>By default Windows 10, doesn’t allow authenticated users to enumerate sessions.</p>
</div>
<div class="section" id="local-administrator-password-solution-laps">
<h4>Local Administrator Password Solution LAPS<a class="headerlink" href="#local-administrator-password-solution-laps" title="Permalink to this headline">¶</a></h4>
<p>Microsoft has provided a <a class="reference external" href="https://www.microsoft.com/en-us/download/details.aspx?id=46899">Local Administrator Password Solution</a> which provides management of local account passwords of domain joined computers. Passwords are stored in Active Directory (AD) and protected by ACL, so only eligible users can read it or request its reset. Details on how to deploy can be found in Operations Guide and Technical Specification.</p>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="index.html">tech.bitvijays.com</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Vijay Kumar.
    </div>
  </body>
</html>