

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-92365403-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <title>Remote Function Calls (RFC), SAP GUI, and the DIAG Protocol &#8212; tech.bitvijays.com</title>
    <link rel="stylesheet" href="_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/bizstyle.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="index.html">tech.bitvijays.com</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Remote Function Calls (RFC), SAP GUI, and the DIAG Protocol</a></li>
<li><a class="reference internal" href="#the-sap-internet-communication-manager-icm">The SAP Internet Communication Manager (ICM)</a><ul>
<li><a class="reference internal" href="#exploring-sap">Exploring SAP</a></li>
</ul>
</li>
<li><a class="reference internal" href="#enumerate-sap-systems">Enumerate SAP Systems</a></li>
<li><a class="reference internal" href="#the-sap-internet-communication-framework-icf">The SAP Internet Communication Framework (ICF)</a></li>
<li><a class="reference internal" href="#discovering-icf-services-with-metasploit">Discovering ICF Services with Metasploit</a></li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/LFF-IPS-P99-SAP-Pentesting.rst.txt"
           rel="nofollow">Show Source</a></li>
    <li><a href="https://github.com/bitvijays/bitvijays.github.io-sphinx/blob/master/docs/LFF-IPS-P99-SAP-Pentesting.rst"
           rel="nofollow">Show on GitHub</a></li>
    <li><a href="https://github.com/bitvijays/bitvijays.github.io-sphinx/edit/master/docs/LFF-IPS-P99-SAP-Pentesting.rst"
           rel="nofollow">Edit on GitHub</a></li>
  </ul>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <p>SAP is the ERP provider of choice for many companies, all of which entrust their most confidential data to the SAP systems. Systems covered by SAP include:</p>
<ul class="simple">
<li>Enterprise Resource Planning (ERP) - supports the basic internal business processes of a company</li>
<li>Customer Relationship Management (CRM) – helps companies acquire and retain customers, gain marketing and customer insight</li>
<li>Product Lifecycle Management (PLM) – helps manufacturers with product-related information</li>
<li>Supply Chain Management (SCM) – helps companies with the process of resourcing its manufacturing and service processes</li>
<li>Supplier Relationship Management (SRM) – enables companies to procure from suppliers</li>
</ul>
<blockquote>
<div>There are two ways an external user can communicate with the SAP platform:</div></blockquote>
<ol class="arabic simple">
<li>The SAP GUI</li>
<li>A browser through the ICM</li>
</ol>
<div class="section" id="remote-function-calls-rfc-sap-gui-and-the-diag-protocol">
<h1>Remote Function Calls (RFC), SAP GUI, and the DIAG Protocol<a class="headerlink" href="#remote-function-calls-rfc-sap-gui-and-the-diag-protocol" title="Permalink to this headline">¶</a></h1>
<p>Remote Function Calls (RFC) is the traditional mechanism provided by SAP to call or invoke ABAP code (programs or function
modules) or even other types of code, and to launch other programs within an SAP platform.
A list of available RFC connections on an SAP system can be obtained using the transaction SM59.</p>
<p>The SAP GUI will communicate with the SAP platform using the SAP GUI RFC via a network protocol named DIAG (from dialog)
in order to run ABAP applications through the named transactions</p>
</div>
<div class="section" id="the-sap-internet-communication-manager-icm">
<h1>The SAP Internet Communication Manager (ICM)<a class="headerlink" href="#the-sap-internet-communication-manager-icm" title="Permalink to this headline">¶</a></h1>
<p>There is an easier way to communicate with an SAP system than the obscure DIAG/SAP GUI method. The SAP Internet
Communication Manager (ICM), according to the SAP documentation, is used to provide communication with the outside world
using Internet protocols such as HTTP, HTTPS, and SMTP, allowing communication with the application server (running both
Java and ABAP programs) without the need for SAP GUI and DIAG:</p>
<p>Indeed, it is the ICM component that provides these Internet services, which can be monitored with the SMICM transaction:</p>
<div class="section" id="exploring-sap">
<h2>Exploring SAP<a class="headerlink" href="#exploring-sap" title="Permalink to this headline">¶</a></h2>
</div>
</div>
<div class="section" id="enumerate-sap-systems">
<h1>Enumerate SAP Systems<a class="headerlink" href="#enumerate-sap-systems" title="Permalink to this headline">¶</a></h1>
<p>discover and/or enumerate SAP components within a network.</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>msf auxiliary(scanner/sap/sap_service_discovery) &gt; set rhosts 172.20.1.20
rhosts =&gt; 172.20.1.20
msf auxiliary(scanner/sap/sap_service_discovery) &gt; run

[*] 172.20.1.20:          - [SAP] Beginning service Discovery &#39;172.20.1.20&#39;

[+] 172.20.1.20:          - 172.20.1.20:3200    - SAP Dispatcher sapdp00 OPEN
[+] 172.20.1.20:          - 172.20.1.20:3201    - SAP Dispatcher sapdp01 OPEN
[+] 172.20.1.20:          - 172.20.1.20:3300    - SAP Gateway sapgw00 OPEN
[+] 172.20.1.20:          - 172.20.1.20:8000    - SAP ICM HTTP OPEN
[+] 172.20.1.25:          - 172.20.1.25:3600    - SAP Message Server sapms&lt;SID&gt;00 OPEN
[+] 172.20.1.25:          - 172.20.1.25:8001    - SAP ICM HTTP OPEN
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
</pre></div>
</div>
<p>Let’s explore</p>
</div>
<div class="section" id="the-sap-internet-communication-framework-icf">
<h1>The SAP Internet Communication Framework (ICF)<a class="headerlink" href="#the-sap-internet-communication-framework-icf" title="Permalink to this headline">¶</a></h1>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>use  scanner/sap/sap_icf_public_info

[SAP] ICF SAP PUBLIC INFO
=========================

  Key                                   Value
  ---                                   -----
  Central Database System:              ORACLE
  Character Set:                        4102
  Database Host:                        SAPDEV
  Float Type Format:                    IEEE
  Hostname:                             SAPDEV
  IPv4 Address:                         172.20.1.19
  IPv6 Address:                         172.20.1.19
  Integer Format:                       Big Endian
  Kernel Release:                       745
  Machine ID:                           274
  Operating System:                     HP-UX
  RFC Destination:                      SAPDEV_DEV_00
  RFC Log Version:                      011
  Release Status of SAP System:         740
  System ID:                            DEV
  Timezone (diff from UTC in seconds):   19800


[SAP] ICF SAP PUBLIC INFO
=========================

  Key                                   Value
  ---                                   -----
  Central Database System:              ORACLE
  Character Set:                        4102
  Database Host:                        SAPQAS
  Float Type Format:                    IEEE
  Hostname:                             SAPQAS
  IPv4 Address:                         172.20.1.20
  IPv6 Address:                         172.20.1.20
  Integer Format:                       Big Endian
  Kernel Release:                       745
  Machine ID:                           274
  Operating System:                     HP-UX
  RFC Destination:                      SAPQAS_QAS_00
  RFC Log Version:                      011
  Release Status of SAP System:         740
  System ID:                            QAS
  Timezone (diff from UTC in seconds):   19800

[SAP] ICF SAP PUBLIC INFO
=========================

  Key                                   Value
  ---                                   -----
  Central Database System:              ORACLE
  Character Set:                        4102
  Database Host:                        PRDDB
  Float Type Format:                    IEEE
  Hostname:                             sapprdc
  IPv4 Address:                         172.20.1.25
  IPv6 Address:                         172.20.1.25
  Integer Format:                       Big Endian
  Kernel Release:                       745
  Machine ID:                           274
  Operating System:                     HP-UX
  RFC Destination:                      sapprdc_PRD_01
  RFC Log Version:                      011
  Release Status of SAP System:         740
  System ID:                            PRD
  Timezone (diff from UTC in seconds):   19800

[SAP] ICF SAP PUBLIC INFO
=========================

  Key                                   Value
  ---                                   -----
  Central Database System:              MSSQL
  Character Set:                        4103
  Database Host:                        XXXNWPRD2\MI2
  Float Type Format:                    IEEE
  Hostname:                             xxxnwprd
  IPv4 Address:                         172.20.1.54
  IPv6 Address:                         172.20.1.54
  Integer Format:                       Little Endian
  Kernel Release:                       710
  Machine ID:                           562
  Operating System:                     Windows NT
  RFC Destination:                      xxxnwprd2_MI2_02
  RFC Log Version:                      011
  Release Status of SAP System:         710
  System ID:                            MI2
  Timezone (diff from UTC in seconds):   19800

[*] Scanned 4 of 4 hosts (100% complete)
[*] Auxiliary module execution completed
</pre></div>
</div>
<p>Under the hood, it’s just SOAP over HTTP, which is the common mechanism when communicating with services provided by the ICF:</p>
<div class="highlight-None notranslate"><div class="highlight"><pre><span></span>http://172.20.1.54:8001/sap/public/info

This XML file does not appear to have any style information associated with it. The document tree is shown below.
&lt;SOAP-ENV:Envelope xmlns:SOAP-ENV=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot;&gt;
&lt;SOAP-ENV:Body&gt;
&lt;rfc:RFC_SYSTEM_INFO.Response xmlns:rfc=&quot;urn:sap-com:document:sap:rfc:functions&quot;&gt;
&lt;RFCSI&gt;
&lt;RFCPROTO&gt;011&lt;/RFCPROTO&gt;
&lt;RFCCHARTYP&gt;4103&lt;/RFCCHARTYP&gt;
&lt;RFCINTTYP&gt;LIT&lt;/RFCINTTYP&gt;
&lt;RFCFLOTYP&gt;IE3&lt;/RFCFLOTYP&gt;
&lt;RFCDEST&gt;pclnwprd2_MI2_02&lt;/RFCDEST&gt;
&lt;RFCHOST&gt;pclnwprd&lt;/RFCHOST&gt;
&lt;RFCSYSID&gt;MI2&lt;/RFCSYSID&gt;
&lt;RFCDATABS&gt;MI2&lt;/RFCDATABS&gt;
&lt;RFCDBHOST&gt;PCLNWPRD2\MI2&lt;/RFCDBHOST&gt;
&lt;RFCDBSYS&gt;MSSQL&lt;/RFCDBSYS&gt;
&lt;RFCSAPRL&gt;710&lt;/RFCSAPRL&gt;
&lt;RFCMACH&gt;562&lt;/RFCMACH&gt;
&lt;RFCOPSYS&gt;Windows NT&lt;/RFCOPSYS&gt;
&lt;RFCTZONE&gt;19800&lt;/RFCTZONE&gt;
&lt;RFCDAYST/&gt;
&lt;RFCIPADDR&gt;172.20.1.54&lt;/RFCIPADDR&gt;
&lt;RFCKERNRL&gt;710&lt;/RFCKERNRL&gt;
&lt;RFCHOST2&gt;pclnwprd2&lt;/RFCHOST2&gt;
&lt;RFCSI_RESV/&gt;
&lt;RFCIPV6ADDR&gt;172.20.1.54&lt;/RFCIPV6ADDR&gt;
&lt;/RFCSI&gt;
&lt;/rfc:RFC_SYSTEM_INFO.Response&gt;
&lt;/SOAP-ENV:Body&gt;
&lt;/SOAP-ENV:Envelope&gt;
</pre></div>
</div>
</div>
<div class="section" id="discovering-icf-services-with-metasploit">
<h1>Discovering ICF Services with Metasploit<a class="headerlink" href="#discovering-icf-services-with-metasploit" title="Permalink to this headline">¶</a></h1>
<p>To get a full list of available services, the SICF transaction can be used:</p>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="index.html">tech.bitvijays.com</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Vijay Kumar.
    </div>
  </body>
</html>